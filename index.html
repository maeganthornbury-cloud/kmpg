<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kentucky Mirror and Plate Glass - New Order</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; text-transform: uppercase; }
    h1 { text-align: center; }
    .container { display: flex; }
    .section { width: 50%; padding: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 12px; text-align: center; }
    input, select { width: 90%; }
    input, select, textarea, button { text-transform: uppercase; }
    .buttons { margin-top: 15px; }

.glassList li.active {
  background-color: #cce5ff;
}
    .glassTypeInput {
      width: 100%;
      max-width: 750px;
      height: 12px;
      font-size: 16px;
      padding: 1px;
    }

    .glassList {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
      list-style: none;
      padding: 0;
      margin-top: 2px;
      display: none;
      z-index: 1000;
    }
    .glassList li {
      padding: 15px;
      cursor: pointer;
      font-size: 12px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
    }
    .glassList li:hover { background-color: #eee; }
    .dropdown-container { position: relative; }

    .special-pricing-toggle {
      text-align: left;
      margin-bottom: 10px;
    }
    .special-pricing-toggle label {
      display: flex;
      align-items: left;
      font-size: 12px;
    }
    .special-pricing-toggle input[type="checkbox"] {
      margin-left: 1px;
    }

    .buttons button {
      padding: 10px 18px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      background-color: lightgrey;
      color: black;
      border: none;
      cursor: pointer;
      margin-right: 5px;
    }

    a {
      text-decoration: none;
      color: white;
    }

    #top-link-box {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #007BFF;
      padding: 10px 15px;
      border-radius: 8px;
      z-index: 9999;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    #top-link-box-a {
      position: fixed;
      top: 70px;
      right: 20px;
      background-color: #007BFF;
      padding: 10px 15px;
      border-radius: 8px;
      z-index: 9999;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    #top-link-box-b {
      position: fixed;
      top: 20px;
      right: 200px;
      background-color: #007BFF;
      padding: 10px 15px;
      border-radius: 8px;
      z-index: 9999;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .icon-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      padding: 6px;
      border-radius: 6px;
    }
    .icon-btn:hover { background: #f3f3f3; }
    .delete-cell { width: 40px; }

    /* Customer Management Styles */
    #customer-section {
      display: none;
      max-width: 1000px;
      margin: 0 auto;
    }
    #customer-section.active { display: block; }
    #calculator-section.hidden { display: none; }

    .tab-bar {
      display: flex;
      gap: 0;
      margin-bottom: 20px;
      border-bottom: 2px solid #007BFF;
    }
    .tab-bar button {
      padding: 10px 24px;
      font-size: 16px;
      font-weight: bold;
      border: 2px solid #007BFF;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      background: #f0f0f0;
      cursor: pointer;
      color: #333;
    }
    .tab-bar button.active {
      background: #007BFF;
      color: white;
    }

    #customerForm {
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    #customerForm label {
      display: block;
      font-weight: bold;
      margin-top: 10px;
      margin-bottom: 3px;
      font-size: 14px;
    }
    #customerForm input, #customerForm select {
      width: 100%;
      max-width: 400px;
      padding: 6px 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #customerForm .form-actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }
    #customerForm .form-actions button {
      padding: 8px 18px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    #customerForm .form-actions .btn-save {
      background: #007BFF;
      color: white;
    }
    #customerForm .form-actions .btn-cancel {
      background: lightgrey;
      color: black;
    }

    #customerTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    #customerTable th, #customerTable td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
      font-size: 13px;
    }
    #customerTable th {
      background: #007BFF;
      color: white;
    }
    #customerTable tr:nth-child(even) { background: #f2f2f2; }
    #customerTable .actions-cell { white-space: nowrap; }
    #customerTable .actions-cell button {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      margin-right: 4px;
    }
    .btn-edit { background: #ffc107; color: black; }
    .btn-delete { background: #dc3545; color: white; }
    .btn-add-customer {
      padding: 10px 18px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      margin-bottom: 15px;
    }
    #customerSearch {
      padding: 6px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 300px;
      margin-bottom: 15px;
      margin-left: 15px;
    }

    /* Customer autocomplete in calculator */
    .customer-lookup-container {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .customer-lookup-list {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
      list-style: none;
      padding: 0;
      margin-top: 2px;
      display: none;
      z-index: 1000;
      width: 100%;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .customer-lookup-list li {
      padding: 8px 10px;
      cursor: pointer;
      font-size: 13px;
      border-bottom: 1px solid #eee;
    }
    .customer-lookup-list li:hover,
    .customer-lookup-list li.active {
      background-color: #cce5ff;
    }
    .customer-lookup-list li.add-new-customer {
      color: #28a745;
      font-weight: bold;
      font-style: italic;
    }
    .customer-lookup-list li .cust-detail {
      font-size: 11px;
      color: #666;
      display: block;
    }
    .customer-info-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      max-width: 750px;
      flex-wrap: wrap;
    }
    .customer-info-row .info-field {
      flex: 1;
      min-width: 140px;
    }
    .customer-info-row label {
      display: block;
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 3px;
    }
    .customer-info-row input {
      width: 100%;
      padding: 5px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .customer-info-row input[readonly] {
      background: #f0f0f0;
      color: #555;
    }
    #clearCustomerBtn {
      padding: 5px 12px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #f8f8f8;
      cursor: pointer;
      margin-left: 5px;
      vertical-align: bottom;
    }
    #clearCustomerBtn:hover {
      background: #e0e0e0;
    }
    /* Import Upload Styles */
    .btn-upload-customer {
      padding: 10px 18px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      background-color: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
      margin-bottom: 15px;
      margin-left: 10px;
    }
    .import-modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .import-modal {
      background: white;
      padding: 24px;
      border-radius: 10px;
      width: 800px;
      max-width: 95%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .import-modal h3 { margin-top: 0; }
    .import-modal .column-mapping {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
      padding: 12px;
      background: #f0f8ff;
      border-radius: 6px;
      border: 1px solid #b3d7ff;
    }
    .import-modal .column-mapping label {
      font-size: 13px;
      font-weight: bold;
      display: block;
      margin-bottom: 3px;
    }
    .import-modal .column-mapping select {
      padding: 4px 6px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-width: 120px;
    }
    .import-preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-bottom: 15px;
    }
    .import-preview-table th, .import-preview-table td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: left;
    }
    .import-preview-table th {
      background: #007BFF;
      color: white;
    }
    .import-preview-table tr:nth-child(even) { background: #f2f2f2; }
    .import-preview-table tr.skip-row { opacity: 0.4; text-decoration: line-through; }
    .import-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .import-actions button {
      padding: 8px 18px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .import-actions .btn-import-confirm {
      background: #28a745;
      color: white;
    }
    .import-actions .btn-import-cancel {
      background: lightgrey;
      color: black;
    }
    .import-status {
      margin-left: 10px;
      font-size: 14px;
    }
    .import-status.success { color: #28a745; font-weight: bold; }
    .import-status.error { color: #dc3545; font-weight: bold; }

    /* Order number display */
    .order-number-bar {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
      padding: 10px 15px;
      background: #e8f4fd;
      border: 1px solid #b3d7ff;
      border-radius: 8px;
    }
    .order-number-bar .order-num {
      font-size: 20px;
      font-weight: bold;
      color: #007BFF;
    }
    .order-number-bar .order-label {
      font-size: 14px;
      color: #555;
    }
    .btn-save-order {
      padding: 10px 18px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      margin-right: 5px;
    }
    .btn-save-order:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    .btn-new-order {
      padding: 10px 18px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      background-color: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
    }

    /* Orders section */
    #orders-section {
      display: none;
      max-width: 1100px;
      margin: 0 auto;
    }
    #orders-section.active { display: block; }
    #shower-section {
      display: none;
      max-width: 1100px;
      margin: 0 auto;
    }
    #shower-section.active { display: block; }
    .shower-layout {
      display: grid;
      grid-template-columns: minmax(320px, 420px) 1fr;
      gap: 20px;
      align-items: start;
    }
    .shower-card {
      border: 1px solid #d7d7d7;
      border-radius: 10px;
      background: #fafafa;
      padding: 14px;
    }
    .shower-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .shower-grid label { font-size: 12px; font-weight: bold; }
    .shower-grid input, .shower-grid select { width: 100%; box-sizing: border-box; }
    #showerPreview {
      width: 100%;
      max-width: 640px;
      border: 1px solid #d7d7d7;
      border-radius: 10px;
      background: #fff;
    }
    .shower-stats {
      margin-top: 10px;
      font-size: 13px;
      line-height: 1.5;
    }
    @media (max-width: 900px) {
      .shower-layout { grid-template-columns: 1fr; }
    }
    #orderSearch {
      padding: 6px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 350px;
      margin-bottom: 15px;
    }
    #orderTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    #orderTable th, #orderTable td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
      font-size: 13px;
    }
    #orderTable th {
      background: #007BFF;
      color: white;
    }
    #orderTable tr:nth-child(even) { background: #f2f2f2; }
    #orderTable tr { cursor: pointer; }
    #orderTable tr:hover { background: #cce5ff; }
    #orderTable .actions-cell button {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      margin-right: 4px;
    }

    /* Order detail modal */
    .order-detail-modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .order-detail-modal {
      background: white;
      padding: 24px;
      border-radius: 10px;
      width: 800px;
      max-width: 95%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .order-detail-modal h3 { margin-top: 0; }
    .order-detail-modal table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    .order-detail-modal table th,
    .order-detail-modal table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      font-size: 13px;
    }
    .order-detail-modal table th {
      background: #007BFF;
      color: white;
    }
    .order-detail-info {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    .order-detail-info div {
      min-width: 180px;
    }
    .order-detail-info strong {
      display: block;
      font-size: 12px;
      color: #666;
      margin-bottom: 2px;
    }
  
/* ===== KY MPG Modern Shell (SPA) ===== */
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --line:#e5e7eb;
  --accent:#4f6fad;
  --accentSoft: rgba(79,111,173,.12);
  --shadow: 0 10px 30px rgba(2, 6, 23, .10);
  --shadow2: 0 6px 16px rgba(2, 6, 23, .08);
  --radius: 16px;
  --radius2: 12px;
  --sideW: 272px;
  --sideWCollapsed: 76px;
}
.kympg-cardHeader { display: none !important; }
html, body { height: 100%; }
body{
  margin:0 !important;
  background:
    radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.9), rgba(255,255,255,0) 55%),
    radial-gradient(900px 700px at 85% 20%, rgba(255,255,255,.8), rgba(255,255,255,0) 60%),
    linear-gradient(135deg, rgba(255,255,255,.55) 25%, transparent 25%) -20px 0/40px 40px,
    linear-gradient(225deg, rgba(255,255,255,.55) 25%, transparent 25%) -20px 0/40px 40px,
    linear-gradient(315deg, rgba(255,255,255,.55) 25%, transparent 25%) 0px 0/40px 40px,
    linear-gradient(45deg, rgba(255,255,255,.55) 25%, var(--bg) 25%) 0px 0/40px 40px !important;
  color: var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif !important;
}

/* Hide old navigation/headers (visual only) */
#top-link-box, #top-link-box-a, #top-link-box-b, .tab-bar { display:none !important; }

/* Shell layout */
.kympg-shell{ display:flex; min-height:100vh; }

/* Light sidebar */
.kympg-sidebar{
  width: var(--sideW);
  background:#fff;
  border-right:1px solid var(--line);
  padding:16px 14px;
  display:flex;
  flex-direction:column;
  gap:14px;
  position: sticky;
  top:0;
  height:100vh;
  transition: width .22s ease;
  z-index: 50;
  overflow-y: auto;
}
.kympg-sidebar.collapsed{ width: var(--sideWCollapsed); }
.kympg-sidebar::-webkit-scrollbar{ width:10px; }
.kympg-sidebar::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:999px; }
.kympg-topActions{ display:flex; justify-content:flex-end; padding:0 6px; }

.kympg-toggleBtn{
  border:none;
  background: rgba(15,23,42,.05);
  color: #0f172a;
  height: 40px;
  width: 40px;
  border-radius: 12px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow: inset 0 0 0 1px rgba(15,23,42,.06);
}
.kympg-toggleBtn:hover{ background: rgba(15,23,42,.08); }

.kympg-brand{
  padding:10px 10px;
  border-radius:14px;
  background: rgba(79,111,173,.08);
  box-shadow: inset 0 0 0 1px rgba(79,111,173,.18);
  cursor:pointer;
}
.kympg-brand .name{ font-weight: 900; font-size: 14px; letter-spacing:.2px; }
.kympg-brand .sub{ font-size: 12px; color: rgba(15,23,42,.70); margin-top:2px; }
.kympg-sidebar.collapsed .kympg-brand .sub{ display:none; }
.kympg-sidebar.collapsed .kympg-brand{ text-align:center; }

.kympg-navGroup{ display:flex; flex-direction:column; gap:6px; }
.kympg-sectionLabel{
  font-size: 18px;
  font-weight: 900;
  letter-spacing:.04em;
  text-transform: uppercase;
  color: rgba(15,23,42,.72);
  padding: 6px 10px 0 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  cursor:pointer;
}
.kympg-sectionLabel .toggleMark{ font-size:20px; font-weight:900; min-width:18px; text-align:right; }
.kympg-sidebar.collapsed .kympg-sectionLabel{ display:none; }
.kympg-nav{ display:flex; flex-direction:column; gap:6px; }
.kympg-navGroup.collapsed .kympg-nav{ display:none; }
.kympg-navBtn{
  width:100%;
  border:none;
  background: transparent;
  color:#0f172a;
  border-radius: 14px;
  padding: 10px 10px;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:12px;
  transition: background .15s ease, transform .05s ease;
  position: relative;
}
.kympg-navBtn:hover{ background: rgba(15,23,42,.06); }
.kympg-navBtn:active{ transform: translateY(1px); }
.kympg-navBtn.active{
  background: rgba(79,111,173,.12);
  box-shadow: inset 0 0 0 1px rgba(79,111,173,.25);
}
.kympg-ico{ width:22px; height:22px; display:inline-flex; align-items:center; justify-content:center; flex:0 0 auto; }
.kympg-ico svg{ width:22px; height:22px; fill:none; stroke:#334155; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
.kympg-label{ font-weight: 800; font-size: 14px; letter-spacing:.1px; }
.kympg-hint{ display:block; font-weight:600; font-size:12px; color: rgba(15,23,42,.55); margin-top:2px; }
.kympg-labelWrap{ display:block; }

.kympg-sidebar.collapsed .kympg-navBtn{ justify-content:center; padding: 12px 10px; }
.kympg-sidebar.collapsed .kympg-labelWrap{ display:none; }
.kympg-sidebar.collapsed .kympg-navBtn[data-tip]:hover::after{
  content: attr(data-tip);
  position:absolute;
  left: calc(100% + 10px);
  top: 50%;
  transform: translateY(-50%);
  white-space: nowrap;
  background: rgba(15,23,42,.92);
  color:#fff;
  padding: 8px 10px;
  border-radius: 10px;
  font-size: 12px;
  box-shadow: var(--shadow2);
  z-index: 9999;
}

.kympg-spacer{ flex:1; }

/* Main */
.kympg-main{ flex:1; padding:22px; min-width:0; }
.kympg-shellInner{ max-width: 1400px; margin:0 auto; display:flex; flex-direction:column; gap:14px; }

.kympg-topBar{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.kympg-authBox{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
.kympg-authMeta{ font-size:12px; color:#334155; font-weight:700; }
.kympg-authBtn{ padding:8px 12px; border:none; border-radius:8px; cursor:pointer; font-weight:700; }
.kympg-authBtn.primary{ background:#0d78f0; color:#fff; }
.kympg-authBtn.secondary{ background:#e2e8f0; color:#0f172a; }
.kympg-authBtn.success{ background:#198f42; color:#fff; }
.kympg-hidden-by-role{ display:none !important; }

.auth-gate{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:rgba(15,23,42,.76); z-index:10; padding:20px;
}
.auth-gate-card{
  width:min(420px, 94vw);
  background:#fff;
  border-radius:14px;
  box-shadow:0 20px 55px rgba(2,6,23,.35);
  padding:22px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.auth-gate-card h2{ margin:0; font-size:24px; }
.auth-gate-card p{ margin:0; color:#475569; font-size:14px; }
.auth-gate-card input{
  width:100%;
  padding:10px 12px;
  border:1px solid #cbd5e1;
  border-radius:8px;
  font-size:14px;
  text-transform:none;
}
.auth-gate-card .row{ display:flex; gap:8px; flex-wrap:wrap; }
.auth-gate-error{ color:#b91c1c; font-size:13px; min-height:18px; }
body.auth-locked .kympg-shell{ display:none; }
body.auth-locked .auth-gate{ display:flex; }

.admin-user-modal{
  position: fixed;
  inset: 0;
  background: rgba(2, 6, 23, .55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 21000;
}
.admin-user-modal.active{ display:flex; }
.admin-user-card{
  width: min(520px, 95vw);
  background:#fff;
  border-radius:12px;
  box-shadow: var(--shadow);
  border:1px solid var(--line);
  padding:16px;
}
.admin-user-card h3{ margin:0 0 10px 0; }
.admin-user-card label{ display:block; font-size:12px; font-weight:700; margin:8px 0 4px; }
.admin-user-card input{ width:100%; padding:8px 10px; border:1px solid #cbd5e1; border-radius:8px; text-transform:none; }
.admin-user-card .roleChecks{ display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; }
.admin-user-card .roleChecks label{ margin:0; display:flex; align-items:center; gap:4px; }
.admin-user-actions{ margin-top:12px; display:flex; gap:8px; justify-content:flex-end; }
.admin-user-status{ margin-top:8px; min-height:18px; font-size:12px; color:#334155; }

.kympg-pageTitle h1{ margin:0; font-size: 22px; letter-spacing:.2px; }
.kympg-pageTitle p{ margin:0; color: var(--muted); font-size: 13px; }

.kympg-pill{
  background: var(--card);
  border:1px solid var(--line);
  border-radius:999px;
  padding:10px 12px;
  display:flex;
  align-items:center;
  gap:10px;
  box-shadow: var(--shadow2);
}
.kympg-pill .dot{ width:10px; height:10px; border-radius:999px; background:#22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.18); }
.kympg-pill span{ color: var(--muted); font-size: 13px; }

.kympg-card{
  background: var(--card);
  border:1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow:hidden;
}
.kympg-cardHeader{
  padding:16px 18px;
  border-bottom:1px solid var(--line);
}
.kympg-cardHeader .h{ font-weight: 900; font-size: 16px; margin:0; }
.kympg-cardHeader .sub{ color: var(--muted); font-size: 13px; margin-top:2px; }
.kympg-cardBody{ padding:18px; }

/* Home */
#landing-section{ display:none; }
#landing-section.active{ display:block; }
.kympg-landingWrap{
  display:flex; flex-direction:column; align-items:center;
  gap:14px; text-align:center;
}
.kympg-landingLogo{ width:min(560px, 92%); display:flex; justify-content:center; }
.kympg-landingLogo img{ max-width:100%; height:auto; border-radius:18px; box-shadow:0 14px 40px rgba(2,6,23,.12); }
.kympg-landingTitle{ font-weight: 950; font-size: 26px; letter-spacing:.2px; }
.kympg-landingSub{ color: var(--muted); font-size: 14px; line-height:1.55; max-width: 760px; }
.kympg-quickSearch{
  margin-top: 12px;
  width:min(860px, 96%);
  background:#fff;
  border:1px solid var(--line);
  border-radius:14px;
  padding:14px;
  box-shadow: var(--shadow2);
  text-align:left;
}
.kympg-quickSearch h3{ margin:0 0 8px 0; font-size:16px; }
.kympg-quickSearch .row{ display:flex; gap:8px; align-items:center; }
.kympg-quickSearch input{ width:100%; flex:1; padding:10px 12px; font-size:14px; border:1px solid #cfd4dc; border-radius:8px; }
.kympg-quickSearch button{ width:auto; padding:10px 18px; border:none; border-radius:10px; background:#0d78f0; color:#fff; font-weight:700; cursor:pointer; }
.kympg-quickResults{ margin-top:10px; max-height:220px; overflow:auto; border-top:1px solid #eef1f4; }
.kympg-quickItem{ position:relative; padding:10px 4px; border-bottom:1px solid #f0f2f5; cursor:pointer; }
.kympg-quickItem:hover{ background:#f7fbff; }
.kympg-quickMeta{ color:#666; font-size:12px; }
.kympg-quickPreview{ display:none; position:absolute; left:8px; right:8px; top:calc(100% - 4px); background:#fff; border:1px solid #d7dee6; border-radius:10px; box-shadow:0 8px 24px rgba(2,6,23,.18); z-index:20; padding:10px; }
.kympg-quickItem:hover .kympg-quickPreview{ display:block; }
.kympg-quickPreviewTitle{ font-weight:700; font-size:12px; margin-bottom:6px; color:#1f2937; }
.kympg-quickPreviewLine{ font-size:12px; color:#374151; padding:2px 0; }

.kympg-logPO{
  margin-top: 12px;
  width:min(860px, 96%);
  background:#fff;
  border:1px solid var(--line);
  border-radius:14px;
  padding:14px;
  box-shadow: var(--shadow2);
  text-align:left;
}
.kympg-logPO h3{ margin:0 0 8px 0; font-size:16px; }
.kympg-logPO .row{ display:flex; gap:8px; align-items:center; }
.kympg-logPO input{ width:100%; flex:1; padding:10px 12px; font-size:14px; border:1px solid #cfd4dc; border-radius:8px; }
.kympg-logPO button{ width:auto; padding:10px 18px; border:none; border-radius:10px; background:#198f42; color:#fff; font-weight:700; cursor:pointer; }
.kympg-logPOStatus{ margin-top:8px; font-size:13px; color:#444; }

.tech-home-wrap{
  margin-top:12px;
  width:min(1100px, 98%);
  background:#fff;
  border:1px solid var(--line);
  border-radius:14px;
  padding:14px;
  box-shadow: var(--shadow2);
  text-align:left;
}
.tech-home-wrap h3{ margin:0 0 8px 0; font-size:16px; }
.tech-home-wrap table{ width:100%; border-collapse:collapse; }
.tech-home-wrap th,.tech-home-wrap td{ border:1px solid #d8dee8; padding:8px; font-size:12px; text-align:left; }
.tech-home-wrap th{ background:#f1f5f9; }
.measure-modal{ position:fixed; inset:0; background:rgba(2,6,23,.55); display:none; align-items:center; justify-content:center; z-index:20000; }
.measure-card{ width:min(620px, 95vw); background:#fff; border-radius:12px; padding:16px; }
.measure-card h3{ margin:0 0 8px 0; }
.measure-grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px 12px; margin-bottom:12px; }
.measure-grid .full{ grid-column:1 / -1; }
.measure-card label{ display:block; font-size:12px; font-weight:700; margin-bottom:4px; }
.measure-card input,.measure-card select,.measure-card textarea{ width:100%; text-transform:none; }
.measure-actions{ display:flex; gap:8px; justify-content:flex-end; }

.kympg-iframeWrap{ border:1px solid var(--line); border-radius: var(--radius2); overflow:hidden; height:min(72vh, 860px); background:#fff; }
.kympg-iframeWrap iframe{ width:100%; height:100%; border:none; }

/* Put legacy sections inside card nicely */
#calculator-section, #customer-section, #orders-section{ max-width: none !important; }

</style>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>

<div id="authGate" class="auth-gate" aria-hidden="true">
  <div class="auth-gate-card" onclick="event.stopPropagation()">
    <h2>Log In</h2>
    <p>Sign in with Netlify Identity to access the app.</p>
    <div class="row">
      <button type="button" class="kympg-authBtn primary" onclick="openLogin()">Use Netlify Login</button>
    </div>
  </div>
</div>

<div class="kympg-shell">
  <aside class="kympg-sidebar" id="kympgSidebar">
    <div class="kympg-topActions">
      <button class="kympg-toggleBtn" type="button" title="Collapse / expand" onclick="kympgToggleSidebar()">
        <span class="kympg-ico" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg>
        </span>
      </button>
    </div>

    <div class="kympg-brand" id="kympgHomeLink" onclick="kympgShowLanding()">
      <div class="name">Kentucky Mirror</div>
      <div class="sub">Home</div>
    </div>

    <div class="kympg-navGroup" id="group-work">
    <div class="kympg-sectionLabel" onclick="kympgToggleGroup('work')">Work <span class="toggleMark" id="toggle-work">−</span></div>
    <nav class="kympg-nav">
      <button class="kympg-navBtn" data-tip="New Quote" type="button" onclick="kympgOpen('quote', this)">
        <span class="kympg-ico" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M8 13h8"/><path d="M8 17h6"/></svg>
        </span>
        <span class="kympg-labelWrap">
          <span class="kympg-label">New Quote</span>
          <span class="kympg-hint">Create a new quote</span>
        </span>
      </button>

      <button class="kympg-navBtn" data-tip="New Order" type="button" onclick="kympgOpen('order', this)">
        <span class="kympg-ico" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73L13 2.27a2 2 0 0 0-2 0L4 6.27A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><path d="M3.27 6.96 12 12l8.73-5.04"/><path d="M12 22V12"/></svg>
        </span>
        <span class="kympg-labelWrap">
          <span class="kympg-label">New Order</span>
          <span class="kympg-hint">Start an order</span>
        </span>
      </button>

      <button class="kympg-navBtn" data-tip="Search / Open Orders" type="button" onclick="kympgOpen('orders', this)">
        <span class="kympg-ico" aria-hidden="true">
          <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/></svg>
        </span>
        <span class="kympg-labelWrap">
          <span class="kympg-label">Search / Open Orders</span>
          <span class="kympg-hint">Find past orders</span>
        </span>
      </button>

      <button class="kympg-navBtn" data-tip="Open Quotes" type="button" onclick="kympgOpen('quotedb', this)">
        <span class="kympg-ico" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M7 7h10"/><path d="M7 11h10"/><path d="M7 15h6"/><path d="M6 3h12a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/></svg>
        </span>
        <span class="kympg-labelWrap">
          <span class="kympg-label">Open Quotes</span>
          <span class="kympg-hint">Saved quotes</span>
        </span>
      </button>

      <button class="kympg-navBtn" data-tip="Purchase Orders" type="button" onclick="kympgOpen('po', this)">
        <span class="kympg-ico" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M3 3h18v4H3z"/><path d="M3 7v14h18V7"/></svg>
        </span>
        <span class="kympg-labelWrap">
          <span class="kympg-label">Purchase Orders</span>
          <span class="kympg-hint">Vendor POs</span>
        </span>
      </button>
    </nav>
    </div>

    <div class="kympg-navGroup" id="group-tools">
    <div class="kympg-sectionLabel" onclick="kympgToggleGroup('tools')">Tools <span class="toggleMark" id="toggle-tools">−</span></div>
    <nav class="kympg-nav">
      <button class="kympg-navBtn" data-tip="Breakage Pricing" type="button" onclick="kympgOpen('breakage', this)">
        <span class="kympg-ico" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M12 3v18"/><path d="M3 12h18"/></svg>
        </span>
        <span class="kympg-labelWrap">
          <span class="kympg-label">Breakage Pricing</span>
          <span class="kympg-hint">Open breakage tool</span>
        </span>
      </button>

      <button class="kympg-navBtn" data-tip="Sq Ft Price List" type="button" onclick="kympgOpen('pricelist', this)">
        <span class="kympg-ico" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>
        </span>
        <span class="kympg-labelWrap">
          <span class="kympg-label">Sq Ft Price List</span>
          <span class="kympg-hint">Reference pricing</span>
        </span>
      </button>

      <button class="kympg-navBtn" data-tip="Shower Designer" type="button" onclick="kympgOpen('shower', this)">
        <span class="kympg-ico" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M4 7h16"/><path d="M6 7v13"/><path d="M18 7v13"/><path d="M6 20h12"/><path d="M9 10h6"/></svg>
        </span>
        <span class="kympg-labelWrap">
          <span class="kympg-label">Shower Designer</span>
          <span class="kympg-hint">Measure and preview shower doors</span>
        </span>
      </button>

      <button class="kympg-navBtn" data-tip="Invoiced Orders" type="button" onclick="kympgOpen('invoiced', this)">
        <span class="kympg-ico" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M5 4h11l3 3v13H5z"/><path d="M16 4v4h4"/><path d="M8 12h8"/><path d="M8 16h8"/></svg>
        </span>
        <span class="kympg-text">
          <span class="kympg-label">Invoiced List</span>
          <span class="kympg-hint">Closed / invoiced orders</span>
        </span>
      </button>

      <button class="kympg-navBtn" data-tip="Customer List" type="button" onclick="kympgOpen('customerimport', this)">
        <span class="kympg-ico" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M3 12h18"/><path d="M3 18h18"/><path d="M17 10l4 4-4 4"/><path d="M21 14H9"/></svg>
        </span>
        <span class="kympg-labelWrap">
          <span class="kympg-label">Customer List</span>
          <span class="kympg-hint">Upload customer list</span>
    </span>
      </button>

      <button class="kympg-navBtn" data-tip="Vendor List" type="button" onclick="kympgOpen('vendors', this)">
        <span class="kympg-ico" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M3 12h18"/><path d="M3 18h18"/><path d="M19 6v12"/></svg>
        </span>
        <span class="kympg-labelWrap">
          <span class="kympg-label">Vendor List</span>
          <span class="kympg-hint">Upload vendor list</span>
    </span>
      </button>
    </nav>
    </div>

    <div class="kympg-navGroup" id="group-residential">
    <div class="kympg-sectionLabel" onclick="kympgToggleGroup('residential')">Residential <span class="toggleMark" id="toggle-residential">−</span></div>
    <nav class="kympg-nav">
      <button class="kympg-navBtn" data-tip="New Request" type="button" onclick="kympgOpen('residential', this)">
        <span class="kympg-ico" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 5v14"/><path d="M5 12h14"/></svg></span>
        <span class="kympg-labelWrap"><span class="kympg-label">New Request</span><span class="kympg-hint">Create residential request</span></span>
      </button>
      <button class="kympg-navBtn" data-tip="Open Requests" type="button" onclick="kympgOpen('residentialdb', this)">
        <span class="kympg-ico" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg></span>
        <span class="kympg-labelWrap"><span class="kympg-label">Open Requests</span><span class="kympg-hint">Edit assigned requests</span></span>
      </button>
      <button class="kympg-navBtn" data-tip="Service Techs" type="button" onclick="kympgOpen('servicetechs', this)">
        <span class="kympg-ico" aria-hidden="true"><svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20c2-4 14-4 16 0"/></svg></span>
        <span class="kympg-labelWrap"><span class="kympg-label">Service Techs</span><span class="kympg-hint">Manage technician list</span></span>
      </button>
    </nav>
    </div>

    <div class="kympg-spacer"></div>
  </aside>

  <main class="kympg-main">
    <div class="kympg-shellInner">
      <div class="kympg-topBar">
        <div class="kympg-pageTitle">
          <h1 id="kympgPageTitle">Kentucky Mirror and Plate Glass</h1>
          <p id="kympgPageSub">Select an option on the left to get started.</p>
        </div>
        <div class="kympg-authBox">
          <div class="kympg-pill" title="App status">
            <span class="dot"></span>
            <span>Ready</span>
          </div>
          <span id="authUserMeta" class="kympg-authMeta">Not signed in</span>
          <button id="adminCreateUserBtn" type="button" class="kympg-authBtn success" onclick="openAdminCreateUserModal()" style="display:none;">Create User</button>
          <button id="loginBtn" type="button" class="kympg-authBtn primary" onclick="openLogin()">Log In</button>
          <button id="logoutBtn" type="button" class="kympg-authBtn secondary" onclick="logoutUser()" style="display:none;">Log Out</button>
        </div>
      </div>

      <section class="kympg-card">
        <div class="kympg-cardHeader">
          <div class="h" id="kympgCardTitle">Home</div>
          <div class="sub" id="kympgCardSub">Welcome</div>
        </div>

        <div class="kympg-cardBody" id="kympgContentArea">

          <div id="landing-section" class="active">
            <div class="kympg-landingWrap">
              <div class="kympg-landingLogo">
                <img src="good%20logo.jpg" alt="Kentucky Mirror and Plate Glass" onerror="this.style.display='none';" />
              </div>
              <div class="kympg-landingTitle">Kentucky Mirror and Plate Glass</div>
              <div class="kympg-landingSub">
                Use the sidebar to create a new quote or order, search past orders, open quotes, manage purchase orders,
                or open the pricing tools.
              </div>

              <div class="kympg-quickSearch">
                <h3>Quick Search (Orders / Quotes / POs)</h3>
                <div class="row">
                  <input id="homeQuickSearchInput" type="text" placeholder="Search by #, customer, or phone">
                  <button type="button" onclick="runHomeQuickSearch()">Search</button>
                </div>
                <div id="homeQuickResults" class="kympg-quickResults"></div>
              </div>

              <div class="kympg-logPO">
                <h3>Log Received PO's</h3>
                <div class="row">
                  <input id="homeLogPoInput" type="text" placeholder="Enter PO # (ex: PO1000)">
                  <button type="button" onclick="logReceivedPO()">Log Received</button>
                </div>
                <div id="homeLogPoStatus" class="kympg-logPOStatus"></div>
              </div>

              <div id="techHomeRequests" class="tech-home-wrap" style="display:none;">
                <h3>Open Residential Requests</h3>
                <table>
                  <thead>
                    <tr>
                      <th>Request #</th><th>Request Date</th><th>Customer</th><th>Address</th><th>Phone</th><th>Work Type</th><th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="techHomeRequestsBody"><tr><td colspan="7" style="text-align:center;">Loading requests...</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="quotedb-section" style="display:none;">
            <h2 style="margin-top:0;">Open Quotes</h2>
            <input type="text" id="quoteSearch" placeholder="Search by quote id or customer name..." oninput="searchQuotes()" style="width:100%;max-width:420px;margin:10px 0;padding:8px;border:1px solid #ccc;border-radius:4px;">
            <table id="quoteTable" style="width:100%;border-collapse:collapse;">
              <thead>
                <tr>
                  <th>Quote #</th>
                  <th>Customer</th>
                  <th>Status</th>
                  <th>Grand Total</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="quoteTableBody">
                <tr><td colspan="6" style="text-align:center;">Loading quotes...</td></tr>
              </tbody>
            </table>
          </div>

          <div id="invoiced-section" style="display:none;">
            <h2 style="margin-top:0;">Invoiced Orders</h2>
            <input type="text" id="invoicedSearch" placeholder="Search by invoice #, order #, or customer..." oninput="searchInvoicedOrders()" style="width:100%;max-width:420px;margin:10px 0;padding:8px;border:1px solid #ccc;border-radius:4px;">
            <table id="invoicedTable" style="width:100%;border-collapse:collapse;">
              <thead>
                <tr>
                  <th>Invoice #</th>
                  <th>Order #</th>
                  <th>Customer</th>
                  <th>Terms</th>
                  <th>Total</th>
                  <th>Invoiced Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="invoicedTableBody">
                <tr><td colspan="7" style="text-align:center;">Loading invoices...</td></tr>
              </tbody>
            </table>
          </div>

          <div id="po-section" style="display:none;">
            <h2 style="margin-top:0;">Purchase Orders</h2>
            <p style="color:var(--muted);margin-top:6px;">Vendor purchase orders. Updates here sync back to the linked order.</p>
            <table style="width:100%;border-collapse:collapse;">
              <thead>
                <tr>
                  <th>Order #</th>
                  <th>Vendor</th>
                  <th>PO #</th>
                  <th>Requested Date</th>
                  <th>Estimated Delivery</th>
                  <th>Status</th>
                  <th>Received</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="poTableBody">
                <tr><td colspan="8" style="text-align:center;">Loading purchase orders...</td></tr>
              </tbody>
            </table>
          </div>

          </div>

          <div id="residential-section" style="display:none;">
            <h2 style="margin-top:0;">Residential Request</h2>
            <div class="customer-info-row">
              <div class="info-field" style="min-width: 200px;">
                <label for="resCustomerName">Customer Name</label>
                <div class="customer-lookup-container">
                  <input type="text" id="resCustomerName" placeholder="Type customer name..." autocomplete="off">
                  <ul id="resCustomerLookupList" class="customer-lookup-list"></ul>
                </div>
              </div>
              <div class="info-field"><label for="resCustomerPhone">Phone</label><input type="tel" id="resCustomerPhone"></div>
              <div class="info-field" style="flex: 0 0 auto;">
                <label>&nbsp;</label>
                <button type="button" onclick="clearResidentialCustomerInfo()">Clear Customer</button>
              </div>
            </div>
            <div class="customer-info-row">
              <div class="info-field" style="min-width: 220px;"><label for="resCustomerAddress">Address</label><input type="text" id="resCustomerAddress"></div>
              <div class="info-field"><label for="resCustomerEmail">Email</label><input type="email" id="resCustomerEmail"></div>
              <div class="info-field"><label for="resCustomerCreditTerms">Credit Terms</label><input type="text" id="resCustomerCreditTerms"></div>
            </div>
            <div class="customer-info-row">
              <div class="info-field" style="width:100%;"><label for="resDescription">Description</label><textarea id="resDescription" rows="4" style="width:98%;"></textarea></div>
            </div>
            <button type="button" onclick="saveResidentialRequest()">Save Request</button>
            <span id="residentialSaveStatus" style="margin-left:10px;color:#444;"></span>
          </div>

          <div id="residentialdb-section" style="display:none;">
            <h2 style="margin-top:0;">Open Residential Requests</h2>
            <table style="width:100%;border-collapse:collapse;">
              <thead><tr><th>Request #</th><th>Customer</th><th>Phone</th><th>Assigned Tech</th><th>Date</th><th>Actions</th></tr></thead>
              <tbody id="residentialTableBody"><tr><td colspan="6" style="text-align:center;">Loading requests...</td></tr></tbody>
            </table>
          </div>

          <div id="servicetechs-section" style="display:none;">
            <h2 style="margin-top:0;">Service Tech Database</h2>
            <div class="customer-info-row">
              <div class="info-field"><label for="techName">Name</label><input type="text" id="techName"></div>
              <div class="info-field"><label for="techPhone">Phone</label><input type="text" id="techPhone"></div>
              <div class="info-field"><label for="techEmail">Email</label><input type="email" id="techEmail"></div>
              <div class="info-field" style="flex:0 0 auto;"><label>&nbsp;</label><button type="button" onclick="saveServiceTech()">Add Tech</button></div>
            </div>
            <table style="width:100%;border-collapse:collapse;"><thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Actions</th></tr></thead><tbody id="serviceTechTableBody"></tbody></table>
          </div>

          <div id="assignTechModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:99999;align-items:center;justify-content:center;">
            <div style="background:#fff;padding:20px;border-radius:10px;min-width:320px;">
              <h3 style="margin-top:0;">Assign Service Tech</h3>
              <select id="assignTechSelect" style="width:100%;padding:8px;"></select>
              <div style="margin-top:12px;text-align:right;"><button type="button" onclick="confirmSaveResidentialRequest()">Save Request</button> <button type="button" onclick="closeAssignTechModal()">Cancel</button></div>
            </div>
          </div>
          <div id="breakage-section" style="display:none;">
            <div class="kympg-iframeWrap">
              <iframe src="https://breakagepricing.netlify.app" title="Breakage Pricing"></iframe>
            </div>
          </div>

          <div id="pricelist-section" style="display:none;">
            <div class="kympg-iframeWrap">
              <iframe src="https://kymirrorpricelist.netlify.app" title="Sq Ft Price List"></iframe>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>

<div id="top-link-box">
  <a href="https://breakagepricing.netlify.app">Breakage Pricing</a>
</div>
<div id="top-link-box-a">
  <a href="https://kympg.netlify.app">Return to Landing Page</a>
</div>
<div id="top-link-box-b">
  <a href="https://kymirrorpricelist.netlify.app">View Sq Ft Price List</a>
</div>

<div class="tab-bar">
  <button id="tabCalculator" class="active" onclick="switchTab('calculator')">New Order</button>
  <button id="tabOrders" onclick="switchTab('orders')">Orders</button>
  <button id="tabCustomers" onclick="switchTab('customers')">Customers</button>
  <button id="tabShower" onclick="switchTab('shower')">Shower Designer</button>
</div>

<div id="calculator-section">

    <!-- Order Number -->
    <div class="order-number-bar">
      <span class="order-label">Order #:</span>
      <span class="order-num" id="currentOrderNumber">Will be assigned on save</span>
      <span class="order-label" id="orderSavedStatus"></span>
    </div>

    <!-- Customer Info -->
    <div class="customer-info-row">
      <div class="info-field" style="min-width: 200px;">
        <label for="customerName">Customer Name</label>
        <div class="customer-lookup-container">
          <input type="text" id="customerName" placeholder="Type customer name..." autocomplete="off">
          <ul id="customerLookupList" class="customer-lookup-list"></ul>
        </div>
      </div>
      <div class="info-field">
        <label for="customerPhone">Phone</label>
        <input type="tel" id="customerPhone" placeholder="(123) 456-7890">
      </div>
      <div class="info-field" style="flex: 0 0 auto;">
        <label>&nbsp;</label>
        <button id="clearCustomerBtn" type="button" onclick="clearCustomerInfo()">Clear Customer</button>
      </div>
    </div>
    <div class="customer-info-row">
      <div class="info-field" style="min-width: 220px;">
        <label for="calcCustAddress">Address</label>
        <input type="text" id="calcCustAddress" placeholder="Address" readonly>
      </div>
      <div class="info-field">
        <label for="calcCustEmail">Email</label>
        <input type="email" id="calcCustEmail" placeholder="Email" readonly>
      </div>
      <div class="info-field">
        <label for="calcCustCreditTerms">Credit Terms</label>
        <input type="text" id="calcCustCreditTerms" placeholder="Credit Terms" readonly>
      </div>
    </div>

    <!-- Special Pricing -->
    <div style="display: flex; align-items: center; margin-bottom: 10px; white-space: nowrap;">
      <input type="checkbox" id="specialPricingToggle" style="margin-right: 8px;">
      <label for="specialPricingToggle">
        Use Special Customer Pricing (J-TOWN/BROWNSBORO/RIGHT HAND MAN)
      </label>
    </div>

    <!-- Glass Table -->
    <table id="glassTable">
      <thead>
        <tr>
          <th>Qty</th>
          <th>Width (in)</th>
          <th>Height (in)</th>
          <th>Glass Type</th>
          <th>Bevel?</th>
          <th>Bevel Width</th>
          <th>Shape?</th>
          <th>Each Price ($)</th>
          <th>Line Total ($)</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="glassTableBody"></tbody>
    </table>
      <!-- Hardware Pricing Section -->
  <div style="flex: 1; margin-top: 16px;">
    <h2 style="margin-top: 10px; text-align:left;">Hardware</h2>
    <table id="hardwareTable" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="border:1px solid #ccc; padding:12px; text-align:center;">Qty</th>
          <th style="border:1px solid #ccc; padding:12px; text-align:center;">Part</th>
          <th style="border:1px solid #ccc; padding:12px; text-align:center;">Price</th>
          <th style="border:1px solid #ccc; padding:12px; text-align:center;">Total</th>
          <th style="border:1px solid #ccc; padding:12px; text-align:center;">Delete</th>
        </tr>
      </thead>
      <tbody id="hardwareTableBody">
        <tr style="border-bottom:1px solid #ccc;">
          <td style="border:1px solid #ccc;"><input type="number" class="hw-qty" min="0" value="0" style="width:80px;"></td>
          <td style="border:1px solid #ccc;"><input type="text" class="hw-part" list="hardwarePartsList" placeholder="Start typing part name" style="width:95%;"></td>
          <td class="hw-price" style="border:1px solid #ccc;">$0.00</td>
          <td class="hw-total" style="border:1px solid #ccc;">$0.00</td>
          <td class="delete-cell" style="border:1px solid #ccc; text-align:center;">
            <button class="icon-btn hw-clear-line" aria-label="Clear line" title="Clear line">🗑️</button>
          </td>
        </tr>
        <tr style="border-bottom:1px solid #ccc;">
          <td style="border:1px solid #ccc;"><input type="number" class="hw-qty" min="0" value="0" style="width:80px;"></td>
          <td style="border:1px solid #ccc;"><input type="text" class="hw-part" list="hardwarePartsList" placeholder="Start typing part name" style="width:95%;"></td>
          <td class="hw-price" style="border:1px solid #ccc;">$0.00</td>
          <td class="hw-total" style="border:1px solid #ccc;">$0.00</td>
          <td class="delete-cell" style="border:1px solid #ccc; text-align:center;">
            <button class="icon-btn hw-clear-line" aria-label="Clear line" title="Clear line">🗑️</button>
          </td>
        </tr>
        <tr style="border-bottom:1px solid #ccc;">
          <td style="border:1px solid #ccc;"><input type="number" class="hw-qty" min="0" value="0" style="width:80px;"></td>
          <td style="border:1px solid #ccc;"><input type="text" class="hw-part" list="hardwarePartsList" placeholder="Start typing part name" style="width:95%;"></td>
          <td class="hw-price" style="border:1px solid #ccc;">$0.00</td>
          <td class="hw-total" style="border:1px solid #ccc;">$0.00</td>
          <td class="delete-cell" style="border:1px solid #ccc; text-align:center;">
            <button class="icon-btn hw-clear-line" aria-label="Clear line" title="Clear line">🗑️</button>
          </td>
        </tr>
      </tbody>
    </table>
    <datalist id="hardwarePartsList"></datalist>
  </div>

  <div class="customer-info-row" style="align-items:flex-start; gap:12px; margin-top:12px;">
    <div class="info-field" style="flex:1;min-width:280px;">
      <label for="customerNotes">Customer Notes</label>
      <textarea id="customerNotes" placeholder="Notes for customer docs" style="width:100%;min-height:70px;resize:vertical;"></textarea>
    </div>
    <div class="info-field" id="shopNotesField" style="flex:1;min-width:280px;display:none;">
      <label for="shopNotes">Shop Notes (Internal PO only)</label>
      <textarea id="shopNotes" placeholder="Shop-only notes for internal PO" style="width:100%;min-height:70px;resize:vertical;"></textarea>
    </div>
  </div>

    <div class="buttons">
        <!-- QUOTE BUTTONS -->
  <div id="quoteButtons">
    <button type="button" onclick="saveQuote()">Save Quote</button>
    <button type="button" onclick="printQuote()">Print Quote</button>
    <button type="button" onclick="convertToOrder()">Convert to Order</button>
  </div>
   <!-- ORDER BUTTONS -->
  <div id="orderButtons" style="display:none;">
      <button id="newOrderActionBtn" class="btn-new-order" type="button" onclick="startNewOrder()">New Order</button>
      <button id="saveOrderActionBtn" class="btn-save-order" type="button" onclick="saveOrder()">Save Order</button>
      <button id="printPackingActionBtn" type="button" onclick="printDoc('packing-list')">Print Packing List</button>
      <button id="printInvoiceActionBtn" type="button" onclick="printDoc('invoice')">Print Invoice</button>
      <button id="printPoActionBtn" type="button" onclick="printDoc('purchase-order')">Print PO</button>
      <button id="editPoActionBtn" type="button" onclick="editPoForOrder(currentOrderId)" style="display:none;">Edit PO</button>
      <button id="deleteOrderActionBtn" type="button" onclick="deleteCurrentOrder()">Delete Order</button>
    </div>

    <h3 id="grandTotal">Grand Total: $0.00</h3>
    <h3 id="grandTotalTax">Grand Total with Tax (6%): $0.00</h3>
  </div>


</div>
</div><!-- end calculator-section -->

<!-- Customer Management Section -->
<div id="customer-section">

  <div id="customerFormWrapper" style="display:none;">
    <form id="customerForm" onsubmit="saveCustomer(event)">
      <input type="hidden" id="custEditId" value="">
      <h3 id="formTitle">Add New Customer</h3>

      <label for="custName">Customer Name *</label>
      <input type="text" id="custName" required placeholder="Enter customer name">

      <label for="custAddress">Address</label>
      <input type="text" id="custAddress" placeholder="Enter address">

      <label for="custEmail">Email</label>
      <input type="email" id="custEmail" placeholder="Enter email address">

      <label for="custPhone">Phone Number</label>
      <input type="tel" id="custPhone" placeholder="(123) 456-7890">

      <label for="custCreditTerms">Credit Terms</label>
      <input type="text" id="custCreditTerms" placeholder="e.g. Net 30, COD, Prepaid">

      <div class="form-actions">
        <button type="submit" class="btn-save">Save Customer</button>
        <button type="button" class="btn-cancel" onclick="cancelCustomerForm()">Cancel</button>
      </div>
    </form>
  </div>

  <button class="btn-add-customer" onclick="showAddCustomerForm()">+ Add Customer</button>
  <button class="btn-upload-customer" onclick="document.getElementById('importFileInput').click()">Upload from CSV/Excel</button>
  <input type="file" id="importFileInput" accept=".csv,.xlsx,.xls" style="display:none;" onchange="handleImportFile(event)">
  <input type="text" id="customerSearch" placeholder="Search customers..." oninput="filterCustomerTable()">

  <table id="customerTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Address</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Credit Terms</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="customerTableBody">
      <tr><td colspan="6" style="text-align:center;">Loading customers...</td></tr>
    </tbody>
  </table>
</div>

<!-- Vendor Management Section -->
<div id="vendor-section" style="display:none;">
  <div id="vendorFormWrapper" style="display:none;">
    <form id="vendorForm" onsubmit="saveVendor(event)">
      <input type="hidden" id="vendorEditId" value="">
      <h3 id="vendorFormTitle">Add New Vendor</h3>
      <label for="vendorName">Vendor Name *</label>
      <input type="text" id="vendorName" required placeholder="Enter vendor name">
      <label for="vendorAddress">Address</label>
      <input type="text" id="vendorAddress" placeholder="Enter address">
      <label for="vendorEmail">Email</label>
      <input type="email" id="vendorEmail" placeholder="Enter email address">
      <label for="vendorPhone">Phone Number</label>
      <input type="tel" id="vendorPhone" placeholder="(123) 456-7890">
      <div class="form-actions">
        <button type="submit" class="btn-save">Save Vendor</button>
        <button type="button" class="btn-cancel" onclick="cancelVendorForm()">Cancel</button>
      </div>
    </form>
  </div>

  <button class="btn-add-customer" onclick="showAddVendorForm()">+ Add Vendor</button>
  <button class="btn-upload-customer" onclick="document.getElementById('vendorImportFileInput').click()">Upload Vendor CSV/Excel</button>
  <input type="file" id="vendorImportFileInput" accept=".csv,.xlsx,.xls" style="display:none;" onchange="handleVendorImportFile(event)">
  <input type="text" id="vendorSearch" placeholder="Search vendors..." oninput="filterVendorTable()">

  <table id="vendorTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Address</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="vendorTableBody">
      <tr><td colspan="5" style="text-align:center;">Loading vendors...</td></tr>
    </tbody>
  </table>
</div>

<!-- Orders Section -->
<div id="orders-section">
  <h2>Orders</h2>
  <input type="text" id="orderSearch" placeholder="Search by order number or customer name..." oninput="searchOrders()">

  <table id="orderTable">
    <thead>
      <tr>
        <th>Order #</th>
        <th>Customer</th>
        <th>Items</th>
        <th>Grand Total</th>
        <th>Total w/ Tax</th>
        <th>Date</th>
        <th>Vendor</th>
        <th>PO #</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="orderTableBody">
      <tr><td colspan="10" style="text-align:center;">Loading orders...</td></tr>
    </tbody>
  </table>
</div>

<div id="shower-section">
  <h2>Shower Door Measuring App</h2>
  <p>Enter your field measurements and instantly preview the shower enclosure layout.</p>
  <div class="shower-layout">
    <div class="shower-card">
      <div class="shower-grid">
        <div>
          <label for="showerWidth">Opening Width (in)</label>
          <input id="showerWidth" type="number" min="20" step="0.25" value="60">
        </div>
        <div>
          <label for="showerHeight">Height (in)</label>
          <input id="showerHeight" type="number" min="60" step="0.25" value="76">
        </div>
        <div>
          <label for="wallLeft">Left Return Wall (in)</label>
          <input id="wallLeft" type="number" min="0" step="0.25" value="0">
        </div>
        <div>
          <label for="wallRight">Right Return Wall (in)</label>
          <input id="wallRight" type="number" min="0" step="0.25" value="0">
        </div>
        <div>
          <label for="doorWidth">Door Panel Width (in)</label>
          <input id="doorWidth" type="number" min="18" step="0.25" value="28">
        </div>
        <div>
          <label for="glassTypeSelect">Glass Thickness</label>
          <select id="glassTypeSelect">
            <option value='3/8"'>3/8"</option>
            <option value='1/2"'>1/2"</option>
          </select>
        </div>
        <div>
          <label for="doorSwing">Door Swing</label>
          <select id="doorSwing">
            <option value="left">Left Hinge</option>
            <option value="right">Right Hinge</option>
          </select>
        </div>
        <div>
          <label for="layoutType">Layout</label>
          <select id="layoutType">
            <option value="inline">Inline (Door + Fixed)</option>
            <option value="neo">Neo-angle style</option>
            <option value="slider">Bypass Slider</option>
          </select>
        </div>
      </div>
      <div class="buttons" style="margin-top:12px;">
        <button type="button" onclick="renderShowerDesign()">Render Preview</button>
        <button type="button" onclick="downloadShowerPreview()">Download PNG</button>
      </div>
      <div id="showerStats" class="shower-stats"></div>
    </div>
    <div>
      <canvas id="showerPreview" width="640" height="420" aria-label="Shower door preview"></canvas>
    </div>
  </div>
</div>
<script>
  // Sidebar + shell navigation (load this early so inline onclick works)
  function kympgToggleSidebar() {
    const sb = document.getElementById('kympgSidebar');
    if (!sb) return;
    sb.classList.toggle('collapsed');
  }

  function kympgShowLanding() {
    const landing = document.getElementById('landing-section');
    if (landing) landing.style.display = 'block';

    ['calculator-section','orders-section','shower-section','invoiced-section','customer-section','vendor-section','breakage-section','pricelist-section','quotedb-section','po-section','residential-section','residentialdb-section','servicetechs-section']
      .forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
  }

  function kympgOpen(which, btn) {
    document.querySelectorAll('.kympg-navBtn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');

    ['landing-section','calculator-section','orders-section','shower-section','invoiced-section','customer-section','vendor-section','breakage-section','pricelist-section','quotedb-section','po-section','residential-section','residentialdb-section','servicetechs-section']
      .forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });

    const map = {
      quote: 'calculator-section',
      order: 'calculator-section',
      orders: 'orders-section',
      shower: 'shower-section',
      customerimport: 'customer-section',
      vendors: 'vendor-section',
      breakage: 'breakage-section',
      pricelist: 'pricelist-section',
      quotedb: 'quotedb-section',
      invoiced: 'invoiced-section',
      po: 'po-section',
      residential: 'residential-section',
      residentialdb: 'residentialdb-section',
      servicetechs: 'servicetechs-section',
    };

    const targetId = map[which] || 'landing-section';
    const target = document.getElementById(targetId);
    if (target) target.style.display = 'block';
    if (which === 'po' && typeof loadPurchaseOrders === 'function') loadPurchaseOrders();
  }

  // Ignore noisy browser-extension promise rejections unrelated to app logic.
  window.addEventListener('unhandledrejection', function(event) {
    const reason = event && event.reason;
    const message = (typeof reason === 'string' ? reason : (reason && reason.message) || '').toLowerCase();
    if (message.includes('no tab with id')) {
      event.preventDefault();
    }
  });
</script>

<script>
// ===================== DATA SECTION =====================
// Pricing is now loaded from Google Sheets (Glass + Hardware).
// All sizing/minimum/bevel/shape rules remain the same — only the price tables moved out of the code.
//
// ✅ HOW TO SET UP YOUR GOOGLE SHEET
// Create a Google Sheet with these tabs (exact names recommended):
//   1) Glass_Standard   columns: Glass Type | Price | Min
//   2) Glass_Special    columns: Glass Type | Price | Min
//   3) Hardware         columns: Part | Price
//
// Then: File → Share → Publish to web → Publish EACH TAB as "CSV"
// Paste the published CSV links below.
//
// Tip: Keep the "Glass Type" text EXACTLY how you want it to appear in the dropdown.
// The calculator matches the text exactly.

const SHEET_CSV = {
  glassStandard: "https://docs.google.com/spreadsheets/d/1NJS6RbTqk5JDWKs6xgP3PA6cLYYHMalYXBzclECSw-0/gviz/tq?tqx=out:csv&gid=0",
  glassSpecial:  "https://docs.google.com/spreadsheets/d/1NJS6RbTqk5JDWKs6xgP3PA6cLYYHMalYXBzclECSw-0/gviz/tq?tqx=out:csv&gid=1205552692",
  hardware:      "https://docs.google.com/spreadsheets/d/1NJS6RbTqk5JDWKs6xgP3PA6cLYYHMalYXBzclECSw-0/gviz/tq?tqx=out:csv&gid=1473389068"
};

// These get populated from Google Sheets
let standardglassPartsData = {};
let specialGlassPartsData  = {};
let hardwareParts          = {};

// Active glass dataset (standard vs special)
let glassPartsData = standardglassPartsData;

// Bevel pricing stays in code (rule-based pricing table)
const bevelPrices = {
  "1/4": { "1/2": { price: 0.3, min: 25 }, "1": { price: 0.4, min: 25 }, "1 1/4": { price: 0.5, min: 25 }},
  "3/8": { "1/2": { price: 0.8, min: 35 }, "1": { price: 0.8, min: 35 }, "1 1/4": { price: 0.8, min: 35 }},
  "1/2": { "1/2": { price: 0.8, min: 35 }, "1": { price: 0.8, min: 35 }, "1 1/4": { price: 0.8, min: 35 }}
};

// ------- CSV loader helpers (no dependencies) -------
function parseCsv(text) {
  // Handles commas + quotes. Returns array of rows (array of strings).
  const rows = [];
  let row = [];
  let cur = '';
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i + 1];

    if (ch === '"') {
      if (inQuotes && next === '"') { // escaped quote
        cur += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
      continue;
    }

    if (!inQuotes && (ch === ',')) {
      row.push(cur);
      cur = '';
      continue;
    }

    if (!inQuotes && (ch === '\n' || ch === '\r')) {
      // handle CRLF
      if (ch === '\r' && next === '\n') i++;
      row.push(cur);
      rows.push(row);
      row = [];
      cur = '';
      continue;
    }

    cur += ch;
  }

  // last cell
  if (cur.length || row.length) {
    row.push(cur);
    rows.push(row);
  }

  // trim cells
  return rows.map(r => r.map(c => (c ?? '').toString().trim()));
}

async function fetchCsv(url) {
  if (!url || url.includes("PASTE_")) return null;

  // Force fresh fetch
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error(`Failed to fetch CSV (${res.status}): ${url}`);
  const text = await res.text();

  // Some Google publish links start with a UTF-8 BOM
  return text.replace(/^\uFEFF/, '');
}

function toNumber(val) {
  if (val === null || val === undefined) return NaN;
  const cleaned = String(val).replace(/[$,]/g, '').trim();
  if (!cleaned) return NaN;
  return Number(cleaned);
}

function rowsToGlassMap(rows) {
  // Expect header row containing columns like: Glass Type | Price | Min
  // We'll find indices by header names (case-insensitive).
  if (!rows || rows.length < 2) return {};

  const header = rows[0].map(h => h.toLowerCase());
  const nameIdx  = header.findIndex(h => h.includes('glass') || h.includes('type') || h.includes('part') || h.includes('name'));
  const priceIdx = header.findIndex(h => h.includes('price'));
  const minIdx   = header.findIndex(h => h.includes('min'));

  const map = {};
  for (let r = 1; r < rows.length; r++) {
    const cols = rows[r];
    const name = (cols[nameIdx] ?? '').trim();
    if (!name) continue;

    const price = toNumber(cols[priceIdx]);
    const min   = toNumber(cols[minIdx]);

    if (Number.isNaN(price)) continue; // skip bad rows

    map[name] = {
      price: price,
      min: Number.isNaN(min) ? 0 : min
    };
  }
  return map;
}

function rowsToHardwareMap(rows) {
  // Expect header: Part | Price  (or Name | Price)
  if (!rows || rows.length < 2) return {};

  const header = rows[0].map(h => h.toLowerCase());
  const nameIdx  = header.findIndex(h => h.includes('part') || h.includes('name') || h.includes('item') || h.includes('hardware'));
  const priceIdx = header.findIndex(h => h.includes('price'));

  const map = {};
  for (let r = 1; r < rows.length; r++) {
    const cols = rows[r];
    const name = (cols[nameIdx] ?? '').trim();
    if (!name) continue;

    const price = toNumber(cols[priceIdx]);
    if (Number.isNaN(price)) continue;

    map[name] = price;
  }
  return map;
}

function setLoadingState(isLoading, msg) {
  const gt = document.getElementById('grandTotal');
  if (!gt) return;
  if (isLoading) {
    gt.dataset._orig = gt.innerText;
    gt.innerText = msg || 'Loading pricing from Google Sheets...';
  } else if (gt.dataset._orig) {
    gt.innerText = gt.dataset._orig;
    delete gt.dataset._orig;
  }
}

async function loadPricingFromSheets() {
  // If URLs are not set yet, keep existing maps empty and allow user to still use UI
  const needsSetup = Object.values(SHEET_CSV).some(u => !u || u.includes("PASTE_"));
  if (needsSetup) {
    console.warn("Google Sheet CSV links not set yet in SHEET_CSV. Pricing tables will be empty until you paste them.");
    return;
  }

  setLoadingState(true);

  try {
    const [stdText, spText, hwText] = await Promise.all([
      fetchCsv(SHEET_CSV.glassStandard),
      fetchCsv(SHEET_CSV.glassSpecial),
      fetchCsv(SHEET_CSV.hardware)
    ]);

    const stdRows = parseCsv(stdText || '');
    const spRows  = parseCsv(spText || '');
    const hwRows  = parseCsv(hwText || '');

    standardglassPartsData = rowsToGlassMap(stdRows);
    specialGlassPartsData  = rowsToGlassMap(spRows);
    hardwareParts          = rowsToHardwareMap(hwRows);
    refreshHardwareDatalist();

    // Refresh active pointer after load
    const specialToggle = document.getElementById('specialPricingToggle');
    glassPartsData = (specialToggle && specialToggle.checked) ? specialGlassPartsData : standardglassPartsData;

    // Re-render any existing dropdown lists & totals
    updateTotals();

  } catch (err) {
    console.error(err);
    alert("Could not load pricing from Google Sheets. Check your published CSV links and that the tabs are published as CSV.");
  } finally {
    setLoadingState(false);
  }
}


// ===================== BEHAVIOR =====================

// Phone formatter
document.getElementById('customerPhone').addEventListener('input', function (e) {
  let input = e.target.value.replace(/\D/g, '');
  if (input.length > 10) input = input.substring(0, 10);

  let formatted = input;
  if (input.length > 6) {
    formatted = `(${input.substring(0,3)}) ${input.substring(3,6)}-${input.substring(6)}`;
  } else if (input.length > 3) {
    formatted = `(${input.substring(0,3)}) ${input.substring(3)}`;
  } else if (input.length > 0) {
    formatted = `(${input}`;
  }
  e.target.value = formatted;
});

// ✅ Print breakdown WITH each price & line total
function printBreakdown() {
  const customerName = document.getElementById('customerName').value || "N/A";
  const customerPhone = document.getElementById('customerPhone').value || "N/A";
  const customerAddress = document.getElementById('calcCustAddress').value || "";
  const customerEmail = document.getElementById('calcCustEmail').value || "";
  const customerCreditTerms = document.getElementById('calcCustCreditTerms').value || "";
  const orderNumber = document.getElementById('currentOrderNumber').textContent;

  let breakdownWindow = window.open('', '', 'width=800,height=600');

  breakdownWindow.document.write('<style>table {width:100%;border-collapse:collapse;} th,td {border:1px solid #000;padding:8px;text-align:center;} h2,h3 {text-align:center;} </style>');
  breakdownWindow.document.write('</head><body>');
  
  if (orderNumber && orderNumber !== 'Will be assigned on save') {
    breakdownWindow.document.write(`<h3 style="margin-bottom:5px;">${orderNumber}</h3>`);
  }

  let custInfoHtml = `<p style="text-align:center; font-size:16px; margin-bottom:20px;">
    <strong>Customer Name:</strong> ${customerName} &nbsp;&nbsp;
    <strong>Phone:</strong> ${customerPhone}`;
  if (customerAddress) custInfoHtml += `<br><strong>Address:</strong> ${customerAddress}`;
  if (customerEmail) custInfoHtml += ` &nbsp;&nbsp;<strong>Email:</strong> ${customerEmail}`;
  if (customerCreditTerms) custInfoHtml += `<br><strong>Credit Terms:</strong> ${customerCreditTerms}`;
  custInfoHtml += `</p>`;
  breakdownWindow.document.write(custInfoHtml);

  breakdownWindow.document.write('<table>');
  breakdownWindow.document.write('<thead><tr><th>Qty</th><th>Size (W x H)</th><th>Glass Type</th><th>Each Price</th><th>Line Total</th></tr></thead><tbody>');

  let rows = document.querySelectorAll('#glassTableBody tr');
  rows.forEach(row => {
    const qty = row.querySelector('.qty')?.value || '';
    const width = row.querySelector('.width')?.value || '';
    const height = row.querySelector('.height')?.value || '';
    let glassType = row.querySelector('.glassTypeInput')?.value || '';
    const bevelChecked = row.querySelector('.bevel')?.checked;
    const bevelWidth = row.querySelector('.bevelWidth')?.value || '';
    const shapeChecked = row.querySelector('.shape')?.checked;
    const eachPrice = row.querySelector('.eachPrice')?.innerText || '$0.00';
    const lineTotal = row.querySelector('.lineTotal')?.innerText || '$0.00';

    if (glassType.trim() !== '') {
      const bits = [];
      if (bevelChecked) bits.push(`${bevelWidth}" BEVEL`);
      if (shapeChecked) bits.push('SHAPE');

      if (bits.length === 1) {
        glassType += ` WITH ${bits[0]}`;
      } else if (bits.length === 2) {
        glassType += ` WITH ${bits[0]} & ${bits[1]}`;
      }

      breakdownWindow.document.write(`<tr>
        <td>${qty}</td>
        <td>${width} x ${height}</td>
        <td>${glassType}</td>
        <td>${eachPrice}</td>
        <td>${lineTotal}</td>
      </tr>`);
    }
  });

  breakdownWindow.document.write('</tbody></table>');

  const grandTotal = document.getElementById('grandTotal').innerText;
  const grandTotalTax = document.getElementById('grandTotalTax').innerText;

  breakdownWindow.document.write(`<h3>${grandTotal}</h3>`);
  breakdownWindow.document.write(`<h3>${grandTotalTax}</h3>`);
  breakdownWindow.document.write('</body></html>');
  breakdownWindow.document.close();
  breakdownWindow.print();
}

// Special pricing toggle
document.getElementById('specialPricingToggle').addEventListener('change', function() {
  glassPartsData = this.checked ? specialGlassPartsData : standardglassPartsData;
  updateTotals();
});

// Clear line (trash icon)
document.getElementById('glassTableBody').addEventListener('click', function(e) {
  const btn = e.target.closest('.clear-line');
  if (!btn) return;

  const row = btn.closest('tr');
  if (!row) return;

  const qtyEl = row.querySelector('.qty');
  const widthEl = row.querySelector('.width');
  const heightEl = row.querySelector('.height');
  const typeEl = row.querySelector('.glassTypeInput');
  const bevelEl = row.querySelector('.bevel');
  const bevelWidthEl = row.querySelector('.bevelWidth');
  const shapeEl = row.querySelector('.shape');
  const listEl = row.querySelector('.glassList');
  const eachEl = row.querySelector('.eachPrice');
  const lineEl = row.querySelector('.lineTotal');

  if (qtyEl) qtyEl.value = 1;
  if (widthEl) widthEl.value = '';
  if (heightEl) heightEl.value = '';
  if (typeEl) typeEl.value = '';
  if (bevelEl) bevelEl.checked = false;
  if (shapeEl) shapeEl.checked = false;
  if (bevelWidthEl) bevelWidthEl.selectedIndex = 0;
  if (listEl) { listEl.innerHTML = ''; listEl.style.display = 'none'; }
  if (eachEl) eachEl.innerText = '$0.00';
  if (lineEl) lineEl.innerText = '$0.00';

  delete row.dataset.bevelAlerted;
  delete row.dataset.plexiAlerted;

  updateTotals();
});
// Hardware line (trash icon)
document.getElementById('hardwareTableBody').addEventListener('click', function(e) {
  const btn = e.target.closest('.hw-clear-line');
  if (!btn) return;

  const row = btn.closest('tr');
  if (!row) return;

  const qtyEl = row.querySelector('.hw-qty');
  const partEl = row.querySelector('.hw-part');
  const priceEl = row.querySelector('.hw-price');
  const totalEl = row.querySelector('.hw-total');

  if (qtyEl) qtyEl.value = 0;
  if (partEl) partEl.value = '';
  if (priceEl) priceEl.innerText = '$0.00';
  if (totalEl) totalEl.innerText = '$0.00';

  updateTotals(); // totals already include hardware
});
// Hardware table events
document.getElementById('hardwareTableBody').addEventListener('input', function (event) {
  const row = event.target.closest('tr');
  if (!row) return;
  updateHardwareRow(row);
  updateHardwareTotals();
});

// ===================== FUNCTIONS =====================
function parseInput(value) {
  if (!value) return 0;
  value = value.trim();
  if (value.includes(' ')) {
    const parts = value.split(' ');
    const whole = parseFloat(parts[0]);
    const fractionParts = parts[1].split('/');
    return whole + (parseFloat(fractionParts[0]) / parseFloat(fractionParts[1]));
  } else if (value.includes('/')) {
    const fractionParts = value.split('/');
    return parseFloat(fractionParts[0]) / parseFloat(fractionParts[1]);
  } else {
    return parseFloat(value);
  }
}
function roundEven(num) {
  if (isNaN(num)) return 0;
  let rounded = Math.ceil(num);
  return (rounded % 2 === 0) ? rounded : rounded + 1;
}

function addRow() {
  const tbody = document.getElementById('glassTableBody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="number" class="qty" value="1" min="1" style="width: 60px;"></td>
    <td><input type="text" class="width"></td>
    <td><input type="text" class="height"></td>
    <td style="position:relative;">
      <input type="text" class="glassTypeInput largeDropdown" placeholder="Type to search glass...">
      <ul class="glassList"></ul>
    </td>
    <td><input type="checkbox" class="bevel"></td>
    <td>
      <select class="bevelWidth">
        <option value="1/2">1/2"</option>
        <option value="1">1"</option>
        <option value="1 1/4">1 1/4"</option>
      </select>
    </td>
    <td><input type="checkbox" class="shape"></td>
    <td class="eachPrice">$0.00</td>
    <td class="lineTotal">$0.00</td>
    <td class="delete-cell">
      <button class="icon-btn clear-line" aria-label="Clear line" title="Clear line">🗑️</button>
    </td>
  `;

  tbody.appendChild(tr);
  setupGlassSearch(tr.querySelector('.glassTypeInput'), tr.querySelector('.glassList'));
  tr.querySelectorAll('input, select').forEach(el => {
    el.addEventListener('input', updateTotals);
    el.addEventListener('change', updateTotals);
  });
}

function setupGlassSearch(inputElement, listElement) {
  let currentIndex = -1;

  function buildList() {
    const search = inputElement.value.toLowerCase().trim();
    listElement.innerHTML = '';
    currentIndex = -1;

    // If nothing typed, don't force a list open
    if (!search) {
      listElement.style.display = 'none';
      return;
    }

    const matches = Object.keys(glassPartsData).filter(glass =>
      glass.toLowerCase().includes(search)
    );

    matches.forEach((glass, idx) => {
      const li = document.createElement('li');
      li.textContent = glass;
      li.dataset.index = idx;

      // Use mousedown so it fires before input loses focus
      li.addEventListener('mousedown', (e) => {
        e.preventDefault();
        selectItem(glass);
      });

      listElement.appendChild(li);
    });

    listElement.style.display = matches.length ? 'block' : 'none';
  }

  function setActiveItem(items) {
    items.forEach((li, idx) => {
      li.classList.toggle('active', idx === currentIndex);
    });
    if (currentIndex >= 0 && items[currentIndex]) {
      items[currentIndex].scrollIntoView({ block: 'nearest' });
    }
  }

  function selectItem(glass) {
    inputElement.value = glass;
    listElement.style.display = 'none';
    currentIndex = -1;
    updateTotals();
  }

  // Typing filters the list, but you can just hit Enter now
  inputElement.addEventListener('input', buildList);

  inputElement.addEventListener('focus', () => {
    if (inputElement.value.trim()) {
      buildList();
    }
  });

  inputElement.addEventListener('keydown', (e) => {
    const items = listElement.querySelectorAll('li');

    if (e.key === 'ArrowDown' && items.length) {
      e.preventDefault();
      currentIndex = (currentIndex + 1) % items.length;
      setActiveItem(items);
    } else if (e.key === 'ArrowUp' && items.length) {
      e.preventDefault();
      currentIndex = (currentIndex - 1 + items.length) % items.length;
      setActiveItem(items);
    } else if (e.key === 'Enter') {
      // If list is open and we have matches, Enter will select
      if (listElement.style.display === 'block' && items.length) {
        e.preventDefault();
        const indexToUse = currentIndex >= 0 ? currentIndex : 0;
        selectItem(items[indexToUse].textContent);
      }
    } else if (e.key === 'Escape') {
      listElement.style.display = 'none';
      currentIndex = -1;
    }
  });
}




function updateTotals() {
  let grandTotal = 0;
  const rows = document.querySelectorAll('#glassTableBody tr');

  rows.forEach(row => {
    const widthInput = row.querySelector('.width').value;
    const heightInput = row.querySelector('.height').value;
    const glassType = row.querySelector('.glassTypeInput').value;
    const bevelCheckbox = row.querySelector('.bevel');
    const bevelChecked = bevelCheckbox.checked;
    const bevelWidth = row.querySelector('.bevelWidth').value;
    const shapeCheckbox = row.querySelector('.shape');
    const shapeChecked = shapeCheckbox.checked;

    if (shapeChecked) {
      bevelCheckbox.checked = false;
    }

    if (!glassType || !glassPartsData[glassType]) {
      row.querySelector('.eachPrice').innerText = '$0.00';
      row.querySelector('.lineTotal').innerText = '$0.00';
      return;
    }

    let width = roundEven(parseInput(widthInput));
    let height = roundEven(parseInput(heightInput));
    if (isNaN(width) || isNaN(height)) {
      row.querySelector('.eachPrice').innerText = '$0.00';
      row.querySelector('.lineTotal').innerText = '$0.00';
      return;
    }

    // PLEXI — quote ONLY if the piece cannot be cut from a 48 x 96 sheet (any orientation)
    const isPlexi = glassType.toUpperCase().includes('PLEXI');

    if (isPlexi) {
      const fitsNormal  = width <= 48 && height <= 96; // 48 x 96
      const fitsRotated = width <= 96 && height <= 48; // 96 x 48

      // If it doesn't fit in either orientation, it must be quoted
      if (!fitsNormal && !fitsRotated) {
        row.querySelector('.eachPrice').innerText = '$0.00';
        row.querySelector('.lineTotal').innerText = 'Must be quoted by General Rubber';

        if (row.dataset.plexiAlerted !== 'true') {
          alert('This size cannot be cut from a 48 x 96 sheet and must be quoted by General Rubber.');
          row.dataset.plexiAlerted = 'true';
        }

        return; // stop calculations for this row
      }
    }

    // If we get here, either it is not plexi, or plexi fits 48x96 in some orientation
    delete row.dataset.plexiAlerted;

    let area = (width * height) / 144;
    const partInfo = glassPartsData[glassType];

    // ================= CUSTOM MINIMUM RULE CHANGES =================
    // - Polished tempered: minimum 3 sq ft charge
    // - Polished non-tempered: $15 minimum
    // - Everything else: use partInfo.min
    let basePrice;

    const upperType = glassType.toUpperCase();
    const isTempered = upperType.includes("TEMPERED");
    const isPolished = upperType.includes("POLISHED");

    // 🚨 TEMPERED + SHAPE = MUST QUOTE BY GLENNY
if (isTempered && shapeChecked) {
  row.querySelector('.eachPrice').innerText = '$0.00';
  row.querySelector('.lineTotal').innerText = 'Needs quoted by Glenny';

  if (row.dataset.temperedShapeAlerted !== "true") {
    alert("Tempered shapes must be quoted by Glenny.");
    row.dataset.temperedShapeAlerted = "true";
  }

  return; // stop calculations for this row
} else {
  delete row.dataset.temperedShapeAlerted;
}


    if (isTempered && isPolished) {
      // Polished tempered -> minimum 3 sq ft
      const billableArea = area < 3 ? 3 : area;
      basePrice = billableArea * partInfo.price;
    } else if (isPolished) {
      // Polished, not tempered -> $15 minimum
      basePrice = area * partInfo.price;
      if (basePrice < 15) basePrice = 15;
    } else {
      // All other glass types -> fall back to table minimum
      basePrice = area * partInfo.price;
      if (basePrice < partInfo.min) basePrice = partInfo.min;
    }
    // ===============================================================
    let bevelCost = 0;
    const thickness = glassType.includes('1/4') ? "1/4" :
                      glassType.includes('3/8') ? "3/8" :
                      glassType.includes('1/2') ? "1/2" : null;

    if (bevelChecked && thickness && bevelPrices[thickness] && bevelPrices[thickness][bevelWidth]) {
      const bevelData = bevelPrices[thickness][bevelWidth];
      const perimeter = 2 * (width + height);
      bevelCost = perimeter * bevelData.price;
      if (bevelCost < bevelData.min) bevelCost = bevelData.min;
      row.dataset.bevelAlerted = "false";
    } else if (bevelChecked && row.dataset.bevelAlerted !== "true") {
      alert("This glass type cannot be beveled.");
      row.dataset.bevelAlerted = "true";
    }

    const qty = parseInt(row.querySelector('.qty')?.value) || 1;

    let eachPrice = basePrice + bevelCost;
    if (shapeChecked) {
      // 25% upcharge for shapes
      eachPrice *= 1.25;

      // Shape minimums AFTER the 25% upcharge (per piece)
      let shapeMin = 0;
      if (glassType.includes('1/8')) shapeMin = 25;
      else if (glassType.includes('3/16')) shapeMin = 25;
      else if (glassType.includes('1/4')) shapeMin = 25;
      else if (glassType.includes('3/8')) shapeMin = 60;
      else if (glassType.includes('1/2')) shapeMin = 70;

      if (shapeMin > 0 && eachPrice < shapeMin) eachPrice = shapeMin;
    }
let total = eachPrice * qty;

    row.querySelector('.eachPrice').innerText = `$${eachPrice.toFixed(2)}`;
    row.querySelector('.lineTotal').innerText = `$${total.toFixed(2)}`;

    grandTotal += total;
  });

  // Add hardware total to the combined grand total
  let hardwareTotal = 0;
  document.querySelectorAll('#hardwareTableBody tr').forEach(row => {
    const totalText = row.querySelector('.hw-total')?.innerText || '$0.00';
    const match = totalText.match(/\$([\d,.]+)/);
    if (match) hardwareTotal += parseFloat(match[1].replace(/,/g, '')) || 0;
  });
  grandTotal += hardwareTotal;

  document.getElementById('grandTotal').innerText =
    `Grand Total: $${grandTotal.toFixed(2)}`;
  document.getElementById('grandTotalTax').innerText =
    `Grand Total with Tax (6%): $${(grandTotal * 1.06).toFixed(2)}`;
}

function clearForm() {
  startNewOrder();
}

function refreshHardwareDatalist() {
  const datalist = document.getElementById('hardwarePartsList');
  if (!datalist) return;
  datalist.innerHTML = Object.keys(hardwareParts)
    .sort((a,b) => a.localeCompare(b))
    .map(part => `<option value="${escapeHtml(part)}"></option>`)
    .join('');
}

function updateHardwareRow(row) {
  const qtyEl = row.querySelector('.hw-qty');
  const partEl = row.querySelector('.hw-part');
  const priceEl = row.querySelector('.hw-price');
  const totalEl = row.querySelector('.hw-total');

  const qty = Math.max(0, parseInt(qtyEl?.value, 10) || 0);
  if (qtyEl && String(qtyEl.value) !== String(qty)) qtyEl.value = qty;

  const partName = (partEl?.value || '').trim();
  const unitPrice = hardwareParts[partName] || 0;
  const lineTotal = unitPrice * qty;

  if (priceEl) priceEl.innerText = `$${unitPrice.toFixed(2)}`;
  if (totalEl) totalEl.innerText = `$${lineTotal.toFixed(2)}`;
}

function updateHardwareTotals() {
  const rows = document.querySelectorAll('#hardwareTableBody tr');
  let hardwareTotal = 0;
  rows.forEach(row => {
    const totalText = row.querySelector('.hw-total')?.innerText || '$0.00';
    const match = totalText.match(/\$([\d,.]+)/);
    if (match) hardwareTotal += parseFloat(match[1].replace(/,/g, '')) || 0;
  });

  // Also update the combined grand total
  updateTotals();
}

function clearHardware() {
  document.querySelectorAll('#hardwareTableBody tr').forEach(row => {
    const qtyEl = row.querySelector('.hw-qty');
    const partEl = row.querySelector('.hw-part');
    if (qtyEl) qtyEl.value = 0;
    if (partEl) partEl.value = '';
    row.querySelector('.hw-price').innerText = '$0.00';
    row.querySelector('.hw-total').innerText = '$0.00';
  });
  updateHardwareTotals();
}

// ===================== TAB SWITCHING =====================
function switchTab(tab) {
  const calcSection = document.getElementById('calculator-section');
  const custSection = document.getElementById('customer-section');
  const ordSection = document.getElementById('orders-section');
  const showerSection = document.getElementById('shower-section');
  const tabCalc = document.getElementById('tabCalculator');
  const tabCust = document.getElementById('tabCustomers');
  const tabOrd = document.getElementById('tabOrders');
  const tabShower = document.getElementById('tabShower');

  // Hide all
  calcSection.classList.add('hidden');
  custSection.classList.remove('active');
  ordSection.classList.remove('active');
  showerSection.classList.remove('active');
  tabCalc.classList.remove('active');
  tabCust.classList.remove('active');
  tabOrd.classList.remove('active');
  if (tabShower) tabShower.classList.remove('active');

  if (tab === 'customers') {
    custSection.classList.add('active');
    tabCust.classList.add('active');
    loadCustomers();
  } else if (tab === 'orders') {
    ordSection.classList.add('active');
    tabOrd.classList.add('active');
    loadOrders();
  } else if (tab === 'shower') {
    showerSection.classList.add('active');
    if (tabShower) tabShower.classList.add('active');
    renderShowerDesign();
  } else {
    calcSection.classList.remove('hidden');
    tabCalc.classList.add('active');
    // Refresh customer list for autocomplete in case new ones were added
    loadCalcCustomers();
  }
}


function renderShowerDesign() {
  const width = Math.max(20, parseFloat(document.getElementById('showerWidth')?.value) || 0);
  const height = Math.max(60, parseFloat(document.getElementById('showerHeight')?.value) || 0);
  const leftWall = Math.max(0, parseFloat(document.getElementById('wallLeft')?.value) || 0);
  const rightWall = Math.max(0, parseFloat(document.getElementById('wallRight')?.value) || 0);
  const doorWidthInput = Math.max(18, parseFloat(document.getElementById('doorWidth')?.value) || 0);
  const layout = document.getElementById('layoutType')?.value || 'inline';
  const swing = document.getElementById('doorSwing')?.value || 'left';
  const glass = document.getElementById('glassTypeSelect')?.value || '3/8"';
  const doorWidth = Math.min(doorWidthInput, width - 4);
  const fixedWidth = Math.max(0, width - doorWidth);

  const canvas = document.getElementById('showerPreview');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  if (!ctx) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const padding = 60;
  const scale = Math.min((canvas.width - padding * 2) / (width + leftWall + rightWall + 6), (canvas.height - padding * 2) / height);
  const baseX = (canvas.width - (width + leftWall + rightWall) * scale) / 2;
  const baseY = canvas.height - 55;
  const hPx = height * scale;

  const leftX = baseX + leftWall * scale;
  const doorPx = doorWidth * scale;
  const fixedPx = fixedWidth * scale;
  const yTop = baseY - hPx;

  ctx.strokeStyle = '#222';
  ctx.lineWidth = 2;
  ctx.strokeRect(leftX, yTop, width * scale, hPx);

  const doorX = swing === 'left' ? leftX : leftX + fixedPx;
  const fixedX = swing === 'left' ? leftX + doorPx : leftX;

  ctx.fillStyle = 'rgba(120, 190, 255, 0.35)';
  if (fixedPx > 0) ctx.fillRect(fixedX, yTop, fixedPx, hPx);
  ctx.fillStyle = 'rgba(80, 155, 230, 0.45)';
  ctx.fillRect(doorX, yTop, doorPx, hPx);

  ctx.strokeStyle = '#1b4f72';
  ctx.lineWidth = 3;
  const hingeX = swing === 'left' ? doorX : doorX + doorPx;
  ctx.beginPath();
  ctx.moveTo(hingeX, yTop + 12);
  ctx.lineTo(hingeX, baseY - 12);
  ctx.stroke();

  const swingDir = swing === 'left' ? 1 : -1;
  ctx.strokeStyle = '#005bbb';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.arc(hingeX, baseY - 40, doorPx * 0.75, swing === 'left' ? -1.5 : -1.65, swing === 'left' ? -0.2 : -2.95, swing !== 'left');
  ctx.stroke();
  ctx.beginPath();
  const tipX = hingeX + swingDir * doorPx * 0.74;
  const tipY = baseY - 62;
  ctx.moveTo(tipX, tipY);
  ctx.lineTo(tipX - swingDir * 8, tipY - 4);
  ctx.lineTo(tipX - swingDir * 8, tipY + 4);
  ctx.closePath();
  ctx.fillStyle = '#005bbb';
  ctx.fill();

  if (layout === 'neo') {
    ctx.strokeStyle = '#777';
    ctx.setLineDash([6, 5]);
    ctx.beginPath();
    ctx.moveTo(leftX, yTop);
    ctx.lineTo(leftX - 30, yTop - 25);
    ctx.moveTo(leftX + width * scale, yTop);
    ctx.lineTo(leftX + width * scale + 30, yTop - 25);
    ctx.stroke();
    ctx.setLineDash([]);
  } else if (layout === 'slider') {
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(leftX, yTop - 8);
    ctx.lineTo(leftX + width * scale, yTop - 8);
    ctx.stroke();
    ctx.fillStyle = '#333';
    ctx.fillRect(leftX + 8, yTop - 11, 8, 6);
    ctx.fillRect(leftX + width * scale - 16, yTop - 11, 8, 6);
  }

  ctx.fillStyle = '#111';
  ctx.font = 'bold 14px Arial';
  ctx.fillText(`Opening: ${width.toFixed(2)}" x ${height.toFixed(2)}"`, 18, 26);
  ctx.font = '12px Arial';
  ctx.fillText(`Door: ${doorWidth.toFixed(2)}" (${swing.toUpperCase()} HINGE)`, 18, 45);
  ctx.fillText(`Glass: ${glass} | Layout: ${layout.toUpperCase()}`, 18, 62);

  const areaSqFt = (width * height) / 144;
  const estWeight = areaSqFt * (glass === '1/2"' ? 6.6 : 4.9);
  const stats = document.getElementById('showerStats');
  if (stats) {
    stats.innerHTML = `
      <strong>Estimated Cut List</strong><br>
      Door Panel: ${doorWidth.toFixed(2)}" × ${height.toFixed(2)}"<br>
      Fixed Panel: ${fixedWidth.toFixed(2)}" × ${height.toFixed(2)}"<br>
      Return Walls: Left ${leftWall.toFixed(2)}" / Right ${rightWall.toFixed(2)}"<br>
      Glass Area: ${areaSqFt.toFixed(2)} sq ft &nbsp;•&nbsp; Estimated Weight: ${estWeight.toFixed(1)} lbs
    `;
  }
}

function downloadShowerPreview() {
  renderShowerDesign();
  const canvas = document.getElementById('showerPreview');
  if (!canvas) return;
  const link = document.createElement('a');
  link.download = 'shower-door-preview.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
}


window.addEventListener('DOMContentLoaded', () => {
  ['showerWidth','showerHeight','wallLeft','wallRight','doorWidth','glassTypeSelect','doorSwing','layoutType']
    .forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', renderShowerDesign);
      if (el) el.addEventListener('change', renderShowerDesign);
    });
  renderShowerDesign();
});


function showCalculatorWorkspace(mode = 'order') {
  if (typeof kympgHideAllSections === 'function') {
    kympgHideAllSections();
  }

  const calc = document.getElementById('calculator-section');
  if (calc) {
    calc.style.display = 'block';
  }

  if (typeof kympgSetHeader === 'function') {
    if (mode === 'quote') {
      kympgSetHeader('New Quote', 'Create and print a quote.', 'New Quote', 'Quote builder');
    } else {
      kympgSetHeader('New Order', 'Create an order and print ticket/invoice.', 'New Order', 'Order form');
    }
  }

  switchTab('calculator');
  setCalculatorMode(mode);
}

function setEditOrderHeader() {
  if (typeof kympgSetHeader === 'function') {
    kympgSetHeader('Edit Order', 'Update and reprint existing order paperwork.', 'Edit Order', 'Order editor');
  }
}

function setOrderActionMode(isEditingOrder) {
  const newBtn = document.getElementById('newOrderActionBtn');
  const saveBtn = document.getElementById('saveOrderActionBtn');
  const editPoBtn = document.getElementById('editPoActionBtn');

  if (newBtn) newBtn.style.display = isEditingOrder ? 'none' : '';
  if (editPoBtn) editPoBtn.style.display = isEditingOrder ? '' : 'none';
  if (saveBtn) saveBtn.textContent = 'Save Order';
}

// ===================== CUSTOMER CRUD =====================
let allCustomers = [];
let allVendors = [];

async function loadCustomers() {
  try {
    const res = await fetchApi('/api/customers');
    if (!res.ok) throw new Error('Failed to load customers');
    allCustomers = await res.json();
    renderCustomerTable(allCustomers);
  } catch (err) {
    console.error(err);
    document.getElementById('customerTableBody').innerHTML =
      '<tr><td colspan="6" style="text-align:center;">Failed to load customers.</td></tr>';
  }
}

async function loadVendors() {
  try {
    const res = await fetchApi('/api/vendors');
    if (!res.ok) throw new Error('Failed to load vendors');
    allVendors = await res.json();
    renderVendorTable(allVendors);
  } catch (err) {
    console.error(err);
    const tbody = document.getElementById('vendorTableBody');
    if (tbody) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Failed to load vendors.</td></tr>';
  }
}

function renderVendorTable(vendors) {
  const tbody = document.getElementById('vendorTableBody');
  if (!tbody) return;
  if (!vendors.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No vendors found.</td></tr>';
    return;
  }
  tbody.innerHTML = vendors.map(v => `
    <tr>
      <td>${escapeHtml(v.name || '')}</td>
      <td>${escapeHtml(v.address || '')}</td>
      <td>${escapeHtml(v.email || '')}</td>
      <td>${escapeHtml(v.phone || '')}</td>
      <td class="actions-cell">
        <button class="btn-edit" onclick="editVendor('${v.id}')">Edit</button>
        <button class="btn-delete" onclick="deleteVendor('${v.id}')">Delete</button>
      </td>
    </tr>
  `).join('');
}

function filterVendorTable() {
  const search = (document.getElementById('vendorSearch')?.value || '').toLowerCase();
  const filtered = allVendors.filter(v =>
    (v.name || '').toLowerCase().includes(search) ||
    (v.address || '').toLowerCase().includes(search) ||
    (v.email || '').toLowerCase().includes(search) ||
    (v.phone || '').toLowerCase().includes(search)
  );
  renderVendorTable(filtered);
}

function showAddVendorForm() {
  document.getElementById('vendorEditId').value = '';
  document.getElementById('vendorFormTitle').textContent = 'Add New Vendor';
  document.getElementById('vendorName').value = '';
  document.getElementById('vendorAddress').value = '';
  document.getElementById('vendorEmail').value = '';
  document.getElementById('vendorPhone').value = '';
  document.getElementById('vendorFormWrapper').style.display = 'block';
}

function cancelVendorForm() {
  document.getElementById('vendorFormWrapper').style.display = 'none';
}

function editVendor(id) {
  const vendor = allVendors.find(v => v.id === id);
  if (!vendor) return;
  document.getElementById('vendorEditId').value = id;
  document.getElementById('vendorFormTitle').textContent = 'Edit Vendor';
  document.getElementById('vendorName').value = vendor.name || '';
  document.getElementById('vendorAddress').value = vendor.address || '';
  document.getElementById('vendorEmail').value = vendor.email || '';
  document.getElementById('vendorPhone').value = vendor.phone || '';
  document.getElementById('vendorFormWrapper').style.display = 'block';
}

async function saveVendor(event) {
  event.preventDefault();
  const id = document.getElementById('vendorEditId').value;
  const payload = {
    name: document.getElementById('vendorName').value.trim(),
    address: document.getElementById('vendorAddress').value.trim(),
    email: document.getElementById('vendorEmail').value.trim(),
    phone: document.getElementById('vendorPhone').value.trim(),
  };

  const method = id ? 'PUT' : 'POST';
  const url = id ? `/api/vendors?id=${encodeURIComponent(id)}` : '/api/vendors';
  const res = await fetchApi(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  });

  if (!res.ok) {
    const err = await res.json();
    alert(err.error || 'Failed to save vendor');
    return;
  }

  cancelVendorForm();
  await loadVendors();
}

async function deleteVendor(id) {
  if (!confirm('Delete this vendor?')) return;
  const res = await fetchApi(`/api/vendors?id=${encodeURIComponent(id)}`, { method: 'DELETE' });
  if (!res.ok) {
    alert('Failed to delete vendor');
    return;
  }
  await loadVendors();
}

async function handleVendorImportFile(event) {
  const file = event.target.files?.[0];
  if (!file) return;
  const ext = file.name.split('.').pop().toLowerCase();
  let rows = [];

  if (ext === 'csv') {
    rows = parseCSVRows(await file.text());
  } else {
    await loadXLSXLib();
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    rows = XLSX.utils.sheet_to_json(sheet, { header: 1, blankrows: false, defval: '' });
  }

  if (!rows.length) return;

  const headers = rows[0].map(h => String(h).trim().toLowerCase());
  const getCol = (names) => names.map(n => headers.indexOf(n)).find(i => i >= 0) ?? -1;
  const iName = getCol(['name', 'vendor']);
  const iAddress = getCol(['address']);
  const iEmail = getCol(['email']);
  const iPhone = getCol(['phone']);

  const vendors = rows.slice(1).map(row => ({
    name: String(row[iName] || '').trim(),
    address: String(row[iAddress] || '').trim(),
    email: String(row[iEmail] || '').trim(),
    phone: String(row[iPhone] || '').trim(),
  })).filter(v => v.name);

  if (!vendors.length) {
    alert('No valid vendors found to import.');
    return;
  }

  const res = await fetchApi('/api/vendors-import', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ vendors }),
  });

  if (!res.ok) {
    const err = await res.json();
    alert(err.error || 'Vendor import failed');
    return;
  }

  await loadVendors();
  alert(`Imported ${vendors.length} vendor(s).`);
}

async function chooseVendorForPO() {
  if (!allVendors.length) {
    try { await loadVendors(); } catch (e) {}
  }
  if (!allVendors.length) {
    return (prompt('No vendors found. Enter vendor name:') || '').trim();
  }

  const options = allVendors.slice(0, 25).map((v, i) => `${i + 1}. ${v.name}`).join('\n');
  const answer = prompt(`Select vendor number, or type a new vendor name:\n\n${options}`) || '';
  const n = Number(answer);
  if (Number.isInteger(n) && n >= 1 && n <= allVendors.length) return allVendors[n - 1].name;
  return answer.trim();
}

function renderCustomerTable(customers) {
  const tbody = document.getElementById('customerTableBody');
  if (!customers.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No customers found.</td></tr>';
    return;
  }

  tbody.innerHTML = customers.map(c => `
    <tr>
      <td>${escapeHtml(c.name)}</td>
      <td>${escapeHtml(c.address || '')}</td>
      <td>${escapeHtml(c.email || '')}</td>
      <td>${escapeHtml(c.phone || '')}</td>
      <td>${escapeHtml(c.creditTerms || '')}</td>
      <td class="actions-cell">
        <button class="btn-edit" onclick="editCustomer('${c.id}')">Edit</button>
        ${canDeleteCustomers() ? `<button class="btn-delete" onclick="deleteCustomer('${c.id}')">Delete</button>` : ''}
      </td>
    </tr>
  `).join('');
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}


async function fetchApi(path, options) {
  const opts = { ...(options || {}) };
  const headers = new Headers(opts.headers || {});
  if (authToken && !headers.has('Authorization')) {
    headers.set('Authorization', `Bearer ${authToken}`);
  }
  opts.headers = headers;

  if (!path.startsWith('/api/')) {
    return fetch(path, opts);
  }

  const fallbackPath = `/.netlify/functions/${path.slice(5)}`;

  try {
    const primary = await fetch(path, opts);
    if (primary.ok) return primary;
  } catch (e) {
    // fall through to function-path fallback
  }

  return fetch(fallbackPath, opts);
}


async function parseJsonSafe(response) {
  const raw = await response.text();
  if (!raw) return {};
  try {
    return JSON.parse(raw);
  } catch (e) {
    return { error: raw };
  }
}

function filterCustomerTable() {
  const search = document.getElementById('customerSearch').value.toLowerCase();
  const filtered = allCustomers.filter(c =>
    (c.name || '').toLowerCase().includes(search) ||
    (c.address || '').toLowerCase().includes(search) ||
    (c.email || '').toLowerCase().includes(search) ||
    (c.phone || '').toLowerCase().includes(search) ||
    (c.creditTerms || '').toLowerCase().includes(search)
  );
  renderCustomerTable(filtered);
}

function showAddCustomerForm() {
  document.getElementById('custEditId').value = '';
  document.getElementById('formTitle').textContent = 'Add New Customer';
  document.getElementById('custName').value = '';
  document.getElementById('custAddress').value = '';
  document.getElementById('custEmail').value = '';
  document.getElementById('custPhone').value = '';
  document.getElementById('custCreditTerms').value = '';
  document.getElementById('customerFormWrapper').style.display = 'block';
}

function cancelCustomerForm() {
  document.getElementById('customerFormWrapper').style.display = 'none';
}

async function editCustomer(id) {
  const customer = allCustomers.find(c => c.id === id);
  if (!customer) return;

  document.getElementById('custEditId').value = id;
  document.getElementById('formTitle').textContent = 'Edit Customer';
  document.getElementById('custName').value = customer.name || '';
  document.getElementById('custAddress').value = customer.address || '';
  document.getElementById('custEmail').value = customer.email || '';
  document.getElementById('custPhone').value = customer.phone || '';
  document.getElementById('custCreditTerms').value = customer.creditTerms || '';
  document.getElementById('customerFormWrapper').style.display = 'block';
}
async function saveCustomer(event) {
  event.preventDefault();

  const id = document.getElementById('custEditId').value;
  const data = {
    name: document.getElementById('custName').value.trim(),
    address: document.getElementById('custAddress').value.trim(),
    email: document.getElementById('custEmail').value.trim(),
    phone: document.getElementById('custPhone').value.trim(),
    creditTerms: document.getElementById('custCreditTerms').value.trim(),
  };

  if (!data.name) {
    alert('Customer name is required.');
    return;
  }

  try {
    let res;
    if (id) {
      res = await fetchApi(`/api/customers?id=${encodeURIComponent(id)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
    } else {
      res = await fetchApi('/api/customers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
    }

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Failed to save customer');
    }

    cancelCustomerForm();
    await loadCustomers();
  } catch (err) {
    alert('Error saving customer: ' + err.message);
  }
}

async function deleteCustomer(id) {
  if (!canDeleteCustomers()) return alert('Only admins can delete customers.');
  if (!confirm('Are you sure you want to delete this customer?')) return;

  try {
    const res = await fetchApi(`/api/customers?id=${encodeURIComponent(id)}`, {
      method: 'DELETE',
    });
    if (!res.ok) throw new Error('Failed to delete customer');
    await loadCustomers();
  } catch (err) {
    alert('Error deleting customer: ' + err.message);
  }
}

// Phone formatter for customer form
document.getElementById('custPhone').addEventListener('input', function (e) {
  let input = e.target.value.replace(/\D/g, '');
  if (input.length > 10) input = input.substring(0, 10);

  let formatted = input;
  if (input.length > 6) {
    formatted = `(${input.substring(0,3)}) ${input.substring(3,6)}-${input.substring(6)}`;
  } else if (input.length > 3) {
    formatted = `(${input.substring(0,3)}) ${input.substring(3)}`;
  } else if (input.length > 0) {
    formatted = `(${input}`;
  }
  e.target.value = formatted;
});

// ===================== CUSTOMER LOOKUP IN CALCULATOR =====================
let calcCustomers = []; // customers loaded for calculator autocomplete
let selectedCalcCustomer = null; // currently selected customer
let calcLookupIndex = -1; // keyboard nav index

async function loadCalcCustomers() {
  try {
    const res = await fetchApi('/api/customers');
    if (!res.ok) throw new Error('Failed to load customers');
    calcCustomers = await res.json();
  } catch (err) {
    console.error('Could not load customers for autocomplete:', err);
    calcCustomers = [];
  }
}

function setupCustomerLookup() {
  const nameInput = document.getElementById('customerName');
  const lookupList = document.getElementById('customerLookupList');

  nameInput.addEventListener('input', function() {
    selectedCalcCustomer = null;
    // Make extra fields editable when no customer is selected
    setCalcCustomerFieldsReadonly(false);
    buildCalcLookupList();
  });

  nameInput.addEventListener('focus', function() {
    if (nameInput.value.trim()) {
      buildCalcLookupList();
    }
  });

  nameInput.addEventListener('keydown', function(e) {
    const items = lookupList.querySelectorAll('li');
    if (e.key === 'ArrowDown' && items.length) {
      e.preventDefault();
      calcLookupIndex = (calcLookupIndex + 1) % items.length;
      highlightCalcItem(items);
    } else if (e.key === 'ArrowUp' && items.length) {
      e.preventDefault();
      calcLookupIndex = (calcLookupIndex - 1 + items.length) % items.length;
      highlightCalcItem(items);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (lookupList.style.display === 'block' && items.length) {
        const idx = calcLookupIndex >= 0 ? calcLookupIndex : 0;
        items[idx].dispatchEvent(new Event('mousedown'));
      }
    } else if (e.key === 'Escape') {
      lookupList.style.display = 'none';
      calcLookupIndex = -1;
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!nameInput.contains(e.target) && !lookupList.contains(e.target)) {
      lookupList.style.display = 'none';
      calcLookupIndex = -1;
    }
  });
}

function buildCalcLookupList() {
  const nameInput = document.getElementById('customerName');
  const lookupList = document.getElementById('customerLookupList');
  const search = nameInput.value.toLowerCase().trim();

  lookupList.innerHTML = '';
  calcLookupIndex = -1;

  if (!search) {
    lookupList.style.display = 'none';
    return;
  }

  const matches = calcCustomers.filter(c =>
    (c.name || '').toLowerCase().includes(search)
  );

  matches.forEach(c => {
    const li = document.createElement('li');
    li.innerHTML = `${escapeHtml(c.name)}<span class="cust-detail">${escapeHtml(c.phone || '')}${c.address ? ' — ' + escapeHtml(c.address) : ''}</span>`;
    li.addEventListener('mousedown', function(e) {
      e.preventDefault();
      selectCalcCustomer(c);
    });
    lookupList.appendChild(li);
  });

  // Add "Add New Customer" option at bottom
  const addLi = document.createElement('li');
  addLi.className = 'add-new-customer';
  addLi.textContent = '+ Add "' + nameInput.value.trim() + '" as new customer';
  addLi.addEventListener('mousedown', function(e) {
    e.preventDefault();
    openQuickAddCustomer(nameInput.value.trim());
  });
  lookupList.appendChild(addLi);

  lookupList.style.display = 'block';
}

function highlightCalcItem(items) {
  items.forEach((li, idx) => {
    li.classList.toggle('active', idx === calcLookupIndex);
  });
  if (calcLookupIndex >= 0 && items[calcLookupIndex]) {
    items[calcLookupIndex].scrollIntoView({ block: 'nearest' });
  }
}

function selectCalcCustomer(customer) {
  selectedCalcCustomer = customer;
  document.getElementById('customerName').value = customer.name || '';
  document.getElementById('customerPhone').value = customer.phone || '';
  document.getElementById('calcCustAddress').value = customer.address || '';
  document.getElementById('calcCustEmail').value = customer.email || '';
  document.getElementById('calcCustCreditTerms').value = customer.creditTerms || '';
  setCalcCustomerFieldsReadonly(true);
  document.getElementById('customerLookupList').style.display = 'none';
  calcLookupIndex = -1;
}

function setCalcCustomerFieldsReadonly(readonly) {
  document.getElementById('calcCustAddress').readOnly = readonly;
  document.getElementById('calcCustEmail').readOnly = readonly;
  document.getElementById('calcCustCreditTerms').readOnly = readonly;
}

function clearCustomerInfo() {
  selectedCalcCustomer = null;
  document.getElementById('customerName').value = '';
  document.getElementById('customerPhone').value = '';
  document.getElementById('calcCustAddress').value = '';
  document.getElementById('calcCustEmail').value = '';
  document.getElementById('calcCustCreditTerms').value = '';
  setCalcCustomerFieldsReadonly(false);
  document.getElementById('customerLookupList').style.display = 'none';
}

// ===================== QUICK-ADD CUSTOMER MODAL =====================
function openQuickAddCustomer(prefillName) {
  document.getElementById('customerLookupList').style.display = 'none';
  // Check if modal already exists, if not create it
  let modal = document.getElementById('quickAddModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'quickAddModal';
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center;';
    modal.innerHTML = `
      <div style="background:white;padding:24px;border-radius:10px;width:420px;max-width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top:0;">Add New Customer</h3>
        <div style="margin-bottom:10px;">
          <label style="font-weight:bold;font-size:13px;display:block;margin-bottom:3px;">Name *</label>
          <input type="text" id="qaName" style="width:100%;padding:6px;font-size:14px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;">
        </div>
        <div style="margin-bottom:10px;">
          <label style="font-weight:bold;font-size:13px;display:block;margin-bottom:3px;">Address</label>
          <input type="text" id="qaAddress" style="width:100%;padding:6px;font-size:14px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;">
        </div>
        <div style="margin-bottom:10px;">
          <label style="font-weight:bold;font-size:13px;display:block;margin-bottom:3px;">Email</label>
          <input type="email" id="qaEmail" style="width:100%;padding:6px;font-size:14px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;">
        </div>
        <div style="margin-bottom:10px;">
          <label style="font-weight:bold;font-size:13px;display:block;margin-bottom:3px;">Phone</label>
          <input type="tel" id="qaPhone" style="width:100%;padding:6px;font-size:14px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;">
        </div>
        <div style="margin-bottom:15px;">
          <label style="font-weight:bold;font-size:13px;display:block;margin-bottom:3px;">Credit Terms</label>
          <input type="text" id="qaCreditTerms" style="width:100%;padding:6px;font-size:14px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;" placeholder="e.g. Net 30, COD, Prepaid">
        </div>
        <div style="display:flex;gap:10px;">
          <button id="qaSaveBtn" style="padding:8px 18px;font-size:14px;font-weight:bold;background:#28a745;color:white;border:none;border-radius:6px;cursor:pointer;">Save & Use</button>
          <button id="qaCancelBtn" style="padding:8px 18px;font-size:14px;font-weight:bold;background:lightgrey;color:black;border:none;border-radius:6px;cursor:pointer;">Cancel</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    // Phone formatter for modal
    document.getElementById('qaPhone').addEventListener('input', function(e) {
      let input = e.target.value.replace(/\D/g, '');
      if (input.length > 10) input = input.substring(0, 10);
      let formatted = input;
      if (input.length > 6) formatted = '(' + input.substring(0,3) + ') ' + input.substring(3,6) + '-' + input.substring(6);
      else if (input.length > 3) formatted = '(' + input.substring(0,3) + ') ' + input.substring(3);
      else if (input.length > 0) formatted = '(' + input;
      e.target.value = formatted;
    });

    document.getElementById('qaSaveBtn').addEventListener('click', saveQuickAddCustomer);
    document.getElementById('qaCancelBtn').addEventListener('click', closeQuickAddModal);
  }

  // Reset and prefill
  document.getElementById('qaName').value = prefillName || '';
  document.getElementById('qaAddress').value = '';
  document.getElementById('qaEmail').value = '';
  document.getElementById('qaPhone').value = '';
  document.getElementById('qaCreditTerms').value = '';
  modal.style.display = 'flex';
  document.getElementById('qaName').focus();
}

function closeQuickAddModal() {
  const modal = document.getElementById('quickAddModal');
  if (modal) modal.style.display = 'none';
}

async function saveQuickAddCustomer() {
  const name = document.getElementById('qaName').value.trim();
  if (!name) {
    alert('Customer name is required.');
    return;
  }

  const data = {
    name: name,
    address: document.getElementById('qaAddress').value.trim(),
    email: document.getElementById('qaEmail').value.trim(),
    phone: document.getElementById('qaPhone').value.trim(),
    creditTerms: document.getElementById('qaCreditTerms').value.trim(),
  };

  try {
    const res = await fetchApi('/api/customers', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Failed to save customer');
    }

    const newCustomer = await res.json();
    // Add to local cache
    calcCustomers.push(newCustomer);
    // Also refresh the allCustomers list so the Customers tab is in sync
    allCustomers = [...calcCustomers];

    // Select the new customer in the calculator
    selectCalcCustomer(newCustomer);
    closeQuickAddModal();
  } catch (err) {
    alert('Error saving customer: ' + err.message);
  }
}


let calculatorMode = 'quote';

function setCalculatorMode(mode) {
  calculatorMode = mode === 'order' ? 'order' : 'quote';
  const quoteButtons = document.getElementById('quoteButtons');
  const orderButtons = document.getElementById('orderButtons');
  const shopNotesField = document.getElementById('shopNotesField');
  if (quoteButtons) quoteButtons.style.display = calculatorMode === 'quote' ? 'block' : 'none';
  if (orderButtons) orderButtons.style.display = calculatorMode === 'order' ? 'block' : 'none';
  if (shopNotesField) shopNotesField.style.display = calculatorMode === 'order' ? 'block' : 'none';
}

async function saveQuote() {
  const savedQuote = await saveQuoteToDatabase({ showMessage: false });
  if (!savedQuote) return;

  const quoteLabel = savedQuote.quoteNumber || savedQuote.id;
  const printNow = await showYesNoModal(
    `Quote ${quoteLabel} saved successfully.`,
    'Print',
    'No'
  );

  if (printNow) {
    await printQuote(savedQuote.id);
  }

  prepareForNewQuote();
}


function showYesNoModal(message, yesLabel = 'Yes', noLabel = 'No') {
  return new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999;';

    const modal = document.createElement('div');
    modal.style.cssText = 'background:#fff;padding:20px 24px;border-radius:10px;max-width:420px;width:calc(100% - 32px);text-align:center;box-shadow:0 12px 30px rgba(0,0,0,0.22);';

    const text = document.createElement('p');
    text.textContent = message;
    text.style.cssText = 'margin:0 0 16px 0;font-size:16px;line-height:1.4;';

    const actions = document.createElement('div');
    actions.style.cssText = 'display:flex;justify-content:center;gap:10px;';

    const yesBtn = document.createElement('button');
    yesBtn.type = 'button';
    yesBtn.textContent = yesLabel;

    const noBtn = document.createElement('button');
    noBtn.type = 'button';
    noBtn.textContent = noLabel;

    function close(result) {
      overlay.remove();
      resolve(result);
    }

    yesBtn.addEventListener('click', () => close(true));
    noBtn.addEventListener('click', () => close(false));
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) close(false);
    });

    actions.appendChild(yesBtn);
    actions.appendChild(noBtn);
    modal.appendChild(text);
    modal.appendChild(actions);
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    yesBtn.focus();
  });
}

function showCenteredMessage(message, timeoutMs = 2200) {
  const existing = document.getElementById('kympg-centered-message');
  if (existing) existing.remove();

  const box = document.createElement('div');
  box.id = 'kympg-centered-message';
  box.style.cssText = [
    'position:fixed',
    'left:50%',
    'top:50%',
    'transform:translate(-50%,-50%)',
    'background:rgba(0,0,0,0.82)',
    'color:#fff',
    'padding:14px 20px',
    'border-radius:10px',
    'font-size:16px',
    'font-weight:700',
    'z-index:20000',
    'box-shadow:0 10px 30px rgba(0,0,0,0.3)',
    'max-width:80vw',
    'text-align:center'
  ].join(';');
  box.textContent = String(message || '');
  document.body.appendChild(box);
  setTimeout(() => box.remove(), timeoutMs);
}

function showPOTypeModal() {
  return new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999;';

    const modal = document.createElement('div');
    modal.style.cssText = 'background:#fff;padding:20px 24px;border-radius:10px;max-width:460px;width:calc(100% - 32px);text-align:center;box-shadow:0 12px 30px rgba(0,0,0,0.22);';
    modal.innerHTML = `
      <p style="margin:0 0 16px 0;font-size:16px;line-height:1.4;">Choose PO type for this new order:</p>
      <div style="display:flex;justify-content:center;gap:10px;flex-wrap:wrap;">
        <button id="poTypeInternal" type="button">Internal PO</button>
        <button id="poTypeExternal" type="button">External PO</button>
        <button id="poTypeNone" type="button">No PO</button>
      </div>
    `;

    function close(value) {
      overlay.remove();
      resolve(value);
    }

    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    modal.querySelector('#poTypeInternal').addEventListener('click', () => close('internal'));
    modal.querySelector('#poTypeExternal').addEventListener('click', () => close('external'));
    modal.querySelector('#poTypeNone').addEventListener('click', () => close('none'));
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) close('none');
    });
  });
}

function showPODetailsModal(poType, vendors = []) {
  return new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999;';

    const modal = document.createElement('div');
    modal.style.cssText = 'background:#fff;padding:20px 24px;border-radius:10px;max-width:560px;width:calc(100% - 32px);text-align:left;box-shadow:0 12px 30px rgba(0,0,0,0.22);';

    const vendorOptions = vendors.map(v => `<option value="${escapeHtml(v.name)}">${escapeHtml(v.name)}</option>`).join('');
    const isExternal = poType === 'external';
    modal.innerHTML = `
      <h3 style="margin:0 0 12px 0;">${isExternal ? 'External' : 'Internal'} PO Details</h3>
      ${isExternal ? `<label style="display:block;font-weight:bold;margin:8px 0 4px 0;">Vendor</label>
      <select id="poVendorSelect" style="width:100%;padding:8px;">
        <option value="">-- Select Vendor --</option>
        ${vendorOptions}
      </select>
      <button id="poAddVendorBtn" type="button" style="margin-top:8px;">+ Add Vendor</button>
      <div id="poAddVendorFields" style="display:none;margin-top:8px;border:1px solid #ddd;border-radius:8px;padding:10px;">
        <label style="display:block;font-weight:bold;margin:4px 0;">Name *</label>
        <input id="newVendorName" type="text" style="width:100%;padding:8px;" placeholder="Vendor name">
        <label style="display:block;font-weight:bold;margin:8px 0 4px 0;">Address *</label>
        <input id="newVendorAddress" type="text" style="width:100%;padding:8px;" placeholder="Address">
        <label style="display:block;font-weight:bold;margin:8px 0 4px 0;">Email *</label>
        <input id="newVendorEmail" type="email" style="width:100%;padding:8px;" placeholder="Email">
        <label style="display:block;font-weight:bold;margin:8px 0 4px 0;">Phone *</label>
        <input id="newVendorPhone" type="text" style="width:100%;padding:8px;" placeholder="Phone">
      </div>` : `<p style="margin:6px 0 10px 0;">Internal PO number will be generated from order # (example: PO1000).</p>`}
      ${isExternal ? `<label style="display:block;font-weight:bold;margin:8px 0 4px 0;">Vendor PO #</label>
      <input id="poNumberInput" type="text" style="width:100%;padding:8px;" placeholder="Enter vendor PO #">` : ''}
      <label style="display:block;font-weight:bold;margin:8px 0 4px 0;">Requested Date</label>
      <input id="poRequestedDate" type="date" style="width:100%;padding:8px;" value="${new Date().toISOString().slice(0,10)}">
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px;">
        <button id="poDetailsCancel" type="button">Cancel</button>
        <button id="poDetailsSave" type="button">Continue</button>
      </div>
    `;

    function close(value) {
      overlay.remove();
      resolve(value);
    }

    if (isExternal) {
      modal.querySelector('#poAddVendorBtn')?.addEventListener('click', () => {
        const fields = modal.querySelector('#poAddVendorFields');
        if (fields) fields.style.display = fields.style.display === 'none' ? 'block' : 'none';
      });
    }

    modal.querySelector('#poDetailsCancel').addEventListener('click', () => close(null));
    modal.querySelector('#poDetailsSave').addEventListener('click', async () => {
      const requestedDate = modal.querySelector('#poRequestedDate')?.value || '';
      if (!requestedDate) {
        alert('Requested date is required.');
        return;
      }
      if (isExternal) {
        const selected = modal.querySelector('#poVendorSelect')?.value?.trim() || '';
        const vendorPoNumber = modal.querySelector('#poNumberInput')?.value?.trim() || '';

        let vendorName = selected;
        const addFieldsVisible = modal.querySelector('#poAddVendorFields')?.style.display !== 'none';
        if (!vendorName && addFieldsVisible) {
          const payload = {
            name: (modal.querySelector('#newVendorName')?.value || '').trim(),
            address: (modal.querySelector('#newVendorAddress')?.value || '').trim(),
            email: (modal.querySelector('#newVendorEmail')?.value || '').trim(),
            phone: (modal.querySelector('#newVendorPhone')?.value || '').trim(),
          };
          if (!payload.name || !payload.address || !payload.email || !payload.phone) {
            alert('New vendor requires Name, Address, Email, and Phone.');
            return;
          }
          const saveRes = await fetchApi('/api/vendors', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!saveRes.ok) {
            const err = await parseJsonSafe(saveRes);
            alert(err.error || 'Failed to add vendor.');
            return;
          }
          const savedVendor = await parseJsonSafe(saveRes);
          vendorName = savedVendor.name || payload.name;
          try { await loadVendors(); } catch (e) {}
        }

        if (!vendorName || !vendorPoNumber) {
          alert('Vendor (from list) and Vendor PO # are required.');
          return;
        }
        close({ vendorName, vendorPoNumber, requestedDate });
        return;
      }
      close({ vendorName: 'Kentucky Mirror and Plate Glass (Internal Shop)', vendorPoNumber: '', requestedDate });
    });

    overlay.appendChild(modal);
    document.body.appendChild(overlay);
  });
}

async function editPurchaseOrder(id) {
  try {
    if (!allVendors.length) {
      try { await loadVendors(); } catch (e) {}
    }

    const res = await fetchApi(`/api/purchase-orders?id=${encodeURIComponent(id)}`);
    if (!res.ok) throw new Error('Failed to load PO');
    const po = await res.json();

    const overlay = document.createElement('div');
    overlay.className = 'order-detail-modal-overlay';
    overlay.style.zIndex = '10000';

    const vendorOptions = allVendors
      .map(v => `<option value="${escapeHtml(v.name)}" ${v.name === po.vendor ? 'selected' : ''}>${escapeHtml(v.name)}</option>`)
      .join('');

    const modal = document.createElement('div');
    modal.className = 'order-detail-modal';
    modal.style.maxWidth = '900px';
    modal.innerHTML = `
      <h3 style="margin-top:0;">PURCHASE ORDER ${escapeHtml(po.poNumber || '')}</h3>
      <div class="order-detail-info" style="grid-template-columns:repeat(3,minmax(160px,1fr)); gap:10px;">
        <div><strong>PO #</strong><input id="editPoNumber" type="text" value="${escapeHtml(po.poNumber || '')}" style="width:100%;"></div>
        <div><strong>Order #</strong><input id="editPoOrderNumber" type="text" value="${escapeHtml(po.orderNumber || '')}" style="width:100%;"></div>
        <div><strong>PO Type</strong>
          <select id="editPoType" style="width:100%;">
            <option value="external" ${String(po.poType || '').toLowerCase()==='external'?'selected':''}>External</option>
            <option value="internal" ${String(po.poType || '').toLowerCase()==='internal'?'selected':''}>Internal</option>
          </select>
        </div>

        <div><strong>Date Ordered</strong><input id="editPoDateOrdered" type="date" value="${(po.dateOrdered || '').slice(0,10)}" style="width:100%;"></div>
        <div><strong>Requested Date</strong><input id="editPoRequestedDate" type="date" value="${(po.requestedDate || '').slice(0,10)}" style="width:100%;"></div>
        <div><strong>Estimated Delivery</strong><input id="editPoDeliveryDate" type="date" value="${(po.deliveryDate || '').slice(0,10)}" style="width:100%;"></div>

        <div><strong>Received Date</strong><input id="editPoReceivedAt" type="date" value="${(po.receivedAt || '').slice(0,10)}" style="width:100%;"></div>
        <div><strong>Status</strong>
          <select id="editPoStatus" style="width:100%;">
            <option value="Pending" ${po.status==='Pending'?'selected':''}>Pending</option>
            <option value="In Progress" ${po.status==='In Progress'?'selected':''}>In Progress</option>
            <option value="Received" ${po.status==='Received'?'selected':''}>Received</option>
            <option value="Completed by Shop" ${po.status==='Completed by Shop'?'selected':''}>Completed by Shop</option>
          </select>
        </div>
        <div><strong>Vendor</strong>
          <select id="editPoVendorSelect" style="width:100%;">
            <option value="">-- Select Vendor --</option>
            ${vendorOptions}
          </select>
          <button id="editPoAddVendorBtn" type="button" style="margin-top:6px;">+ Add Vendor</button>
        </div>
      </div>

      <div id="editPoAddVendorFields" style="display:none;margin-top:10px;border:1px solid #ddd;border-radius:8px;padding:10px;">
        <strong>Add New Vendor</strong>
        <div style="display:grid;grid-template-columns:repeat(2,minmax(180px,1fr));gap:8px;margin-top:8px;">
          <input id="editNewVendorName" type="text" placeholder="Name *" style="width:100%;padding:8px;">
          <input id="editNewVendorPhone" type="text" placeholder="Phone *" style="width:100%;padding:8px;">
          <input id="editNewVendorAddress" type="text" placeholder="Address *" style="width:100%;padding:8px;">
          <input id="editNewVendorEmail" type="email" placeholder="Email *" style="width:100%;padding:8px;">
        </div>
      </div>

      <div style="margin-top:10px;">
        <strong>PO Line Items</strong>
        <div style="font-size:12px;color:#666;margin:4px 0 8px 0;">TO UPDATE ITEMS ON PO PLEASE UPDATE THE ORDER.</div>
        <table style="width:100%;border-collapse:collapse;">
          <thead><tr><th style="width:60px;">#</th><th>Description</th><th style="width:80px;">Qty</th></tr></thead>
          <tbody>
            ${(Array.isArray(po.items) && po.items.length) ? po.items.map((it, idx) => `<tr><td>${idx + 1}</td><td>${escapeHtml(it.description || it.name || '')}</td><td>${escapeHtml(it.qty || '')}</td></tr>`).join('') : '<tr><td colspan="3">No line items</td></tr>'}
          </tbody>
        </table>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:15px;">
        <button id="editPoCancel" type="button">Cancel</button>
        <button id="editPoSave" type="button">Save PO</button>
      </div>
    `;

    function close() { overlay.remove(); }

    modal.querySelector('#editPoAddVendorBtn')?.addEventListener('click', () => {
      const fields = modal.querySelector('#editPoAddVendorFields');
      if (fields) fields.style.display = fields.style.display === 'none' ? 'block' : 'none';
    });

    modal.querySelector('#editPoCancel')?.addEventListener('click', close);

    modal.querySelector('#editPoSave')?.addEventListener('click', async () => {
      try {
        let vendor = (modal.querySelector('#editPoVendorSelect')?.value || '').trim();
        const addFieldsVisible = modal.querySelector('#editPoAddVendorFields')?.style.display !== 'none';

        if (!vendor && addFieldsVisible) {
          const payload = {
            name: (modal.querySelector('#editNewVendorName')?.value || '').trim(),
            address: (modal.querySelector('#editNewVendorAddress')?.value || '').trim(),
            email: (modal.querySelector('#editNewVendorEmail')?.value || '').trim(),
            phone: (modal.querySelector('#editNewVendorPhone')?.value || '').trim(),
          };
          if (!payload.name || !payload.address || !payload.email || !payload.phone) {
            alert('New vendor requires Name, Address, Email, and Phone.');
            return;
          }
          const saveRes = await fetchApi('/api/vendors', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!saveRes.ok) {
            const err = await parseJsonSafe(saveRes);
            alert(err.error || 'Failed to add vendor.');
            return;
          }
          const savedVendor = await parseJsonSafe(saveRes);
          vendor = savedVendor.name || payload.name;
          try { await loadVendors(); } catch (e) {}
        }

        if (!vendor) {
          alert('Vendor must be selected from list or added with required fields.');
          return;
        }

        const body = {
          vendor,
          poNumber: (modal.querySelector('#editPoNumber')?.value || '').trim(),
          orderNumber: (modal.querySelector('#editPoOrderNumber')?.value || '').trim(),
          poType: (modal.querySelector('#editPoType')?.value || 'external').trim(),
          dateOrdered: modal.querySelector('#editPoDateOrdered')?.value || '',
          requestedDate: modal.querySelector('#editPoRequestedDate')?.value || '',
          deliveryDate: modal.querySelector('#editPoDeliveryDate')?.value || '',
          receivedAt: modal.querySelector('#editPoReceivedAt')?.value || '',
          status: modal.querySelector('#editPoStatus')?.value || 'Pending',
        };

        const updateRes = await fetchApi(`/api/purchase-orders?id=${encodeURIComponent(id)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        if (!updateRes.ok) {
          const err = await parseJsonSafe(updateRes);
          alert(err.error || 'Failed to update purchase order.');
          return;
        }

        close();
        await loadPurchaseOrders();
        try { if (typeof loadOrders === 'function') await loadOrders(); } catch (e) {}
      } catch (err) {
        alert('Failed to save purchase order: ' + err.message);
      }
    });

    modal.addEventListener('click', (e) => e.stopPropagation());
    overlay.addEventListener('click', (e) => { if (e.target === overlay) close(); });
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
  } catch (err) {
    alert('Failed to edit purchase order: ' + err.message);
  }
}


async function printQuote(quoteId) {
  const idToPrint = quoteId || currentQuoteId || lastSavedQuoteId;
  if (!idToPrint) {
    alert('Please save the quote first, then print.');
    return;
  }

  try {
    const res = await fetchApi(`/api/quotes?id=${encodeURIComponent(idToPrint)}`);
    if (!res.ok) throw new Error(res.status === 404 ? 'You must save first.' : 'Quote not found');
    const quote = await res.json();

    const printWindow = window.open('', '_blank');
    if (!printWindow) return;

    const items = quote.items || [];
    const cust = quote.customer || {};
    const quoteNotes = quote.customerNotes || quote.notes || '';

    printWindow.document.write('<html><head><title>Quote</title>');
    printWindow.document.write('<style>body{font-family:Arial,sans-serif;padding:24px;}table{width:100%;border-collapse:collapse;margin-top:12px;}th,td{border:1px solid #000;padding:8px;text-align:center;}h2,h3{margin:0 0 8px 0;}</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(`<div style="display:flex;gap:12px;align-items:center;margin-bottom:10px;"><img src="/good%20logo.jpg" style="height:56px;width:auto;"><div><div>822 W Main St, Louisville KY 40202</div><div>502-583-5541 | info@kymirror.com</div></div></div>`);
    printWindow.document.write(`<h2>QUOTE ${escapeHtml(quote.quoteNumber || quote.id || '')}</h2>`);
    printWindow.document.write(`<p><strong>Customer:</strong> ${escapeHtml(cust.name || quote.customerName || '')} &nbsp; <strong>Phone:</strong> ${escapeHtml(cust.phone || quote.customerPhone || '')}</p>`);
    printWindow.document.write('<table><thead><tr><th>Qty</th><th>Size</th><th>Glass Type</th></tr></thead><tbody>');
    items.forEach(item => {
      printWindow.document.write(`<tr><td>${item.qty || 1}</td><td>${escapeHtml(`${item.width || ''} x ${item.height || ''}`)}</td><td>${escapeHtml(item.glassType || '')}</td></tr>`);
    });
    printWindow.document.write('</tbody></table>');
    if (quoteNotes) {
      printWindow.document.write(`<div style="margin-top:12px;border:1px solid #000;padding:8px;"><strong>Customer Notes:</strong><br>${escapeHtml(quoteNotes)}</div>`);
    }
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    try {
      await waitForPrintableImages(printWindow.document);
    } catch (e) {
      console.warn('Quote print image wait warning', e);
    }
    printWindow.print();
  } catch (err) {
    alert('Error printing quote: ' + err.message);
  }
}

async function convertToOrder() {
  await convertCurrentQuoteToOrder();
}

// ===================== ORDER MANAGEMENT =====================
let currentOrderId = null;      // currently loaded order in the form (null = unsaved / new)
let lastSavedOrderId = null;    // last saved order id (kept even after clearing the form)
let currentQuoteId = null;
let lastSavedQuoteId = null;

function startNewOrder() {
  currentOrderId = null;
  document.getElementById('currentOrderNumber').textContent = 'Will be assigned on save';
  document.getElementById('orderSavedStatus').textContent = '';
  setOrderActionMode(false);
  currentQuoteId = null;

  // Clear the form
  document.getElementById('glassTableBody').innerHTML = '';
  for (let i = 0; i < 5; i++) addRow();
  updateTotals();
  clearCustomerInfo();
  clearHardware();
  const customerNotesEl = document.getElementById('customerNotes');
  const shopNotesEl = document.getElementById('shopNotes');
  if (customerNotesEl) customerNotesEl.value = '';
  if (shopNotesEl) shopNotesEl.value = '';
}

function prepareForNewQuote() {
  startNewOrder();
  setCalculatorMode('quote');
  lastSavedOrderId = null;
}

let printQueue = Promise.resolve();

function waitForPrintableImages(doc) {
  const images = Array.from(doc?.images || []);
  if (!images.length) return Promise.resolve();

  return Promise.all(images.map(img => {
    if (img.complete) return Promise.resolve();
    return new Promise(resolve => {
      const done = () => resolve();
      img.addEventListener('load', done, { once: true });
      img.addEventListener('error', done, { once: true });
      setTimeout(done, 1200);
    });
  }));
}

async function printUrlInHiddenFrame(url) {
  const res = await fetchApi(url);
  if (!res.ok) {
    if (res.status === 404) throw new Error('You must save first.');
    throw new Error(`Print request failed (${res.status})`);
  }
  const html = await res.text();

  await new Promise((resolve) => {
    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.right = '0';
    iframe.style.bottom = '0';
    iframe.style.width = '0';
    iframe.style.height = '0';
    iframe.style.border = '0';
    iframe.style.visibility = 'hidden';
    iframe.onload = () => {
      setTimeout(async () => {
        try {
          await waitForPrintableImages(iframe.contentDocument);
          iframe.contentWindow?.focus();
          iframe.contentWindow?.print();
        } catch (e) {
          console.error('Print frame error', e);
        }
        setTimeout(() => {
          iframe.remove();
          resolve();
        }, 700);
      }, 150);
    };
    iframe.srcdoc = html;
    document.body.appendChild(iframe);
  });
}

function queuePrintUrl(url) {
  printQueue = printQueue
    .then(() => printUrlInHiddenFrame(url))
    .catch((err) => {
      console.error(err);
      alert('Print failed: ' + err.message);
    });
  return printQueue;
}

function printDoc(type) {
  const idToPrint = currentOrderId || lastSavedOrderId;

  if (!idToPrint) {
    alert("Please save the order first, then print.");
    return;
  }

  const url = `/api/orders?id=${encodeURIComponent(idToPrint)}&print=${encodeURIComponent(type)}`;
  queuePrintUrl(url);
}

async function deleteCurrentOrder() {
  if (!canDeleteOrders()) return alert('Only admins can delete orders.');
  const idToDelete = currentOrderId || lastSavedOrderId;
  if (!idToDelete) {
    alert('No saved order available to delete.');
    return;
  }
  const deleted = await deleteOrder(idToDelete);
  if (deleted && (currentOrderId === idToDelete || lastSavedOrderId === idToDelete)) {
    currentOrderId = null;
    lastSavedOrderId = null;
    startNewOrder();
  }
}

function gatherOrderData() {
  // Gather customer info
  const customer = {
    name: document.getElementById('customerName').value.trim(),
    phone: document.getElementById('customerPhone').value.trim(),
    address: document.getElementById('calcCustAddress').value.trim(),
    email: document.getElementById('calcCustEmail').value.trim(),
    creditTerms: document.getElementById('calcCustCreditTerms').value.trim(),
  };
  if (selectedCalcCustomer) {
    customer.customerId = selectedCalcCustomer.id;
  }

  // Gather glass line items
  const items = [];
  const rows = document.querySelectorAll('#glassTableBody tr');
  rows.forEach(row => {
    const glassType = row.querySelector('.glassTypeInput')?.value || '';
    if (!glassType.trim()) return; // skip empty rows

    items.push({
      qty: parseInt(row.querySelector('.qty')?.value) || 1,
      width: row.querySelector('.width')?.value || '',
      height: row.querySelector('.height')?.value || '',
      glassType: glassType,
      bevel: row.querySelector('.bevel')?.checked || false,
      bevelWidth: row.querySelector('.bevelWidth')?.value || '1/2',
      shape: row.querySelector('.shape')?.checked || false,
      eachPrice: row.querySelector('.eachPrice')?.innerText || '$0.00',
      lineTotal: row.querySelector('.lineTotal')?.innerText || '$0.00',
    });
  });

  // Gather hardware rows
  const hardwareItems = Array.from(document.querySelectorAll('#hardwareTableBody tr')).map(row => {
    const name = (row.querySelector('.hw-part')?.value || '').trim();
    const rawQty = parseInt(row.querySelector('.hw-qty')?.value, 10);
    const qty = Number.isFinite(rawQty) && rawQty > 0 ? rawQty : (name ? 1 : 0);
    const unitPriceText = row.querySelector('.hw-price')?.innerText || '$0.00';
    const lineTotalText = row.querySelector('.hw-total')?.innerText || '$0.00';
    const unitMatch = unitPriceText.match(/\$([\d.]+)/);
    const lineMatch = lineTotalText.match(/\$([\d.]+)/);
    return {
      qty,
      name,
      price: unitMatch ? parseFloat(unitMatch[1]) : 0,
      total: lineMatch ? parseFloat(lineMatch[1]) : 0,
    };
  }).filter(item => item.qty > 0 && item.name);

  const hardwareTotal = hardwareItems.reduce((sum, item) => sum + item.total, 0);
  const hardware = hardwareItems.length
    ? { name: hardwareItems.length === 1 ? hardwareItems[0].name : 'Multiple hardware items', price: hardwareTotal }
    : null;

  // Totals
  const grandTotalText = document.getElementById('grandTotal').innerText;
  const grandTotalTaxText = document.getElementById('grandTotalTax').innerText;
  const gtMatch = grandTotalText.match(/\$([\d,.]+)/);
  const gttMatch = grandTotalTaxText.match(/\$([\d,.]+)/);
  const grandTotal = gtMatch ? parseFloat(gtMatch[1].replace(/,/g, '')) : 0;
  const grandTotalWithTax = gttMatch ? parseFloat(gttMatch[1].replace(/,/g, '')) : 0;

  const specialPricing = document.getElementById('specialPricingToggle').checked;
  const customerNotes = (document.getElementById('customerNotes')?.value || '').trim();
  const shopNotes = (document.getElementById('shopNotes')?.value || '').trim();

  return { customer, items, hardware, hardwareItems, specialPricing, grandTotal, grandTotalWithTax, customerNotes, shopNotes, notes: customerNotes };
}

async function saveQuoteToDatabase(options = {}) {
  const { showMessage = true } = options;
  const data = gatherOrderData();
  const isNewOrder = !currentOrderId;

  if (!data.customer.name) {
    alert('Please enter a customer name before saving the quote.');
    return null;
  }

  if (data.items.length === 0) {
    alert('Please add at least one glass line item before saving the quote.');
    return null;
  }

  const payload = {
    ...data,
    customerName: data.customer.name,
    customerPhone: data.customer.phone,
    status: 'quote',
  };

  const method = currentQuoteId ? 'PUT' : 'POST';
  const url = currentQuoteId ? `/api/quotes?id=${encodeURIComponent(currentQuoteId)}` : '/api/quotes';

  const res = await fetchApi(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  });

  if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error || 'Failed to save quote');
  }

  const savedQuote = await res.json();
  currentQuoteId = savedQuote.id;
  lastSavedQuoteId = savedQuote.id;
  document.getElementById('orderSavedStatus').textContent = '';
  document.getElementById('currentOrderNumber').textContent = savedQuote.quoteNumber || savedQuote.id;
  if (showMessage) {
    showCenteredMessage(`QUOTE SAVED: ${savedQuote.quoteNumber || savedQuote.id}`);
  }

  try { await loadQuotes(); } catch (e) {}
  return savedQuote;
}

async function convertCurrentQuoteToOrder() {
  try {
    const savedQuote = await saveQuoteToDatabase({ showMessage: false });
    if (!savedQuote) return;

    const data = gatherOrderData();
    data.status = 'shop production';
    data.sequenceNumber = savedQuote.sequenceNumber;
    data.requiresPoSetup = true;

    const orderRes = await fetchApi('/api/orders', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });

    if (!orderRes.ok) {
      const err = await orderRes.json();
      throw new Error(err.error || 'Failed to convert quote to order');
    }

    const createdOrder = await orderRes.json();

    await fetchApi(`/api/quotes?id=${encodeURIComponent(savedQuote.id)}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: 'closed as ordered', convertedOrderId: createdOrder.id, closedReason: 'ordered' }),
    });

    setCalculatorMode('order');
    currentOrderId = createdOrder.id;
    lastSavedOrderId = createdOrder.id;
    currentQuoteId = null;
    document.getElementById('currentOrderNumber').textContent = createdOrder.orderNumber;
    document.getElementById('orderSavedStatus').textContent = '';

    try { await loadOrders(); } catch (e) {}
    try { await loadQuotes(); } catch (e) {}
    showCenteredMessage(`QUOTE CONVERTED TO ORDER ${createdOrder.orderNumber}. QUOTE CLOSED AS ORDERED.`);
    try { await loadOrderIntoCalculator(createdOrder.id); } catch (e) {}
  } catch (err) {
    alert('Error converting quote: ' + err.message);
  }
}


function buildPoItemsFromOrderItems(items = []) {
  return (Array.isArray(items) ? items : []).map(it => ({
    qty: it.qty || it.quantity || 1,
    description: [it.glassType || it.type || 'ITEM', (it.width && it.height) ? `${it.width} X ${it.height}` : ''].filter(Boolean).join(' '),
    unitPrice: 0,
    total: 0,
  }));
}

function normalizePoItemsForCompare(items = []) {
  return (Array.isArray(items) ? items : []).map(it => ({
    qty: Number(it.qty || it.quantity || 0),
    description: String(it.description || it.name || '').trim().toUpperCase(),
  }));
}

function normalizeOrderForPoPrompt(order = {}) {
  const customer = order.customer || {};
  return {
    customerName: String(customer.name || '').trim().toUpperCase(),
    customerPhone: String(customer.phone || '').trim().toUpperCase(),
    customerAddress: String(customer.address || '').trim().toUpperCase(),
    customerEmail: String(customer.email || '').trim().toUpperCase(),
    customerTerms: String(customer.creditTerms || '').trim().toUpperCase(),
    customerNotes: String(order.customerNotes || order.notes || '').trim().toUpperCase(),
    shopNotes: String(order.shopNotes || '').trim().toUpperCase(),
    requestedDate: String(order.requestedDate || '').slice(0, 10),
    vendorName: String(order.vendorName || '').trim().toUpperCase(),
    vendorPoNumber: String(order.vendorPoNumber || '').trim().toUpperCase(),
    items: normalizePoItemsForCompare(order.items || []),
    hardwareItems: (Array.isArray(order.hardwareItems) ? order.hardwareItems : []).map(h => ({
      qty: Number(h.qty || 0),
      name: String(h.name || '').trim().toUpperCase(),
    })),
  };
}

async function saveOrder() {
  const data = gatherOrderData();
  const isNewOrder = !currentOrderId;
  const previousOrder = isNewOrder ? null : (allOrders.find(o => o.id === currentOrderId) || null);
  const needsInitialOrderWorkflow = !isNewOrder && !!previousOrder?.requiresPoSetup;
  const hasAnyOrderChanges = !isNewOrder && JSON.stringify(normalizeOrderForPoPrompt(previousOrder || {})) !== JSON.stringify(normalizeOrderForPoPrompt({
    ...previousOrder,
    customer: data.customer,
    customerNotes: data.customerNotes,
    notes: data.customerNotes,
    shopNotes: data.shopNotes,
    requestedDate: data.requestedDate || previousOrder?.requestedDate || '',
    vendorName: data.vendorName || previousOrder?.vendorName || '',
    vendorPoNumber: data.vendorPoNumber || previousOrder?.vendorPoNumber || '',
    items: data.items,
    hardwareItems: data.hardwareItems,
  }));

  if (!data.customer.name) {
    alert('Please enter a customer name before saving the order.');
    return;
  }

  if (data.items.length === 0) {
    alert('Please add at least one glass line item before saving the order.');
    return;
  }

  let sourceType = 'shop production';
  let vendorName = '';
  let vendorPoNumber = '';
  let requestedDate = '';

  let poType = '';
  if (isNewOrder || needsInitialOrderWorkflow) {
    poType = await showPOTypeModal();
    if (poType === 'external' || poType === 'internal') {
      sourceType = poType === 'external' ? 'on order (vendor)' : 'shop production';
      const details = await showPODetailsModal(poType, allVendors);
      if (!details) return;
      vendorName = details.vendorName || '';
      vendorPoNumber = details.vendorPoNumber || '';
      requestedDate = details.requestedDate || '';
      if (!vendorName.trim() || !requestedDate) {
        alert('PO details are required when issuing a PO.');
        return;
      }
    }
  } else if ((allOrders.find(o => o.id === currentOrderId)?.status || '').includes('(vendor)')) {
    sourceType = 'on order (vendor)';
    vendorName = allOrders.find(o => o.id === currentOrderId)?.vendorName || '';
    vendorPoNumber = allOrders.find(o => o.id === currentOrderId)?.vendorPoNumber || '';
    requestedDate = allOrders.find(o => o.id === currentOrderId)?.requestedDate || '';
  }

  data.status = sourceType;
  data.vendorName = vendorName;
  data.vendorPoNumber = vendorPoNumber;
  data.requestedDate = requestedDate;
  if (needsInitialOrderWorkflow) data.requiresPoSetup = false;

  const saveBtn = document.querySelector('.btn-save-order');
  saveBtn.disabled = true;
  saveBtn.textContent = 'Saving...';

  try {
    const method = currentOrderId ? 'PUT' : 'POST';
    const url = currentOrderId ? `/api/orders?id=${encodeURIComponent(currentOrderId)}` : '/api/orders';
    const res = await fetchApi(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Failed to save order');
    }

    const savedOrder = await res.json();

    currentOrderId = savedOrder.id;
    lastSavedOrderId = savedOrder.id;

    if (poType === 'internal') {
      const poNumberGenerated = `PO${String(savedOrder.orderNumber || '').replace(/^o/i, '')}`;
      vendorPoNumber = poNumberGenerated;
      await fetchApi(`/api/orders?id=${encodeURIComponent(savedOrder.id)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status: 'shop production',
          vendorName,
          vendorPoNumber,
          requestedDate,
        }),
      });
    }

    if (poType === 'external' || poType === 'internal') {
      const newPoItems = buildPoItemsFromOrderItems(data.items || []);
      const poPayload = {
        orderId: savedOrder.id,
        orderNumber: savedOrder.orderNumber,
        poNumber: vendorPoNumber,
        vendor: vendorName,
        poType,
        requestedDate,
        dateOrdered: savedOrder.createdAt,
        status: 'Pending',
        shopNotes: data.shopNotes || '',
        items: newPoItems,
      };
      await fetchApi('/api/purchase-orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(poPayload),
      });

      if (poType === 'external' && Array.isArray(data.hardwareItems) && data.hardwareItems.length) {
        const internalHardwarePo = `PO${String(savedOrder.orderNumber || '').replace(/^o/i, '')}-H`;
        const internalPoRes = await fetchApi('/api/purchase-orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            orderId: savedOrder.id,
            orderNumber: savedOrder.orderNumber,
            poNumber: internalHardwarePo,
            vendor: 'Kentucky Mirror and Plate Glass (Internal Shop)',
            poType: 'internal',
            requestedDate,
            dateOrdered: savedOrder.createdAt,
            status: 'Pending',
            syncToOrder: false,
            shopNotes: data.shopNotes || '',
            items: data.hardwareItems.map(h => ({ qty: h.qty, description: h.name, unitPrice: h.price, total: h.total })),
          }),
        });
        if (internalPoRes.ok) {
          const internalPo = await internalPoRes.json();
          if (internalPo?.id) {
            await queuePrintUrl(`/api/purchase-orders?id=${encodeURIComponent(internalPo.id)}&print=1`);
          }
        }
      }

      await queuePrintUrl(`/api/orders?id=${encodeURIComponent(savedOrder.id)}&print=purchase-order`);
      await queuePrintUrl(`/api/orders?id=${encodeURIComponent(savedOrder.id)}&print=packing-list`);
    } else if (isNewOrder || needsInitialOrderWorkflow) {
      await queuePrintUrl(`/api/orders?id=${encodeURIComponent(savedOrder.id)}&print=ticket`);
    }


    if (!isNewOrder) {
      try {
        let poReprintedFromChange = false;
        const poListRes = await fetchApi('/api/purchase-orders');
        if (poListRes.ok) {
          const poList = await poListRes.json();
          const linkedPoCandidates = (poList || []).filter(p => p.orderId === savedOrder.id && p.syncToOrder !== false);
          const linkedPo = linkedPoCandidates.find(p => (savedOrder.vendorPoNumber ? p.poNumber === savedOrder.vendorPoNumber : false)) || linkedPoCandidates[0];
          const newPoItems = buildPoItemsFromOrderItems(data.items || []);
          const previousItems = buildPoItemsFromOrderItems(previousOrder?.items || []);
          const orderItemsChanged = JSON.stringify(normalizePoItemsForCompare(previousItems)) !== JSON.stringify(normalizePoItemsForCompare(newPoItems));

          if (!linkedPo && orderItemsChanged && (savedOrder.vendorName || savedOrder.vendorPoNumber || savedOrder.requestedDate)) {
            const createRes = await fetchApi('/api/purchase-orders', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                orderId: savedOrder.id,
                orderNumber: savedOrder.orderNumber,
                poNumber: savedOrder.vendorPoNumber || previousOrder?.vendorPoNumber || '',
                vendor: savedOrder.vendorName || previousOrder?.vendorName || '',
                poType: String(savedOrder.status || '').includes('(vendor)') ? 'external' : 'internal',
                requestedDate: savedOrder.requestedDate || previousOrder?.requestedDate || '',
                dateOrdered: savedOrder.createdAt || new Date().toISOString(),
                status: 'Pending',
                shopNotes: savedOrder.shopNotes || data.shopNotes || '',
                items: newPoItems,
              }),
            });
            if (createRes.ok) {
              const createdPo = await createRes.json();
              if (createdPo?.id) {
                await queuePrintUrl(`/api/purchase-orders?id=${encodeURIComponent(createdPo.id)}&print=1`);
                showCenteredMessage(`PO UPDATED: ${createdPo.poNumber || createdPo.id}. NEW COPY PRINTED.`);
                poReprintedFromChange = true;
              }
            } else {
              const createErr = await parseJsonSafe(createRes);
              alert(createErr.error || 'PO changed but failed to create/update linked PO.');
            }
          }

          if (linkedPo) {
            const itemsChanged = JSON.stringify(normalizePoItemsForCompare(linkedPo.items || [])) !== JSON.stringify(normalizePoItemsForCompare(newPoItems));
            const requestedChanged = String((linkedPo.requestedDate || '')).slice(0,10) !== String((savedOrder.requestedDate || '')).slice(0,10);
            const vendorChanged = String(linkedPo.vendor || '') !== String(savedOrder.vendorName || '');
            const shopNotesChanged = String(linkedPo.shopNotes || '') !== String(savedOrder.shopNotes || data.shopNotes || '');
            const poChanged = itemsChanged || requestedChanged || vendorChanged || shopNotesChanged || orderItemsChanged;

            if (poChanged || hasAnyOrderChanges) {
              const updateRes = await fetchApi(`/api/purchase-orders?id=${encodeURIComponent(linkedPo.id)}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  vendor: savedOrder.vendorName || linkedPo.vendor || '',
                  requestedDate: savedOrder.requestedDate || linkedPo.requestedDate || '',
                  orderNumber: savedOrder.orderNumber || linkedPo.orderNumber || '',
                  shopNotes: savedOrder.shopNotes || data.shopNotes || linkedPo.shopNotes || '',
                  items: newPoItems,
                  updatedFromOrderAt: new Date().toISOString(),
                }),
              });
              if (updateRes.ok) {
                await queuePrintUrl(`/api/purchase-orders?id=${encodeURIComponent(linkedPo.id)}&print=1`);
                showCenteredMessage(`PO UPDATED: ${linkedPo.poNumber || linkedPo.id}. NEW COPY PRINTED.`);
                poReprintedFromChange = true;
              } else {
                const updateErr = await parseJsonSafe(updateRes);
                alert(updateErr.error || 'PO changed but failed to update linked PO.');
              }
            }
          }
        }

        if (hasAnyOrderChanges) {
          await queuePrintUrl(`/api/orders?id=${encodeURIComponent(savedOrder.id)}&print=purchase-order`);
          if (!poReprintedFromChange) {
            showCenteredMessage(`ORDER CHANGED: REPRINTED PO FOR ${savedOrder.orderNumber}.`);
          }
        }
      } catch (poSyncErr) {
        console.warn('PO sync after order save failed:', poSyncErr);
      }
    }

    document.getElementById('currentOrderNumber').textContent = savedOrder.orderNumber;
    document.getElementById('orderSavedStatus').textContent = '';
    showCenteredMessage(`ORDER SAVED: ${savedOrder.orderNumber}`);

    try { await loadOrders(); } catch (e) {}
    try { await loadPurchaseOrders(); } catch (e) {}
    if (isNewOrder) startNewOrder();

  } catch (err) {
    alert('Error saving order: ' + err.message);
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = 'Save Order';
  }
}

// ===================== ORDERS LIST (Orders Tab) =====================
let allOrders = [];

async function loadOrders() {
  try {
    const res = await fetchApi('/api/orders');
    if (!res.ok) throw new Error('Failed to load orders');
    allOrders = (await res.json()).filter(o => !String(o.status || "").toLowerCase().includes("invoiced"));
    renderOrderTable(allOrders);
  } catch (err) {
    console.error(err);
    document.getElementById('orderTableBody').innerHTML =
      '<tr><td colspan="10" style="text-align:center;">Failed to load orders.</td></tr>';
  }
}



function renderOrderTable(orders) {
  const tbody = document.getElementById('orderTableBody');
  if (!orders.length) {
    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;">No orders found.</td></tr>';
    return;
  }

  tbody.innerHTML = orders.map(o => {
    const date = o.createdAt ? new Date(o.createdAt).toLocaleDateString() : '';
    const custName = o.customer?.name || 'N/A';
    const itemCount = (o.items || []).length;
    const selectedStatus = o.status || 'shop production';
    return `
    <tr onclick="viewOrder('${o.id}')">
      <td><strong>${escapeHtml(o.orderNumber || '')}</strong></td>
      <td>${escapeHtml(custName)}</td>
      <td>${itemCount} item${itemCount !== 1 ? 's' : ''}</td>
      <td>$${(o.grandTotal || 0).toFixed(2)}</td>
      <td>$${(o.grandTotalWithTax || 0).toFixed(2)}</td>
      <td>${escapeHtml(date)}</td>
      <td>${escapeHtml(o.vendorName || '')}</td>
      <td>${escapeHtml(o.vendorPoNumber || '')}</td>
      <td>${escapeHtml(selectedStatus)}</td>
      <td class="actions-cell">
        <button class="btn-edit" onclick="event.stopPropagation(); loadOrderIntoCalculator('${o.id}')">Open</button>
        <button class="btn-delete" onclick="event.stopPropagation(); deleteOrder('${o.id}')">Delete</button>
      </td>
    </tr>`;
  }).join('');
}

async function searchOrders() {
  const query = document.getElementById('orderSearch').value.trim();

  if (!query) {
    renderOrderTable(allOrders);
    return;
  }

  try {
    const res = await fetchApi(`/api/orders?search=${encodeURIComponent(query)}`);
    if (!res.ok) throw new Error('Search failed');
    const results = await res.json();
    renderOrderTable(results);
  } catch (err) {
    console.error(err);
  }
}


async function deleteOrder(id) {
  if (!confirm('Are you sure you want to delete this order?')) return false;

  try {
    const res = await fetchApi(`/api/orders?id=${encodeURIComponent(id)}`, {
      method: 'DELETE',
    });
    if (!res.ok) throw new Error('Failed to delete order');
    await loadOrders();
    return true;
  } catch (err) {
    alert('Error deleting order: ' + err.message);
    return false;
  }
}

function viewOrder(id) {
  const order = allOrders.find(o => o.id === id);
  if (!order) return;

  let existing = document.getElementById('orderDetailModal');
  if (existing) existing.remove();

  const cust = order.customer || {};
  const items = order.items || [];
  const date = order.createdAt ? new Date(order.createdAt).toLocaleString() : '';

  let itemsHtml = '';
  items.forEach(item => {
    let typeStr = escapeHtml(item.glassType || '');
    const bits = [];
    if (item.bevel) bits.push(`${escapeHtml(item.bevelWidth || '')}" BEVEL`);
    if (item.shape) bits.push('SHAPE');
    if (bits.length === 1) typeStr += ` WITH ${bits[0]}`;
    else if (bits.length === 2) typeStr += ` WITH ${bits[0]} & ${bits[1]}`;

    itemsHtml += `<tr>
      <td>${item.qty || 1}</td>
      <td>${escapeHtml(item.width || '')} x ${escapeHtml(item.height || '')}</td>
      <td>${typeStr}</td>
      <td>${escapeHtml(item.eachPrice || '$0.00')}</td>
      <td>${escapeHtml(item.lineTotal || '$0.00')}</td>
    </tr>`;
  });

  const hwHtml = order.hardware
    ? `<p><strong>Hardware:</strong> ${escapeHtml(order.hardware.name)} — $${(order.hardware.price || 0).toFixed(2)}</p>`
    : '';

  const modal = document.createElement('div');
  modal.id = 'orderDetailModal';
  modal.className = 'order-detail-modal-overlay';
  modal.innerHTML = `
    <div class="order-detail-modal">
      <h3>${escapeHtml(order.orderNumber || 'Order')}</h3>
      <p style="font-size:12px;color:#888;">Created: ${escapeHtml(date)} | Status: ${escapeHtml(order.status || 'shop production')}${order.specialPricing ? ' | Special Pricing' : ''}</p>

      <div class="order-detail-info">
        <div><strong>Customer</strong>${escapeHtml(cust.name || 'N/A')}</div>
        <div><strong>Phone</strong>${escapeHtml(cust.phone || 'N/A')}</div>
        <div><strong>Address</strong>${escapeHtml(cust.address || 'N/A')}</div>
        <div><strong>Email</strong>${escapeHtml(cust.email || 'N/A')}</div>
        <div><strong>Credit Terms</strong>${escapeHtml(cust.creditTerms || 'N/A')}</div>
        <div><strong>Vendor</strong>${escapeHtml(order.vendorName || 'N/A')}</div>
        <div><strong>PO #</strong>${escapeHtml(order.vendorPoNumber || 'N/A')}</div>
      </div>

      <table>
        <thead><tr><th>Qty</th><th>Size (W x H)</th><th>Glass Type</th><th>Each</th><th>Line Total</th></tr></thead>
        <tbody>${itemsHtml}</tbody>
      </table>

      ${hwHtml}

      <p style="font-size:16px;font-weight:bold;margin-top:15px;">
        Grand Total: $${(order.grandTotal || 0).toFixed(2)}<br>
        Grand Total with Tax (6%): $${(order.grandTotalWithTax || 0).toFixed(2)}
      </p>

      <div style="display:flex;gap:10px;margin-top:15px;">
        <button onclick="loadOrderIntoCalculator('${order.id}'); closeOrderDetailModal();" style="padding:8px 18px;font-size:14px;font-weight:bold;background:#007BFF;color:white;border:none;border-radius:6px;cursor:pointer;">Open in Calculator</button>
        <button onclick="editPoForOrder('${order.id}')" style="padding:8px 18px;font-size:14px;font-weight:bold;background:#0d6efd;color:white;border:none;border-radius:6px;cursor:pointer;">Edit PO</button>
        <button onclick="printOrderFromDetail('${order.id}')" style="padding:8px 18px;font-size:14px;font-weight:bold;background:#6c757d;color:white;border:none;border-radius:6px;cursor:pointer;">Print</button>
        <button onclick="markOrderPickedUpAndInvoice('${order.id}')" style="padding:8px 18px;font-size:14px;font-weight:bold;background:#198754;color:white;border:none;border-radius:6px;cursor:pointer;">Mark Picked Up / Invoice</button>
        <button onclick="closeOrderDetailModal()" style="padding:8px 18px;font-size:14px;font-weight:bold;background:lightgrey;color:black;border:none;border-radius:6px;cursor:pointer;">Close</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
  modal.addEventListener('click', function(e) {
    if (e.target === modal) closeOrderDetailModal();
  });
}

async function markOrderPickedUpAndInvoice(orderId) {
  try {
    const res = await fetchApi('/api/invoices', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ orderId }),
    });

    let payload = await parseJsonSafe(res);
    if (!res.ok && res.status === 404) {
      const fallbackRes = await fetchApi(`/api/orders?id=${encodeURIComponent(orderId)}&action=invoice`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({}),
      });
      payload = await parseJsonSafe(fallbackRes);
      if (!fallbackRes.ok) {
        throw new Error(payload.error || `Failed to create invoice (${fallbackRes.status})`);
      }
    } else if (!res.ok) {
      throw new Error(payload.error || `Failed to create invoice (${res.status})`);
    }

    await loadOrders();
    try { await loadPurchaseOrders(); } catch (e) {}
    showCenteredMessage(`INVOICED ${payload.orderNumber || ''} AS ${payload.invoiceNumber || ''}`);
    await queuePrintUrl(`/api/orders?id=${encodeURIComponent(orderId)}&print=invoice`);
    closeOrderDetailModal();
  } catch (err) {
    alert('ERROR INVOICING ORDER: ' + err.message);
  }
}

function closeOrderDetailModal() {
  const modal = document.getElementById('orderDetailModal');
  if (modal) modal.remove();
}

function printOrderFromDetail(id) {
  const order = allOrders.find(o => o.id === id);
  if (!order) return;

  const cust = order.customer || {};
  const items = order.items || [];

  let breakdownWindow = window.open('', '', 'width=800,height=600');
  breakdownWindow.document.write('<style>table {width:100%;border-collapse:collapse;} th,td {border:1px solid #000;padding:8px;text-align:center;} h2,h3 {text-align:center;} </style>');
  breakdownWindow.document.write('</head><body>');
  breakdownWindow.document.write(`<h3 style="margin-bottom:5px;">${escapeHtml(order.orderNumber || '')}</h3>`);

  let custInfoHtml = `<p style="text-align:center; font-size:16px; margin-bottom:20px;">
    <strong>Customer Name:</strong> ${escapeHtml(cust.name || 'N/A')} &nbsp;&nbsp;
    <strong>Phone:</strong> ${escapeHtml(cust.phone || 'N/A')}`;
  if (cust.address) custInfoHtml += `<br><strong>Address:</strong> ${escapeHtml(cust.address)}`;
  if (cust.email) custInfoHtml += ` &nbsp;&nbsp;<strong>Email:</strong> ${escapeHtml(cust.email)}`;
  if (cust.creditTerms) custInfoHtml += `<br><strong>Credit Terms:</strong> ${escapeHtml(cust.creditTerms)}`;
  custInfoHtml += `</p>`;
  breakdownWindow.document.write(custInfoHtml);

  breakdownWindow.document.write('<table>');
  breakdownWindow.document.write('<thead><tr><th>Qty</th><th>Size (W x H)</th><th>Glass Type</th><th>Each Price</th><th>Line Total</th></tr></thead><tbody>');

  items.forEach(item => {
    let typeStr = item.glassType || '';
    const bits = [];
    if (item.bevel) bits.push(`${item.bevelWidth || ''}" BEVEL`);
    if (item.shape) bits.push('SHAPE');
    if (bits.length === 1) typeStr += ` WITH ${bits[0]}`;
    else if (bits.length === 2) typeStr += ` WITH ${bits[0]} & ${bits[1]}`;

    breakdownWindow.document.write(`<tr>
      <td>${item.qty || 1}</td>
      <td>${item.width || ''} x ${item.height || ''}</td>
      <td>${typeStr}</td>
      <td>${item.eachPrice || '$0.00'}</td>
      <td>${item.lineTotal || '$0.00'}</td>
    </tr>`);
  });

  breakdownWindow.document.write('</tbody></table>');
  breakdownWindow.document.write(`<h3>Grand Total: $${(order.grandTotal || 0).toFixed(2)}</h3>`);
  breakdownWindow.document.write(`<h3>Grand Total with Tax (6%): $${(order.grandTotalWithTax || 0).toFixed(2)}</h3>`);
  breakdownWindow.document.write('</body></html>');
  breakdownWindow.document.close();
  breakdownWindow.print();
}

async function loadOrderIntoCalculator(id) {
  const order = allOrders.find(o => o.id === id);
  if (!order) {
    try {
      const res = await fetchApi(`/api/orders?id=${encodeURIComponent(id)}`);
      if (!res.ok) throw new Error('Order not found');
      const fetched = await res.json();
      populateCalculatorFromOrder(fetched);
    } catch (err) {
      alert('Could not load order: ' + err.message);
    }
    return;
  }
  populateCalculatorFromOrder(order);
}

async function editPoForOrder(orderId) {
  try {
    const res = await fetchApi('/api/purchase-orders');
    if (!res.ok) throw new Error('Failed to load purchase orders');
    const poList = await parseJsonSafe(res);
    const list = Array.isArray(poList) ? poList : [];
    const linkedPo = list.find(p => p.orderId === orderId && p.syncToOrder !== false) || list.find(p => p.orderId === orderId);
    if (!linkedPo?.id) {
      alert('No linked PO found for this order yet. Save/update order PO details first.');
      return;
    }
    closeOrderDetailModal();
    await editPurchaseOrder(linkedPo.id);
  } catch (err) {
    alert('Could not open linked PO: ' + err.message);
  }
}


function formatOrderStatusSummary(order = {}) {
  const parts = [];
  if (order.vendorName) parts.push(`Vendor: ${order.vendorName}`);
  if (order.vendorPoNumber) parts.push(`PO: ${order.vendorPoNumber}`);
  if (order.vendorReceivedAt) {
    const dt = new Date(order.vendorReceivedAt);
    const receivedText = Number.isNaN(dt.getTime()) ? order.vendorReceivedAt : dt.toLocaleDateString();
    parts.push(`Received: ${receivedText}`);
  }
  return parts.join(' | ');
}

function populateCalculatorFromOrder(order, mode = 'order') {
  const isQuoteMode = mode === 'quote';
  showCalculatorWorkspace(isQuoteMode ? 'quote' : 'order');
  setCalculatorMode(isQuoteMode ? 'quote' : 'order');

  currentOrderId = isQuoteMode ? null : order.id;
  currentQuoteId = isQuoteMode ? order.id : null;
  if (!isQuoteMode) {
    setEditOrderHeader();
    setOrderActionMode(true);
  }
  document.getElementById('currentOrderNumber').textContent = order.orderNumber || 'N/A';
  document.getElementById('orderSavedStatus').textContent = formatOrderStatusSummary(order);

  const cust = order.customer || {};
  document.getElementById('customerName').value = cust.name || '';
  document.getElementById('customerPhone').value = cust.phone || '';
  document.getElementById('calcCustAddress').value = cust.address || '';
  document.getElementById('calcCustEmail').value = cust.email || '';
  document.getElementById('calcCustCreditTerms').value = cust.creditTerms || '';
  const customerNotesEl = document.getElementById('customerNotes');
  const shopNotesEl = document.getElementById('shopNotes');
  if (customerNotesEl) customerNotesEl.value = order.customerNotes || order.notes || '';
  if (shopNotesEl) shopNotesEl.value = order.shopNotes || '';

  if (cust.name) {
    setCalcCustomerFieldsReadonly(true);
  }

  const specialToggle = document.getElementById('specialPricingToggle');
  specialToggle.checked = order.specialPricing || false;
  glassPartsData = specialToggle.checked ? specialGlassPartsData : standardglassPartsData;

  document.getElementById('glassTableBody').innerHTML = '';
  const items = order.items || [];

  if (items.length === 0) {
    for (let i = 0; i < 5; i++) addRow();
  } else {
    items.forEach(item => {
      addRow();
      const rows = document.querySelectorAll('#glassTableBody tr');
      const row = rows[rows.length - 1];

      row.querySelector('.qty').value = item.qty || 1;
      row.querySelector('.width').value = item.width || '';
      row.querySelector('.height').value = item.height || '';
      row.querySelector('.glassTypeInput').value = item.glassType || '';
      row.querySelector('.bevel').checked = item.bevel || false;
      row.querySelector('.bevelWidth').value = item.bevelWidth || '1/2';
      row.querySelector('.shape').checked = item.shape || false;
    });
    for (let i = 0; i < 2; i++) addRow();
  }

  clearHardware();
  const hardwareItems = Array.isArray(order.hardwareItems) ? order.hardwareItems : [];
  if (hardwareItems.length) {
    const hwRows = document.querySelectorAll('#hardwareTableBody tr');
    hardwareItems.forEach((item, idx) => {
      const row = hwRows[idx] || hwRows[hwRows.length - 1];
      if (!row) return;
      row.querySelector('.hw-part').value = item.name || '';
      row.querySelector('.hw-qty').value = item.qty || '';
      updateHardwareRow(row);
      if (idx >= hwRows.length - 1) addHardwareRow();
    });
  }

  updateHardwareTotals();
  updateTotals();
}

// ===================== QUOTES LIST (Open Quotes) =====================
let allQuotes = [];

let allInvoicedOrders = [];

async function loadInvoicedOrders() {
  try {
    const res = await fetchApi('/api/invoices');
    if (!res.ok) throw new Error('Failed to load invoices');
    allInvoicedOrders = await res.json();
    renderInvoicedTable(allInvoicedOrders);
  } catch (err) {
    const tbody = document.getElementById('invoicedTableBody');
    if (tbody) tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Failed to load invoiced orders.</td></tr>';
  }
}

function renderInvoicedTable(rows) {
  const tbody = document.getElementById('invoicedTableBody');
  if (!tbody) return;
  if (!rows.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No invoiced orders found.</td></tr>';
    return;
  }
  tbody.innerHTML = rows.map(inv => {
    const date = inv.invoiceDate ? new Date(inv.invoiceDate).toLocaleDateString() : '';
    const customer = inv.customer?.name || 'N/A';
    return `<tr>
      <td><strong>${escapeHtml(inv.invoiceNumber || '')}</strong></td>
      <td>${escapeHtml(inv.orderNumber || '')}</td>
      <td>${escapeHtml(customer)}</td>
      <td>${escapeHtml(inv.terms || '')}</td>
      <td>$${(inv.grandTotalWithTax || 0).toFixed(2)}</td>
      <td>${escapeHtml(date)}</td>
      <td><button type="button" onclick="reprintInvoice('${inv.orderId || ''}')">Reprint Invoice</button></td>
    </tr>`;
  }).join('');
}

function searchInvoicedOrders() {
  const q = (document.getElementById('invoicedSearch')?.value || '').trim().toLowerCase();
  if (!q) return renderInvoicedTable(allInvoicedOrders);
  const filtered = allInvoicedOrders.filter(inv =>
    (inv.invoiceNumber || '').toLowerCase().includes(q) ||
    (inv.orderNumber || '').toLowerCase().includes(q) ||
    (inv.customer?.name || '').toLowerCase().includes(q)
  );
  renderInvoicedTable(filtered);
}

async function reprintInvoice(orderId) {
  if (!orderId) {
    alert('Missing order id for invoice.');
    return;
  }
  await queuePrintUrl(`/api/orders?id=${encodeURIComponent(orderId)}&print=invoice`);
}

async function loadQuotes() {
  try {
    const res = await fetchApi('/api/quotes');
    if (!res.ok) throw new Error('Failed to load quotes');
    allQuotes = (await res.json()).filter(q => String(q.status || "").toLowerCase() !== "closed as ordered");
    renderQuoteTable(allQuotes);
  } catch (err) {
    document.getElementById('quoteTableBody').innerHTML = '<tr><td colspan="6" style="text-align:center;">Failed to load quotes.</td></tr>';
  }
}

function renderQuoteTable(quotes) {
  const tbody = document.getElementById('quoteTableBody');
  if (!quotes.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No quotes found.</td></tr>';
    return;
  }

  tbody.innerHTML = quotes.map(q => {
    const created = q.createdAt ? new Date(q.createdAt).toLocaleDateString() : '';
    const custName = q.customer?.name || q.customerName || '';
    return `
      <tr>
        <td><strong>${escapeHtml(q.quoteNumber || q.id || '')}</strong></td>
        <td>${escapeHtml(custName)}</td>
        <td>${escapeHtml(q.status || 'quote')}</td>
        <td>$${(q.grandTotal || 0).toFixed(2)}</td>
        <td>${escapeHtml(created)}</td>
        <td>
          <button onclick="loadQuoteIntoCalculator('${q.id}')">Open</button>
          <button onclick="printQuote('${q.id}')">Print</button>
          <button onclick="convertSavedQuoteToOrder('${q.id}')">Convert to Order</button>
        </td>
      </tr>
    `;
  }).join('');
}

function searchQuotes() {
  const query = document.getElementById('quoteSearch').value.trim().toLowerCase();
  if (!query) {
    renderQuoteTable(allQuotes);
    return;
  }
  const filtered = allQuotes.filter(q => {
    const custName = (q.customer?.name || q.customerName || '').toLowerCase();
    return (q.id || '').toLowerCase().includes(query) || (q.quoteNumber || '').toLowerCase().includes(query) || custName.includes(query);
  });
  renderQuoteTable(filtered);
}

async function loadQuoteIntoCalculator(id) {
  const quote = allQuotes.find(q => q.id === id);
  if (!quote) return;

  if ((quote.status || '').toLowerCase() === 'closed as ordered') {
    alert('This quote has been converted to an order.');
    return;
  }

  kympgOpen('quote');
  populateCalculatorFromOrder({ ...quote, id: quote.id, orderNumber: quote.quoteNumber || quote.id }, 'quote');
  currentQuoteId = quote.id;
  document.getElementById('orderSavedStatus').textContent = `Loaded ${quote.quoteNumber || quote.id}`;
}

async function convertSavedQuoteToOrder(id) {
  const quote = allQuotes.find(q => q.id === id);
  if (!quote) return;

  const orderPayload = {
    sequenceNumber: quote.sequenceNumber,
    customer: quote.customer || { name: quote.customerName, phone: quote.customerPhone },
    items: quote.items || [],
    hardware: quote.hardware || null,
    specialPricing: quote.specialPricing || false,
    grandTotal: quote.grandTotal || 0,
    grandTotalWithTax: quote.grandTotalWithTax || 0,
    customerNotes: quote.customerNotes || quote.notes || '',
    notes: quote.customerNotes || quote.notes || '',
    shopNotes: quote.shopNotes || '',
    requiresPoSetup: true,
    status: 'shop production',
  };

  try {
    const orderRes = await fetchApi('/api/orders', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(orderPayload),
    });
    if (!orderRes.ok) throw new Error('Failed to create order from quote');
    const createdOrder = await orderRes.json();

    await fetchApi(`/api/quotes?id=${encodeURIComponent(id)}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: 'closed as ordered', convertedOrderId: createdOrder.id, closedReason: 'ordered' }),
    });

    await loadQuotes();
    await loadOrders();
    showCenteredMessage(`QUOTE CONVERTED TO ORDER ${createdOrder.orderNumber}. QUOTE CLOSED AS ORDERED.`);
    setCalculatorMode('order');
    currentOrderId = createdOrder.id;
    lastSavedOrderId = createdOrder.id;
    currentQuoteId = null;
    await loadOrderIntoCalculator(createdOrder.id);
  } catch (err) {
    alert('Error converting quote: ' + err.message);
  }
}

// ===================== CSV/EXCEL IMPORT =====================
let importParsedRows = [];
let importHeaders = [];

function handleImportFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  event.target.value = '';

  const ext = file.name.split('.').pop().toLowerCase();

  if (ext === 'csv') {
    const reader = new FileReader();
    reader.onload = function(e) {
      const rows = parseCsv(e.target.result);
      if (rows.length < 2) {
        alert('The CSV file appears to be empty or has no data rows.');
        return;
      }
      importHeaders = rows[0];
      importParsedRows = rows.slice(1);
      openImportModal();
    };
    reader.readAsText(file);
  } else if (ext === 'xlsx' || ext === 'xls') {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const workbook = XLSX.read(e.target.result, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

        if (data.length < 2) {
          alert('The Excel file appears to be empty or has no data rows.');
          return;
        }

        importHeaders = data[0].map(h => String(h).trim());
        importParsedRows = data.slice(1).map(row => row.map(cell => String(cell).trim()));
        openImportModal();
      } catch (err) {
        alert('Error reading Excel file: ' + err.message);
      }
    };
    reader.readAsArrayBuffer(file);
  } else {
    alert('Please upload a .csv, .xlsx, or .xls file.');
  }
}

function guessMapping(headers) {
  const mapping = { name: '', address: '', email: '', phone: '', creditTerms: '' };
  const lower = headers.map(h => h.toLowerCase());

  lower.forEach((h, i) => {
    const col = headers[i];
    if (!mapping.name && (h.includes('name') || h.includes('customer'))) mapping.name = col;
    else if (!mapping.address && (h.includes('address') || h.includes('addr') || h.includes('street') || h.includes('city'))) mapping.address = col;
    else if (!mapping.email && (h.includes('email') || h.includes('e-mail'))) mapping.email = col;
    else if (!mapping.phone && (h.includes('phone') || h.includes('tel') || h.includes('mobile') || h.includes('cell'))) mapping.phone = col;
    else if (!mapping.creditTerms && (h.includes('credit') || h.includes('terms') || h.includes('payment'))) mapping.creditTerms = col;
  });

  return mapping;
}

function openImportModal() {
  let existing = document.getElementById('importModal');
  if (existing) existing.remove();

  const mapping = guessMapping(importHeaders);

  const modal = document.createElement('div');
  modal.id = 'importModal';
  modal.className = 'import-modal-overlay';

  const optionsHtml = '<option value="">(skip)</option>' +
    importHeaders.map(h => `<option value="${escapeHtml(h)}">${escapeHtml(h)}</option>`).join('');

  function selectHtml(field, label) {
    return `<div>
      <label>${label}</label>
      <select id="importMap_${field}" onchange="updateImportPreview()">
        ${optionsHtml}
      </select>
    </div>`;
  }

  modal.innerHTML = `
    <div class="import-modal">
      <h3>Import Customers from File</h3>
      <p style="font-size:13px;color:#555;margin-bottom:12px;">
        Found <strong>${importParsedRows.length}</strong> row(s). Map the file columns to customer fields below. Rows without a name will be skipped.
      </p>

      <div class="column-mapping">
        ${selectHtml('name', 'Name *')}
        ${selectHtml('address', 'Address')}
        ${selectHtml('email', 'Email')}
        ${selectHtml('phone', 'Phone')}
        ${selectHtml('creditTerms', 'Credit Terms')}
      </div>

      <div style="max-height:300px;overflow-y:auto;margin-bottom:15px;">
        <table class="import-preview-table">
          <thead><tr>
            <th>#</th><th>Name</th><th>Address</th><th>Email</th><th>Phone</th><th>Credit Terms</th>
          </tr></thead>
          <tbody id="importPreviewBody"></tbody>
        </table>
      </div>

      <div class="import-actions">
        <button class="btn-import-confirm" id="btnImportConfirm" onclick="confirmImport()">Import Customers</button>
        <button class="btn-import-cancel" onclick="closeImportModal()">Cancel</button>
        <span class="import-status" id="importStatus"></span>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  if (mapping.name) document.getElementById('importMap_name').value = mapping.name;
  if (mapping.address) document.getElementById('importMap_address').value = mapping.address;
  if (mapping.email) document.getElementById('importMap_email').value = mapping.email;
  if (mapping.phone) document.getElementById('importMap_phone').value = mapping.phone;
  if (mapping.creditTerms) document.getElementById('importMap_creditTerms').value = mapping.creditTerms;

  updateImportPreview();
}

function closeImportModal() {
  const modal = document.getElementById('importModal');
  if (modal) modal.remove();
  importParsedRows = [];
  importHeaders = [];
}

function getImportMapping() {
  const fields = ['name', 'address', 'email', 'phone', 'creditTerms'];
  const mapping = {};
  fields.forEach(f => {
    const el = document.getElementById('importMap_' + f);
    const colName = el ? el.value : '';
    mapping[f] = colName ? importHeaders.indexOf(colName) : -1;
  });
  return mapping;
}

function getMappedValue(row, colIndex) {
  if (colIndex < 0 || colIndex >= row.length) return '';
  return (row[colIndex] || '').toString().trim();
}

function updateImportPreview() {
  const mapping = getImportMapping();
  const tbody = document.getElementById('importPreviewBody');
  if (!tbody) return;

  const previewRows = importParsedRows.slice(0, 100);

  tbody.innerHTML = previewRows.map((row, i) => {
    const name = getMappedValue(row, mapping.name);
    const skip = !name;
    return `<tr class="${skip ? 'skip-row' : ''}">
      <td>${i + 1}</td>
      <td>${escapeHtml(name) || '<em style="color:#999;">empty</em>'}</td>
      <td>${escapeHtml(getMappedValue(row, mapping.address))}</td>
      <td>${escapeHtml(getMappedValue(row, mapping.email))}</td>
      <td>${escapeHtml(getMappedValue(row, mapping.phone))}</td>
      <td>${escapeHtml(getMappedValue(row, mapping.creditTerms))}</td>
    </tr>`;
  }).join('');

  if (importParsedRows.length > 100) {
    tbody.innerHTML += `<tr><td colspan="6" style="text-align:center;font-style:italic;color:#666;">...and ${importParsedRows.length - 100} more rows</td></tr>`;
  }
}

async function confirmImport() {
  const mapping = getImportMapping();

  if (mapping.name < 0) {
    alert('Please map at least the "Name" column before importing.');
    return;
  }

  const customers = importParsedRows
    .map(row => ({
      name: getMappedValue(row, mapping.name),
      address: getMappedValue(row, mapping.address),
      email: getMappedValue(row, mapping.email),
      phone: getMappedValue(row, mapping.phone),
      creditTerms: getMappedValue(row, mapping.creditTerms),
    }))
    .filter(c => c.name);

  if (customers.length === 0) {
    alert('No valid customers to import (all rows are missing a name).');
    return;
  }

  const statusEl = document.getElementById('importStatus');
  const confirmBtn = document.getElementById('btnImportConfirm');
  confirmBtn.disabled = true;
  confirmBtn.textContent = 'Importing...';
  statusEl.className = 'import-status';
  statusEl.textContent = `Importing ${customers.length} customer(s)...`;

  try {
    const res = await fetchApi('/api/customers-import', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ customers }),
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Import failed');
    }

    const result = await res.json();
    statusEl.className = 'import-status success';
    statusEl.textContent = `Done! ${result.created} imported, ${result.skipped} skipped.`;

    await loadCustomers();
    await loadCalcCustomers();

    setTimeout(() => {
      closeImportModal();
    }, 1500);
  } catch (err) {
    statusEl.className = 'import-status error';
    statusEl.textContent = 'Error: ' + err.message;
    confirmBtn.disabled = false;
    confirmBtn.textContent = 'Import Customers';
  }
}

// ===================== STARTUP =====================
document.addEventListener("DOMContentLoaded", async function () {
  const specialToggle = document.getElementById('specialPricingToggle');
  specialToggle.checked = false;

  await loadPricingFromSheets();

  glassPartsData = standardglassPartsData;

  for (let i = 0; i < 5; i++) addRow();
  updateTotals();
  // Ensure calculator always starts with visible editable lines.
  try { if (typeof startNewOrder === 'function') startNewOrder(); } catch (e) {}

  await loadCalcCustomers();
  setupCustomerLookup();
});
</script>

<div id="adminUserModal" class="admin-user-modal" onclick="closeAdminCreateUserModal()">
  <div class="admin-user-card" onclick="event.stopPropagation()">
    <h3>Create New User</h3>
    <label for="newUserEmail">Email</label>
    <input id="newUserEmail" type="email" placeholder="new.user@company.com" autocomplete="email">

    <label for="newUserFullName">Full Name (optional)</label>
    <input id="newUserFullName" type="text" placeholder="New User" autocomplete="name">

    <label>Roles</label>
    <div class="roleChecks" id="newUserRoleChecks">
      <label><input type="checkbox" value="admin"> Admin</label>
      <label><input type="checkbox" value="office" checked> Office</label>
      <label><input type="checkbox" value="shop"> Shop</label>
      <label><input type="checkbox" value="field"> Field</label>
    </div>

    <div class="admin-user-actions">
      <button type="button" class="kympg-authBtn secondary" onclick="closeAdminCreateUserModal()">Cancel</button>
      <button type="button" class="kympg-authBtn success" onclick="createAdminUser()">Create User</button>
    </div>
    <div id="adminUserStatus" class="admin-user-status"></div>
  </div>
</div>

<script>
  function kympgToggleSidebar(){
    document.getElementById('kympgSidebar')?.classList.toggle('collapsed');
  }
  function kympgClearActiveNav(){
    document.querySelectorAll('.kympg-navBtn').forEach(b => b.classList.remove('active'));
  }
  function kympgHideAllSections(){
    const ids = ['landing-section','calculator-section','customer-section','vendor-section','orders-section',
                 'shower-section','invoiced-section','quotedb-section','po-section','breakage-section','pricelist-section',
                 'residential-section','residentialdb-section','servicetechs-section'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = 'none';
      el.classList.remove('active');
    });
  }
  function kympgSetHeader(title, sub, cardTitle, cardSub){
    const t = document.getElementById('kympgPageTitle');
    const s = document.getElementById('kympgPageSub');
    const ct = document.getElementById('kympgCardTitle');
    const cs = document.getElementById('kympgCardSub');
    if (t) t.textContent = title || '';
    if (s) s.textContent = sub || '';
    if (ct) ct.textContent = cardTitle || '';
    if (cs) cs.textContent = cardSub || '';
  }
  function kympgShowLanding(){
    kympgClearActiveNav();
    kympgHideAllSections();
    const el = document.getElementById('landing-section');
    if (el){ el.style.display = 'block'; el.classList.add('active'); }
    kympgSetHeader('Kentucky Mirror and Plate Glass', 'Select an option on the left to get started.', 'Home', 'Welcome');
    if (authUser && isFieldTechUser()) { try { loadTechHomeRequests(); } catch (e) {} }
  }

  const ROLE_PERMISSIONS = {
    admin: ['*'],
    office: ['*'],
    shop: ['landing', 'po'],
    field: ['residential', 'residentialdb'],
  };
  let authUser = null;
  let authToken = '';
  let authRoles = [];
  let hasPromptedLogin = false;

  function getAuthDisplayName() {
    return authUser?.user_metadata?.full_name || authUser?.email || 'Unknown User';
  }
  function userCanArea(area) {
    if (!authUser) return false;
    const perms = new Set();
    (authRoles || []).forEach((r) => {
      (ROLE_PERMISSIONS[r] || []).forEach((p) => perms.add(p));
    });
    return perms.has('*') || perms.has(area);
  }
  function canDeleteOrders() { return authRoles.includes('admin'); }
  function canDeleteCustomers() { return authRoles.includes('admin'); }
  function isFieldTechUser() { return authRoles.includes('field'); }

  let currentMeasureRequest = null;

  function setAuthGateVisible(visible) {
    document.body.classList.toggle('auth-locked', !!visible);
    const gate = document.getElementById('authGate');
    if (gate) gate.style.display = visible ? 'flex' : 'none';
  }

  function openLogin() {
    if (window.netlifyIdentity) {
      window.netlifyIdentity.open('login');
      return;
    }
    alert('Netlify login is not available in this environment.');
  }

  async function logoutUser() {
    if (window.netlifyIdentity) await window.netlifyIdentity.logout();
  }

  async function syncAuthState(user) {
    authUser = user || null;
    authToken = user?.token?.access_token || '';
    authRoles = Array.isArray(user?.app_metadata?.roles) ? user.app_metadata.roles.map((r) => String(r).toLowerCase()) : [];

    const meta = document.getElementById('authUserMeta');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    if (meta) meta.textContent = authUser ? `${getAuthDisplayName()} (${authRoles.join(', ') || 'no role'})` : 'Not signed in';
    if (loginBtn) loginBtn.style.display = authUser ? 'none' : 'inline-block';
    if (logoutBtn) logoutBtn.style.display = authUser ? 'inline-block' : 'none';

    const isAdmin = authRoles.includes('admin');
    const createBtn = document.getElementById('adminCreateUserBtn');
    if (createBtn) createBtn.style.display = isAdmin && authUser ? 'inline-block' : 'none';
    if (!isAdmin) closeAdminCreateUserModal();

    document.querySelectorAll('.kympg-navBtn').forEach((btn) => {
      const oc = btn.getAttribute('onclick') || '';
      const m = oc.match(/kympgOpen\('([^']+)'/);
      const area = m ? m[1] : '';
      btn.classList.toggle('kympg-hidden-by-role', !userCanArea(area));
    });

    ['work', 'tools', 'residential'].forEach((g) => {
      const group = document.getElementById(`group-${g}`);
      if (!group) return;
      const hasVisible = !!group.querySelector('.kympg-navBtn:not(.kympg-hidden-by-role)');
      group.classList.toggle('kympg-hidden-by-role', !hasVisible);
    });

    const logPo = document.querySelector('.kympg-logPO');
    if (logPo) logPo.classList.toggle('kympg-hidden-by-role', !userCanArea('po'));

    const techHomeWrap = document.getElementById('techHomeRequests');
    if (techHomeWrap) techHomeWrap.style.display = isFieldTechUser() ? 'block' : 'none';
    if (authUser && isFieldTechUser()) {
      try { await loadTechHomeRequests(); } catch (e) {}
    }

    if (!authUser) {
      kympgShowLanding();
      setAuthGateVisible(true);
      if (!hasPromptedLogin && window.netlifyIdentity) {
        hasPromptedLogin = true;
        setTimeout(() => openLogin(), 150);
      }
      return;
    }

    setAuthGateVisible(false);
    hasPromptedLogin = false;
  }

  function openAdminCreateUserModal() {
    if (!authRoles.includes('admin')) return;
    const modal = document.getElementById('adminUserModal');
    if (modal) modal.classList.add('active');
    const status = document.getElementById('adminUserStatus');
    if (status) status.textContent = '';
  }

  function closeAdminCreateUserModal() {
    const modal = document.getElementById('adminUserModal');
    if (modal) modal.classList.remove('active');
  }

  async function createAdminUser() {
    if (!authRoles.includes('admin')) return alert('Only admins can create users.');
    const email = String(document.getElementById('newUserEmail')?.value || '').trim();
    const fullName = String(document.getElementById('newUserFullName')?.value || '').trim();
    const status = document.getElementById('adminUserStatus');
    const roles = Array.from(document.querySelectorAll('#newUserRoleChecks input[type="checkbox"]:checked')).map((el) => el.value);

    if (!email) {
      if (status) status.textContent = 'Enter an email.';
      return;
    }
    if (!roles.length) {
      if (status) status.textContent = 'Select at least one role.';
      return;
    }

    if (status) status.textContent = 'Creating user...';
    const res = await fetchApi('/api/admin-create-user', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, fullName, roles }),
    });
    const payload = await parseJsonSafe(res);
    if (!res.ok) {
      if (status) status.textContent = payload.error || 'Failed to create user.';
      return;
    }

    if (status) status.textContent = `User created: ${email}`;
    document.getElementById('newUserEmail').value = '';
    document.getElementById('newUserFullName').value = '';
  }

  async function runHomeQuickSearch() {
    const input = document.getElementById('homeQuickSearchInput');
    const resultsEl = document.getElementById('homeQuickResults');
    if (!input || !resultsEl) return;

    const q = (input.value || '').trim().toLowerCase();
    const normalizePhone = (v) => String(v || '').replace(/\D/g, '');
    const qPhone = normalizePhone(q);
    if (!q) {
      resultsEl.innerHTML = '<div class="kympg-quickMeta" style="padding:8px 4px;">Enter an order/quote/PO number, customer name, or phone #.</div>';
      return;
    }

    resultsEl.innerHTML = '<div class="kympg-quickMeta" style="padding:8px 4px;">Searching…</div>';

    try {
      const [ordersRes, quotesRes, poRes] = await Promise.all([
        fetchApi('/api/orders'),
        fetchApi('/api/quotes'),
        fetchApi('/api/purchase-orders'),
      ]);

      const orders = ordersRes.ok ? await ordersRes.json() : [];
      const quotes = quotesRes.ok ? await quotesRes.json() : [];
      const pos = poRes.ok ? await poRes.json() : [];

      const orderHits = (orders || []).filter(o => {
        const custName = (o.customer?.name || '').toLowerCase();
        const custPhone = normalizePhone(o.customer?.phone || '');
        return (o.orderNumber || '').toLowerCase().includes(q)
          || custName.includes(q)
          || (qPhone && custPhone.includes(qPhone));
      });

      const quoteHits = (quotes || []).filter(x => {
        const custName = (x.customer?.name || x.customerName || '').toLowerCase();
        const custPhone = normalizePhone(x.customer?.phone || x.customerPhone || '');
        return (x.quoteNumber || '').toLowerCase().includes(q)
          || custName.includes(q)
          || (qPhone && custPhone.includes(qPhone));
      });

      const poHits = (pos || []).filter(p => {
        return (p.poNumber || '').toLowerCase().includes(q)
          || (p.orderNumber || '').toLowerCase().includes(q)
          || (p.vendor || '').toLowerCase().includes(q);
      });

      const briefOrderDescription = (o) => {
        const items = Array.isArray(o.items) ? o.items : [];
        if (!items.length) return 'NO LINE ITEMS';
        const first = items[0] || {};
        const size = first.width && first.height ? `${first.width} X ${first.height}` : '';
        const firstDesc = [first.glassType || first.type || 'GLASS', size].filter(Boolean).join(' ');
        return items.length > 1 ? `${firstDesc} + ${items.length - 1} MORE` : firstDesc;
      };
      const renderLinePreview = (items, title) => {
        const rows = (Array.isArray(items) ? items : []).slice(0, 6).map((it, idx) => {
          const size = it.width && it.height ? `${it.width} X ${it.height}` : '';
          const desc = [it.glassType || it.type || 'ITEM', size].filter(Boolean).join(' ');
          const qty = it.qty || it.quantity || 1;
          return `<div class="kympg-quickPreviewLine">${idx + 1}. QTY ${escapeHtml(qty)} — ${escapeHtml(desc)}</div>`;
        }).join('');
        const total = Array.isArray(items) ? items.length : 0;
        const more = total > 6 ? `<div class="kympg-quickPreviewLine">+ ${total - 6} MORE LINES</div>` : '';
        return `<div class="kympg-quickPreview"><div class="kympg-quickPreviewTitle">${escapeHtml(title)}</div>${rows || '<div class="kympg-quickPreviewLine">NO LINES</div>'}${more}</div>`;
      };
      const orderPreviewHtml = (o) => renderLinePreview(o.items || [], 'ORDER LINES PREVIEW');
      const quotePreviewHtml = (x) => renderLinePreview(x.items || [], 'QUOTE LINES PREVIEW');

      const html = [];
      orderHits.forEach(o => {
        const date = o.createdAt ? new Date(o.createdAt).toLocaleDateString() : '';
        const brief = briefOrderDescription(o);
        html.push(`<div class="kympg-quickItem" onclick="openQuickSearchResult('order','${o.id}')"><strong>Order ${escapeHtml(o.orderNumber || '')}</strong><div class="kympg-quickMeta">Date: ${escapeHtml(date)} • ${escapeHtml(brief)} • Customer: ${escapeHtml(o.customer?.name || '')}</div>${orderPreviewHtml(o)}</div>`);
      });
      quoteHits.forEach(x => {
        const date = x.createdAt ? new Date(x.createdAt).toLocaleDateString() : '';
        html.push(`<div class="kympg-quickItem" onclick="openQuickSearchResult('quote','${x.id}')"><strong>Quote ${escapeHtml(x.quoteNumber || '')}</strong><div class="kympg-quickMeta">Date: ${escapeHtml(date)} • Customer: ${escapeHtml(x.customer?.name || x.customerName || '')} • Phone: ${escapeHtml(x.customer?.phone || x.customerPhone || '')}</div>${quotePreviewHtml(x)}</div>`);
      });
      poHits.forEach(p => {
        const date = p.dateOrdered ? new Date(p.dateOrdered).toLocaleDateString() : '';
        html.push(`<div class="kympg-quickItem" onclick="openQuickSearchResult('po','${p.id}')"><strong>PO ${escapeHtml(p.poNumber || '')}</strong><div class="kympg-quickMeta">Date: ${escapeHtml(date)} • Order: ${escapeHtml(p.orderNumber || '')} • Vendor: ${escapeHtml(p.vendor || '')}</div></div>`);
      });

      resultsEl.innerHTML = html.length ? html.join('') : '<div class="kympg-quickMeta" style="padding:8px 4px;">No matching orders, quotes, or POs found.</div>';
    } catch (err) {
      resultsEl.innerHTML = `<div class="kympg-quickMeta" style="padding:8px 4px;color:#b00020;">Search failed: ${escapeHtml(err.message || 'Unknown error')}</div>`;
    }
  }

  function getActorStamp() {
    return {
      name: getAuthDisplayName(),
      email: authUser?.email || '',
      at: new Date().toISOString(),
    };
  }

  async function logReceivedPO() {
    const input = document.getElementById('homeLogPoInput');
    const statusEl = document.getElementById('homeLogPoStatus');
    if (!input || !statusEl) return;

    const raw = (input.value || '').trim();
    if (!raw) {
      statusEl.textContent = 'Enter a PO # to log as received.';
      return;
    }

    const normalize = (v) => String(v || '').replace(/\s+/g, '').toUpperCase();
    const target = normalize(raw);
    statusEl.textContent = 'Searching PO…';

    try {
      const listRes = await fetchApi('/api/purchase-orders');
      if (!listRes.ok) throw new Error('Could not load purchase orders');
      const pos = await listRes.json();

      const po = (pos || []).find(p => normalize(p.poNumber) === target);
      if (!po) {
        statusEl.textContent = `PO ${raw} not found.`;
        return;
      }

      const today = new Date().toISOString().slice(0, 10);
      const nextStatus = String(po.poType || 'external').toLowerCase() === 'internal'
        ? 'Completed by Shop'
        : 'Received';

      const actor = getActorStamp();
      const updateBody = {
        status: nextStatus,
        receivedAt: today,
      };
      if (nextStatus.toLowerCase().includes('completed')) updateBody.completedBy = actor;
      if (nextStatus.toLowerCase().includes('received')) updateBody.receivedBy = actor;
      const updateRes = await fetchApi(`/api/purchase-orders?id=${encodeURIComponent(po.id)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updateBody),
      });

      if (!updateRes.ok) {
        const err = await updateRes.json().catch(() => ({}));
        throw new Error(err.error || 'Failed to update PO');
      }

      statusEl.textContent = `Updated ${po.poNumber} as ${nextStatus} on ${today}.`;
      input.value = '';
      try { if (typeof loadPurchaseOrders === 'function') await loadPurchaseOrders(); } catch (e) {}
      try { if (typeof loadOrders === 'function') await loadOrders(); } catch (e) {}
    } catch (err) {
      statusEl.textContent = `Error: ${err.message}`;
    }
  }

  async function openQuickSearchResult(type, id) {
    if (type === 'order') {
      try { await loadOrderIntoCalculator(id); } catch (e) {}
      return;
    }

    if (type === 'quote') {
      try {
        const res = await fetchApi(`/api/quotes?id=${encodeURIComponent(id)}`);
        if (!res.ok) throw new Error('Quote not found');
        const quote = await res.json();
        kympgOpen('quote');
        populateCalculatorFromOrder({ ...quote, id, orderNumber: quote.quoteNumber || id }, 'quote');
      } catch (err) {
        alert('Could not open quote: ' + err.message);
      }
      return;
    }

    if (type === 'po') {
      try {
        const res = await fetchApi(`/api/purchase-orders?id=${encodeURIComponent(id)}`);
        if (!res.ok) throw new Error('PO not found');
        const po = await res.json();
        if (po.orderId) {
          await loadOrderIntoCalculator(po.orderId);
          return;
        }
      } catch (err) {
        alert('Could not open PO: ' + err.message);
      }
      kympgOpen('po');
    }
  }

  async function loadPurchaseOrders() {
    const tbody = document.getElementById('poTableBody');
    if (!tbody) return;
    try {
      const res = await fetchApi('/api/purchase-orders');
      if (!res.ok) throw new Error('Failed to load Purchase Orders');
      const data = await res.json();

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No purchase orders found.</td></tr>';
        return;
      }

      const getPoStatusFromDates = (po = {}) => {
        const hasReceived = !!String(po.receivedAt || '').trim();
        const hasEstimatedDelivery = !!String(po.deliveryDate || '').trim();
        if (hasReceived) return 'Received';
        if (hasEstimatedDelivery) return 'In Progress';
        return po.status || 'Pending';
      };
      const statusWithActor = (po = {}) => {
        const status = getPoStatusFromDates(po);
        const actor = status.toLowerCase().includes('received') ? po.receivedBy : po.completedBy;
        if (!actor) return status;
        const actorName = actor.name || actor.email || '';
        return actorName ? `${status} (${actorName})` : status;
      };

      tbody.innerHTML = data.map(po => `
        <tr>
          <td>${po.orderNumber || ''}</td>
          <td>${escapeHtml(po.vendor || '')}</td>
          <td>${po.poNumber || ''}</td>
          <td>${(po.requestedDate || '').slice(0, 10)}</td>
          <td><input type="date" id="po_delivery_${po.id}" value="${(po.deliveryDate || '').slice(0, 10)}"></td>
          <td>${escapeHtml(statusWithActor(po))}</td>
          <td><input type="date" id="po_received_${po.id}" value="${(po.receivedAt || '').slice(0, 10)}"></td>
          <td><button type="button" onclick="editPurchaseOrder('${po.id}')">Open</button> <button type="button" onclick="updatePurchaseOrder('${po.id}')">Save</button></td>
        </tr>
      `).join('');
    } catch (err) {
      console.error(err);
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:red;">Error loading purchase orders.</td></tr>';
    }
  }

  async function updatePurchaseOrder(id) {
    if (!userCanArea('po')) return alert('Your role cannot update purchase orders.');
    const deliveryDate = document.getElementById(`po_delivery_${id}`)?.value || '';
    const receivedAt = document.getElementById(`po_received_${id}`)?.value || '';
    const status = receivedAt ? 'Received' : (deliveryDate ? 'In Progress' : 'Pending');
    const actor = getActorStamp();

    const payload = { deliveryDate, status, receivedAt };
    if (status === 'Received') payload.receivedBy = actor;

    const res = await fetchApi(`/api/purchase-orders?id=${encodeURIComponent(id)}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    if (!res.ok) {
      alert('Failed to update purchase order.');
      return;
    }

    await loadPurchaseOrders();
    try { if (typeof loadOrders === 'function') await loadOrders(); } catch (e) {}
  }

  let pendingResidentialPayload = null;

  function kympgToggleGroup(groupName) {
    const group = document.getElementById(`group-${groupName}`);
    const marker = document.getElementById(`toggle-${groupName}`);
    if (!group || !marker) return;
    group.classList.toggle('collapsed');
    marker.textContent = group.classList.contains('collapsed') ? '+' : '−';
  }

  async function loadServiceTechs() {
    const tbody = document.getElementById('serviceTechTableBody');
    if (!tbody) return [];
    const res = await fetchApi('/api/service-techs');
    const techs = res.ok ? await res.json() : [];
    tbody.innerHTML = (techs || []).map(t => `<tr><td>${escapeHtml(t.name || '')}</td><td>${escapeHtml(t.phone || '')}</td><td>${escapeHtml(t.email || '')}</td><td><button type="button" onclick="deleteServiceTech('${t.id}')">Delete</button></td></tr>`).join('') || '<tr><td colspan="4" style="text-align:center;">No techs found.</td></tr>';
    return techs || [];
  }

  async function saveServiceTech() {
    const name = (document.getElementById('techName')?.value || '').trim();
    if (!name) return alert('Tech name is required.');
    const phone = (document.getElementById('techPhone')?.value || '').trim();
    const email = (document.getElementById('techEmail')?.value || '').trim();
    const res = await fetchApi('/api/service-techs', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, phone, email })});
    if (!res.ok) return alert('Failed to save service tech.');
    document.getElementById('techName').value = '';
    document.getElementById('techPhone').value = '';
    document.getElementById('techEmail').value = '';
    await loadServiceTechs();
  }

  async function deleteServiceTech(id) {
    if (!confirm('Delete this service tech?')) return;
    await fetchApi(`/api/service-techs?id=${encodeURIComponent(id)}`, { method: 'DELETE' });
    await loadServiceTechs();
  }

  let selectedResidentialCustomer = null;
  let residentialLookupIndex = -1;

  function setupResidentialCustomerLookup() {
    const nameInput = document.getElementById('resCustomerName');
    const lookupList = document.getElementById('resCustomerLookupList');
    if (!nameInput || !lookupList) return;

    nameInput.addEventListener('input', () => {
      selectedResidentialCustomer = null;
      buildResidentialLookupList();
    });

    nameInput.addEventListener('focus', () => {
      if (nameInput.value.trim()) buildResidentialLookupList();
    });

    nameInput.addEventListener('keydown', (e) => {
      const items = lookupList.querySelectorAll('li');
      if (e.key === 'ArrowDown' && items.length) {
        e.preventDefault();
        residentialLookupIndex = (residentialLookupIndex + 1) % items.length;
        highlightResidentialLookup(items);
      } else if (e.key === 'ArrowUp' && items.length) {
        e.preventDefault();
        residentialLookupIndex = (residentialLookupIndex - 1 + items.length) % items.length;
        highlightResidentialLookup(items);
      } else if (e.key === 'Enter' && lookupList.style.display === 'block' && items.length) {
        e.preventDefault();
        const idx = residentialLookupIndex >= 0 ? residentialLookupIndex : 0;
        items[idx].dispatchEvent(new Event('mousedown'));
      } else if (e.key === 'Escape') {
        lookupList.style.display = 'none';
        residentialLookupIndex = -1;
      }
    });

    document.addEventListener('click', (e) => {
      if (!nameInput.contains(e.target) && !lookupList.contains(e.target)) {
        lookupList.style.display = 'none';
        residentialLookupIndex = -1;
      }
    });
  }

  function buildResidentialLookupList() {
    const nameInput = document.getElementById('resCustomerName');
    const lookupList = document.getElementById('resCustomerLookupList');
    if (!nameInput || !lookupList) return;
    const search = nameInput.value.toLowerCase().trim();
    lookupList.innerHTML = '';
    residentialLookupIndex = -1;
    if (!search) {
      lookupList.style.display = 'none';
      return;
    }

    const matches = calcCustomers.filter(c => (c.name || '').toLowerCase().includes(search));
    matches.forEach(c => {
      const li = document.createElement('li');
      li.innerHTML = `${escapeHtml(c.name || '')}<span class="cust-detail">${escapeHtml(c.phone || '')}${c.address ? ' — ' + escapeHtml(c.address) : ''}</span>`;
      li.addEventListener('mousedown', (e) => {
        e.preventDefault();
        selectResidentialCustomer(c);
      });
      lookupList.appendChild(li);
    });

    lookupList.style.display = matches.length ? 'block' : 'none';
  }

  function highlightResidentialLookup(items) {
    items.forEach((li, idx) => li.classList.toggle('active', idx === residentialLookupIndex));
    if (residentialLookupIndex >= 0 && items[residentialLookupIndex]) {
      items[residentialLookupIndex].scrollIntoView({ block: 'nearest' });
    }
  }

  function selectResidentialCustomer(customer) {
    selectedResidentialCustomer = customer;
    document.getElementById('resCustomerName').value = customer.name || '';
    document.getElementById('resCustomerPhone').value = customer.phone || '';
    document.getElementById('resCustomerAddress').value = customer.address || '';
    document.getElementById('resCustomerEmail').value = customer.email || '';
    document.getElementById('resCustomerCreditTerms').value = customer.creditTerms || '';
    const lookupList = document.getElementById('resCustomerLookupList');
    if (lookupList) lookupList.style.display = 'none';
    residentialLookupIndex = -1;
  }

  function clearResidentialCustomerInfo() {
    selectedResidentialCustomer = null;
    ['resCustomerName','resCustomerPhone','resCustomerAddress','resCustomerEmail','resCustomerCreditTerms'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    const lookupList = document.getElementById('resCustomerLookupList');
    if (lookupList) lookupList.style.display = 'none';
  }

  async function loadTechHomeRequests() {
    const tbody = document.getElementById('techHomeRequestsBody');
    if (!tbody) return;
    const res = await fetchApi('/api/residential-requests');
    if (!res.ok) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#b91c1c;">Failed to load requests.</td></tr>';
      return;
    }
    let rows = await res.json();
    rows = (rows || []).filter((r) => String(r.status || 'open').toLowerCase() === 'open');

    if (isFieldTechUser()) {
      const myEmail = String(authUser?.email || '').toLowerCase();
      const myName = String(getAuthDisplayName() || '').toLowerCase();
      rows = rows.filter((r) => {
        const assignedEmail = String(r.assignedTechEmail || '').toLowerCase();
        const assignedName = String(r.assignedTech || '').toLowerCase();
        return !assignedEmail || assignedEmail === myEmail || (assignedName && assignedName === myName);
      });
    }

    const detectWorkType = (r) => {
      const text = String(r.measureCategory || r.description || '').toLowerCase();
      if (text.includes('shower')) return 'Shower';
      if (text.includes('mirror')) return 'Mirror';
      if (text.includes('shel')) return 'Shelving';
      return r.measureCategory || r.description || '';
    };

    tbody.innerHTML = rows.map((r) => `
      <tr>
        <td>${escapeHtml(r.requestNumber || '')}</td>
        <td>${escapeHtml(String((r.createdAt || '')).slice(0,10))}</td>
        <td>${escapeHtml(r.customer?.name || '')}</td>
        <td>${escapeHtml(r.customer?.address || '')}</td>
        <td>${escapeHtml(r.customer?.phone || '')}</td>
        <td>${escapeHtml(detectWorkType(r))}</td>
        <td><button type="button" onclick="openMeasureModal('${r.id}')">Measure</button></td>
      </tr>
    `).join('') || '<tr><td colspan="7" style="text-align:center;">No open requests found.</td></tr>';
  }

  async function openMeasureModal(id) {
    const res = await fetchApi(`/api/residential-requests?id=${encodeURIComponent(id)}`);
    if (!res.ok) return alert('Could not load request details.');
    const r = await res.json();
    currentMeasureRequest = r;
    document.getElementById('measureRequestNumber').value = r.requestNumber || '';
    document.getElementById('measureRequestDate').value = String(r.createdAt || '').slice(0,10);
    document.getElementById('measureCustomerName').value = r.customer?.name || '';
    document.getElementById('measureCustomerPhone').value = r.customer?.phone || '';
    document.getElementById('measureCustomerAddress').value = r.customer?.address || '';
    document.getElementById('measureDescription').value = r.description || '';
    document.getElementById('measureCategory').value = r.measureCategory || '';
    document.getElementById('measureNotes').value = r.measureNotes || '';
    document.getElementById('measureStatus').textContent = '';
    const modal = document.getElementById('measureModal');
    if (modal) modal.style.display = 'flex';
  }

  function closeMeasureModal() {
    const modal = document.getElementById('measureModal');
    if (modal) modal.style.display = 'none';
  }

  async function saveMeasureSelection() {
    if (!currentMeasureRequest?.id) return;
    const measureCategory = (document.getElementById('measureCategory')?.value || '').trim();
    const measureNotes = (document.getElementById('measureNotes')?.value || '').trim();
    const statusEl = document.getElementById('measureStatus');
    if (!measureCategory) {
      if (statusEl) statusEl.textContent = 'Please pick shower door, mirror, or shelving.';
      return;
    }

    const payload = { ...currentMeasureRequest, measureCategory, measureNotes, measuredAt: new Date().toISOString(), measuredBy: getAuthDisplayName() };
    const res = await fetchApi(`/api/residential-requests?id=${encodeURIComponent(currentMeasureRequest.id)}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    if (!res.ok) {
      if (statusEl) statusEl.textContent = 'Failed to save measure details.';
      return;
    }
    if (statusEl) statusEl.textContent = 'Saved.';
    await loadTechHomeRequests();
  }

  async function saveResidentialRequest() {
    pendingResidentialPayload = {
      customer: {
        name: (document.getElementById('resCustomerName')?.value || '').trim(),
        phone: (document.getElementById('resCustomerPhone')?.value || '').trim(),
        address: (document.getElementById('resCustomerAddress')?.value || '').trim(),
        email: (document.getElementById('resCustomerEmail')?.value || '').trim(),
        creditTerms: (document.getElementById('resCustomerCreditTerms')?.value || '').trim(),
      },
      description: (document.getElementById('resDescription')?.value || '').trim(),
    };
    if (!pendingResidentialPayload.customer.name) return alert('Customer name is required.');
    const techs = await loadServiceTechs();
    if (!techs.length) return alert('Please add service techs first.');
    const sel = document.getElementById('assignTechSelect');
    sel.innerHTML = techs.map(t => `<option value="${escapeHtml(t.id || '')}">${escapeHtml(t.name || '')}${t.email ? ` (${escapeHtml(t.email)})` : ''}</option>`).join('');
    document.getElementById('assignTechModal').style.display = 'flex';
  }

  function closeAssignTechModal() {
    const modal = document.getElementById('assignTechModal');
    if (modal) modal.style.display = 'none';
  }

  async function confirmSaveResidentialRequest() {
    if (!pendingResidentialPayload) return;
    const techSelect = document.getElementById('assignTechSelect');
    const techId = techSelect?.value || '';
    const techOption = techSelect?.options?.[techSelect.selectedIndex];
    const techLabel = (techOption?.textContent || '').trim();
    const techName = techLabel.replace(/\s*\([^)]*\)\s*$/, '');
    const payload = { ...pendingResidentialPayload, assignedTech: techName, assignedTechId: techId, status: 'open' };
    const isEdit = !!payload.id;
    const url = isEdit ? `/api/residential-requests?id=${encodeURIComponent(payload.id)}` : '/api/residential-requests';
    const method = isEdit ? 'PUT' : 'POST';
    const res = await fetchApi(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if (!res.ok) return alert('Failed to save residential request.');
    closeAssignTechModal();
    pendingResidentialPayload = null;
    ['resCustomerName','resCustomerPhone','resCustomerAddress','resCustomerEmail','resCustomerCreditTerms','resDescription'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
    const status = document.getElementById('residentialSaveStatus');
    if (status) status.textContent = 'Request saved.';
    await loadResidentialRequests();
  }

  async function loadResidentialRequests() {
    const tbody = document.getElementById('residentialTableBody');
    if (!tbody) return;
    const res = await fetchApi('/api/residential-requests');
    if (!res.ok) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:red;">Failed to load requests.</td></tr>'; return; }
    let rows = await res.json();
    if (authRoles.includes('field')) {
      const myEmail = String(authUser?.email || '').toLowerCase();
      const myName = String(getAuthDisplayName() || '').toLowerCase();
      rows = (rows || []).filter((r) => {
        const assignedEmail = String(r.assignedTechEmail || '').toLowerCase();
        const assignedName = String(r.assignedTech || '').toLowerCase();
        return !assignedEmail || assignedEmail === myEmail || (assignedName && assignedName === myName);
      });
    }
    tbody.innerHTML = (rows || []).map(r => `<tr><td>${escapeHtml(r.requestNumber || '')}</td><td>${escapeHtml(r.customer?.name || '')}</td><td>${escapeHtml(r.customer?.phone || '')}</td><td>${escapeHtml(r.assignedTech || '')}</td><td>${escapeHtml((r.createdAt || '').slice(0,10))}</td><td><button type="button" onclick="editResidentialRequest('${r.id}')">Edit</button></td></tr>`).join('') || '<tr><td colspan="6" style="text-align:center;">No requests found.</td></tr>';
  }

  async function editResidentialRequest(id) {
    const res = await fetchApi(`/api/residential-requests?id=${encodeURIComponent(id)}`);
    if (!res.ok) return alert('Request not found.');
    const r = await res.json();
    kympgOpen('residential');
    document.getElementById('resCustomerName').value = r.customer?.name || '';
    document.getElementById('resCustomerPhone').value = r.customer?.phone || '';
    document.getElementById('resCustomerAddress').value = r.customer?.address || '';
    document.getElementById('resCustomerEmail').value = r.customer?.email || '';
    document.getElementById('resCustomerCreditTerms').value = r.customer?.creditTerms || '';
    document.getElementById('resDescription').value = r.description || '';
    pendingResidentialPayload = { ...r, customer: r.customer || {} };
    pendingResidentialPayload.id = id;
  }

  function kympgOpen(which, btn){
    if (!authUser) {
      alert('Please log in to continue.');
      return;
    }
    if (!userCanArea(which)) {
      alert('Your role does not have access to this area.');
      return;
    }
    if (btn){
      kympgClearActiveNav();
      btn.classList.add('active');
    }
    kympgHideAllSections();

    if (which === 'quote'){
      const calc = document.getElementById('calculator-section');
      if (calc){ calc.style.display = 'block'; }
      kympgSetHeader('New Quote', 'Create and print a quote.', 'New Quote', 'Quote builder');
      setCalculatorMode('quote');
      return;
    }
    if (which === 'order'){
      const calc = document.getElementById('calculator-section');
      if (calc){ calc.style.display = 'block'; }
      kympgSetHeader('New Order', 'Create an order and print ticket/invoice.', 'New Order', 'Order form');
      setCalculatorMode('order');
      try{ if (typeof startNewOrder === 'function') startNewOrder(); }catch(e){}
      return;
    }
    if (which === 'orders'){
      const ord = document.getElementById('orders-section');
      if (ord){ ord.style.display = 'block'; }
      kympgSetHeader('Search / Open Orders', 'Find and open past orders.', 'Orders', 'Search and open orders');
      try{ if (typeof loadOrders === 'function') loadOrders(); }catch(e){}
      return;
    }
    if (which === 'quotedb'){
      const q = document.getElementById('quotedb-section');
      if (q){ q.style.display = 'block'; }
      kympgSetHeader('Open Quotes', 'Search and open saved quotes.', 'Quotes', 'Quotes database');
      try{ if (typeof loadQuotes === 'function') loadQuotes(); }catch(e){}
      return;
    }
    if (which === 'po') {
      const p = document.getElementById('po-section');
      if (p){ p.style.display = 'block'; }
      kympgSetHeader('Purchase Orders', 'Track vendor purchase orders.', 'Purchase Orders', 'Vendor POs');
      loadPurchaseOrders();
      return;
    }
    if (which === 'invoiced'){
      const inv = document.getElementById('invoiced-section');
      if (inv){ inv.style.display = 'block'; }
      kympgSetHeader('Invoiced Orders', 'View closed / invoiced orders.', 'Invoiced', 'Invoices database');
      try{ if (typeof loadInvoicedOrders === 'function') loadInvoicedOrders(); }catch(e){}
      return;
    }
    if (which === 'breakage'){
      const b = document.getElementById('breakage-section');
      if (b){ b.style.display = 'block'; }
      kympgSetHeader('Breakage Pricing', 'Open the breakage calculator inside the app.', 'Breakage Pricing', 'Tool');
      return;
    }
    if (which === 'pricelist'){
      const p = document.getElementById('pricelist-section');
      if (p){ p.style.display = 'block'; }
      kympgSetHeader('Sq Ft Price List', 'Reference pricing inside the app.', 'Sq Ft Price List', 'Tool');
      return;
    }
    if (which === 'customerimport'){
      const c = document.getElementById('customer-section');
      if (c){ c.style.display = 'block'; }
kympgSetHeader('Customer Database', '', 'Customer Import', '');
      try{ if (typeof loadCustomers === 'function') loadCustomers(); }catch(e){}
      return;
    }
    if (which === 'vendors'){
      const v = document.getElementById('vendor-section');
      if (v){ v.style.display = 'block'; }
      kympgSetHeader('Vendor Database', '', 'Vendor Import', '');
      try{ if (typeof loadVendors === 'function') loadVendors(); }catch(e){}
      return;
    }
    if (which === 'residential'){
      const r = document.getElementById('residential-section');
      if (r){ r.style.display = 'block'; }
      kympgSetHeader('New Residential Request', 'Create and assign residential service request.', 'Residential', 'New Request');
      return;
    }
    if (which === 'residentialdb'){
      const r = document.getElementById('residentialdb-section');
      if (r){ r.style.display = 'block'; }
      kympgSetHeader('Open Residential Requests', 'Search and edit saved requests.', 'Residential', 'Open Requests');
      try { if (typeof loadResidentialRequests === 'function') loadResidentialRequests(); } catch(e) {}
      return;
    }
    if (which === 'servicetechs'){
      const t = document.getElementById('servicetechs-section');
      if (t){ t.style.display = 'block'; }
      kympgSetHeader('Service Tech Database', 'Manage assignable service technicians.', 'Residential', 'Service Techs');
      try { if (typeof loadServiceTechs === 'function') loadServiceTechs(); } catch(e) {}
      return;
    }
    setCalculatorMode('quote');
    kympgShowLanding();
  }

  window.addEventListener('DOMContentLoaded', async () => {
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on('init', syncAuthState);
      window.netlifyIdentity.on('login', async (user) => {
        window.netlifyIdentity.close();
        await syncAuthState(user);
      });
      window.netlifyIdentity.on('logout', async () => {
        await syncAuthState(null);
      });
      window.netlifyIdentity.init();
    } else {
      console.warn('Netlify Identity widget unavailable.');
    }

    // Ensure app workspaces live inside the card body so navigation renders correctly.
    const content = document.getElementById('kympgContentArea');
    if (content){
      ['calculator-section','customer-section','vendor-section','orders-section','shower-section','invoiced-section','quotedb-section','po-section','breakage-section','pricelist-section','residential-section','residentialdb-section','servicetechs-section']
        .forEach(id => {
          const el = document.getElementById(id);
          if (el && el.parentElement !== content) content.appendChild(el);
          if (el) el.style.display = 'none';
        });
    }
    kympgShowLanding();
    try { if (typeof setupResidentialCustomerLookup === 'function') setupResidentialCustomerLookup(); } catch(e) {}

    const quickInput = document.getElementById('homeQuickSearchInput');
    const closeOpenSearchUi = () => {
      const quickResults = document.getElementById('homeQuickResults');
      if (quickResults && quickResults.innerHTML.trim()) {
        quickResults.innerHTML = '';
      }

      document.querySelectorAll('.glassList').forEach((list) => {
        if (list.style.display === 'block') {
          list.style.display = 'none';
        }
      });

      const customerLookup = document.getElementById('customerLookupList');
      if (customerLookup && customerLookup.style.display === 'block') {
        customerLookup.style.display = 'none';
        calcLookupIndex = -1;
      }

      const residentialLookup = document.getElementById('resCustomerLookupList');
      if (residentialLookup && residentialLookup.style.display === 'block') {
        residentialLookup.style.display = 'none';
        residentialLookupIndex = -1;
      }
    };

    document.addEventListener('keydown', (e) => {
      if (e.key !== 'Escape') return;
      closeOpenSearchUi();
    });

    if (quickInput) {
      quickInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          runHomeQuickSearch();
          return;
        }
        if (e.key === 'Escape') {
          e.preventDefault();
          quickInput.blur();
          const resultsEl = document.getElementById('homeQuickResults');
          if (resultsEl) resultsEl.innerHTML = '';
        }
      });
    }

    const logPoInput = document.getElementById('homeLogPoInput');
    if (logPoInput) {
      logPoInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          logReceivedPO();
        }
      });
    }



    if (window.netlifyIdentity && typeof window.netlifyIdentity.currentUser === 'function') {
      await syncAuthState(window.netlifyIdentity.currentUser());
    }
  });
</script>


<div id="measureModal" class="measure-modal" onclick="closeMeasureModal()">
  <div class="measure-card" onclick="event.stopPropagation()">
    <h3>Measure Request</h3>
    <div class="measure-grid">
      <div><label>Request #</label><input id="measureRequestNumber" type="text" readonly></div>
      <div><label>Date</label><input id="measureRequestDate" type="text" readonly></div>
      <div><label>Customer</label><input id="measureCustomerName" type="text" readonly></div>
      <div><label>Phone</label><input id="measureCustomerPhone" type="text" readonly></div>
      <div class="full"><label>Address</label><input id="measureCustomerAddress" type="text" readonly></div>
      <div class="full"><label>Description</label><textarea id="measureDescription" rows="3" readonly></textarea></div>
      <div class="full"><label>Pick Type</label>
        <select id="measureCategory">
          <option value="">Select one...</option>
          <option value="shower door">Shower Door</option>
          <option value="mirror">Mirror</option>
          <option value="shelving">Shelving</option>
        </select>
      </div>
      <div class="full"><label>Measure Notes</label><textarea id="measureNotes" rows="3" placeholder="Optional notes..."></textarea></div>
    </div>
    <div class="measure-actions">
      <button type="button" class="kympg-authBtn secondary" onclick="closeMeasureModal()">Close</button>
      <button type="button" class="kympg-authBtn primary" onclick="saveMeasureSelection()">Save</button>
    </div>
    <div id="measureStatus" class="kympg-logPOStatus"></div>
  </div>
</div>

</body>
</html>
